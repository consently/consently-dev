!function(){"use strict";const e="localhost"!==window.location.hostname&&!window.location.hostname.includes("127.0.0.1"),n=console.log;console.info,console.debug;e&&(console.log=function(){},console.info=function(){},console.debug=function(){});const o=document.currentScript||document.querySelector("script[data-dpdpa-widget-id]"),i=o?o.getAttribute("data-dpdpa-widget-id"):null;if(!i)return console.error("[Consently DPDPA] Error: data-dpdpa-widget-id attribute is required"),void console.error('[Consently DPDPA] Usage: <script src="https://www.consently.in/dpdpa-widget.js" data-dpdpa-widget-id="YOUR_WIDGET_ID"><\/script>');e||n("[Consently DPDPA] Initializing widget with ID:",i);const r={consentManager:"Consent Manager",compliantWith:"Fully compliant with Digital Personal Data Protection Act, 2023",requirementsTitle:"DPDPA 2023 requires you to read the privacy notice",scrollInstruction:"Scroll down to read the privacy notice",downloadButton:"Download Privacy Notice",proceedButton:"Proceed to Consent",warningMessage:"Please complete both requirements to proceed",processingActivities:"Processing Activities",processingDescription:"We process your personal data for the following purposes. You can accept or reject each activity individually.",acceptButton:"Accept",rejectButton:"Reject",acceptAll:"Accept All",rejectAll:"Reject All",acceptSelected:"Accept selected",cancel:"Cancel",close:"Close",dataAttributes:"Data Attributes",dataCategories:"Data Categories",purpose:"Purpose",retentionPeriod:"Retention Period",yourDataRights:"Your Data Rights",dataRightsText:"Under DPDPA 2023, you have the right to access, correct, and delete your personal data. You can also withdraw your consent at any time.",withdrawConsent:"Withdraw/Modify Consent",raiseGrievance:"Raise Grievance",privacyNotice:"Notice",dpdpaCompliance:"DPDPA 2023 Compliance",manageConsentPreferences:"Manage Your Consent Preferences",changeSettingsAnytime:"You can change these settings at any time",preferenceCentre:"Preference Centre",revocationWarning:"‚ö†Ô∏è Warning: Revoking consent may affect service delivery.",grievanceText:"If you have any grievances with how we process your personal data click {here}. If we are unable to resolve your grievance, you can also make a complaint to the Data Protection Board by clicking {here2}.",here:"here",poweredBy:"Powered by",ageVerificationRequired:"Age Verification Required",selectBirthYear:"Select your year of birth",continueButton:"Continue",ageGateDescription:"To provide you with an appropriate experience, we need to verify your age.",ageGateDefaultMinorMessage:"This content requires adult supervision. Please ask a parent or guardian to assist you.",digilockerVerification:"DigiLocker Age Verification",digilockerDescription:"Verify your age securely using your government-issued ID via DigiLocker.",verifyWithDigilocker:"Verify with DigiLocker",verifying:"Verifying...",ageVerified:"Age Verified",ageVerifiedMessage:"Your age has been verified successfully.",verificationFailed:"Verification Failed",verificationFailedMessage:"Age verification failed. Please try again.",verificationPending:"Verification Pending",verificationPendingMessage:"Please complete verification in the DigiLocker window.",guardianConsentRequired:"Guardian Consent Required",guardianConsentMessage:"You are under the required age. A parent or guardian must verify their identity and approve your consent.",requestGuardianConsent:"Request Guardian Consent",guardianEmail:"Guardian Email",guardianEmailPlaceholder:"Enter guardian email address",sendConsentRequest:"Send Consent Request",consentRequestSent:"Consent request sent to guardian",waitingForGuardian:"Waiting for guardian approval...",guardianApproved:"Guardian consent approved",guardianRejected:"Guardian consent was denied",retryVerification:"Retry Verification"},a={};function s(){const e=o?o.src:"";if(e.includes("localhost"))return"http://localhost:3000";if(e.includes("consently.in"))return"https://www.consently.in";const t=e.match(/^(https?:\/\/[^\/]+)/);return t?t[1]:window.location.origin}async function l(e,t){if("en"===t||!e||0===e.length)return e||[];const n=[],o=[],i=[...e];if(e.forEach((e,r)=>{if(!e)return void(i[r]=e);const s=`${t}:${e}`;a[s]?i[r]=a[s]:(n.push(e),o.push(r))}),0===n.length)return i;try{const r=s(),l=await fetch(`${r}/api/translate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({texts:n,target:t,source:"en"})});if(l.ok){const r=await l.json();r.success&&r.translations&&Array.isArray(r.translations)?o.forEach((o,s)=>{const l=r.translations[s]||n[s]||e[o];i[o]=l;const c=`${t}:${e[o]}`;a[c]=l}):(console.warn("[Consently DPDPA] Unexpected API response format, using fallback"),o.forEach((t,o)=>{i[t]=n[o]||e[t]}))}else console.warn("[Consently DPDPA] Translation API error:",l.status),o.forEach((t,o)=>{i[t]=n[o]||e[t]})}catch(t){console.error("[Consently DPDPA] Batch translation error:",t),o.forEach((t,o)=>{i[t]=n[o]||e[t]})}return i}async function c(e){if("en"===e)return r;const t=`_lang_${e}`;if(a[t])return a[t];const n=Object.keys(r),o=Object.values(r),i=await l(o,e),s={};return n.forEach((e,t)=>{s[e]=i[t]}),a[t]=s,s}let d=null,p=[],u=[],g={},y=null,f=null,h=null,m=null,x=!1,v=null,b="#4c8bf5",w=null,P=null,D=null,C=null,A=null;const k={set:function(e,t,n){const o=new Date;o.setDate(o.getDate()+n);const i={value:t,expiresAt:o.toISOString()};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return null;try{const n=JSON.parse(t);return new Date(n.expiresAt)<new Date?(this.delete(e),null):n.value}catch(e){return null}},delete:function(e){localStorage.removeItem(e)}};function S(){return`consently_minor_flag_${i}`}function $(){try{const e=S(),t=365;k.set(e,!0,t);const n=new Date;n.setDate(n.getDate()+t),document.cookie=`${e}=true; expires=${n.toUTCString()}; path=/; SameSite=Lax`,console.log("[Consently DPDPA] Minor flag cookie set for",t,"days")}catch(e){console.error("[Consently DPDPA] Error setting minor cookie:",e)}}function _(e){return(new Date).getFullYear()-parseInt(e,10)}function E(){try{const e=`consently_age_verified_${i}`,t=k.get(e);return!(!t||!t.verified)&&(P="verified",!0)}catch(e){return console.error("[Consently DPDPA] Error checking age verification:",e),!1}}function I(e=365){try{const t=`consently_age_verified_${i}`;k.set(t,{verified:!0,verifiedAt:(new Date).toISOString()},e)}catch(e){console.error("[Consently DPDPA] Error storing age verification:",e)}}async function T(e){try{const t=s(),n=y||N(),o=await fetch(`${t}/api/dpdpa/age-verification`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({widgetId:i,visitorId:n,returnUrl:e||window.location.href})});if(!o.ok){const e=await o.json();throw new Error(e.error||"Failed to initiate verification")}const r=await o.json();return w=r.sessionId,P="pending",sessionStorage.setItem("consently_age_session",r.sessionId),r.mockMode&&console.log("[Consently DPDPA] Mock mode - redirecting to:",r.redirectUrl),function(){try{const e=`consently_widget_state_${i}`,t={activityConsents:g,userEmail:h,verifiedEmail:f,consentID:y,savedAt:Date.now()};sessionStorage.setItem(e,JSON.stringify(t)),console.log("[Consently DPDPA] Widget state saved before redirect")}catch(e){console.error("[Consently DPDPA] Error saving widget state:",e)}}(),window.location.href=r.redirectUrl,r}catch(e){throw console.error("[Consently DPDPA] Error initiating age verification:",e),P="failed",e}}async function j(e){try{const t=s(),n=await fetch(`${t}/api/dpdpa/age-verification?sessionId=${e}`);if(!n.ok)throw new Error("Failed to check verification status");const o=await n.json();if(o.verificationOutcome&&(A=o.verificationOutcome),o.verified){switch(A){case"verified_adult":case"guardian_approved":case"limited_access":P="verified";break;case"blocked_minor":P="rejected";break;case"guardian_required":P="requires_guardian",D=o.guardianConsentStatus||"pending";break;default:P="verified",o.isMinor&&o.requiresGuardianConsent&&("approved"===o.guardianConsentStatus?P="verified":"rejected"===o.guardianConsentStatus?P="rejected":(P="requires_guardian",D=o.guardianConsentStatus||"pending"))}if(A&&["verified_adult","guardian_approved","limited_access"].includes(A)){I(d?.verificationValidityDays||365)}else if(!A&&"verified"===P){I(d?.verificationValidityDays||365)}}else"failed"===o.status&&(P="failed");return o}catch(e){return console.error("[Consently DPDPA] Error checking verification status:",e),null}}function R(e,t){C&&clearInterval(C),C=setInterval(async()=>{const n=await async function(e){try{const t=s(),n=await fetch(`${t}/api/dpdpa/age-verification/guardian-consent?sessionId=${e}`);if(!n.ok)return null;const o=await n.json();return D=o.status,o}catch(e){return console.error("[Consently DPDPA] Error checking guardian consent:",e),null}}(e);!n||"approved"!==n.status&&"rejected"!==n.status||(clearInterval(C),C=null,"approved"===n.status?(P="verified",A="guardian_approved",I(d?.verificationValidityDays||365)):(P="rejected",A="blocked_minor"),t&&t(n))},5e3)}function L(e,t){const n=e.querySelector("#dpdpa-digilocker-section");if(!n)return;const o=n.querySelector("#dpdpa-digilocker-status"),i=n.querySelector("#dpdpa-digilocker-verify-btn"),r=n.querySelector("#dpdpa-guardian-section");if("verified"===P){if(o){const e=(new Date).toLocaleDateString("en-IN",{day:"numeric",month:"short",year:"numeric"}),n="limited_access"===A,i=n?"#d97706":"#059669",r=n?"#fffbeb":"#ecfdf5",a=n?"#fde68a":"#a7f3d0",s=n?"Limited Access - Age Verified":t.ageVerified,l=n?"You have been verified as a minor. Some features may be restricted.":"Only age eligibility was checked. No personal data was stored.";o.innerHTML=`\n          <div style="background: ${r}; border: 1px solid ${a}; border-radius: 8px; padding: 12px;">\n            <div style="display: flex; align-items: center; gap: 8px; color: ${i};">\n              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>\n                <polyline points="22 4 12 14.01 9 11.01"/>\n              </svg>\n              <span style="font-weight: 700; font-size: 14px;">${s}</span>\n            </div>\n            <p style="margin: 8px 0 0 28px; font-size: 12px; color: #047857;">\n              Verified on ${e} via DigiLocker\n            </p>\n            <p style="margin: 4px 0 0 28px; font-size: 11px; color: #6b7280;">\n              ${l}\n            </p>\n            <p style="margin: 8px 0 0 28px; font-size: 12px; color: #065f46; font-weight: 600;">\n              Please review your preferences below and click Confirm to continue.\n            </p>\n          </div>\n        `}i&&(i.style.display="none"),r&&(r.style.display="none")}else"requires_guardian"===P?(o&&(o.innerHTML=`\n          <div style="display: flex; align-items: center; gap: 8px; color: #d97706;">\n            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n              <circle cx="12" cy="12" r="10"/>\n              <path d="M12 16v-4"/>\n              <path d="M12 8h.01"/>\n            </svg>\n            <span style="font-weight: 600;">${t.guardianConsentRequired}</span>\n          </div>\n          <p style="margin: 4px 0 0 28px; font-size: 12px; color: #6b7280;">${t.guardianConsentMessage}</p>\n        `),i&&(i.style.display="none"),r&&(r.style.display="block")):"rejected"===P||"blocked_minor"===A?(o&&(o.innerHTML=`\n          <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 12px;">\n            <div style="display: flex; align-items: center; gap: 8px; color: #dc2626;">\n              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <circle cx="12" cy="12" r="10"/>\n                <path d="M15 9l-6 6"/>\n                <path d="M9 9l6 6"/>\n              </svg>\n              <span style="font-weight: 700; font-size: 14px;">Access Restricted</span>\n            </div>\n            <p style="margin: 8px 0 0 28px; font-size: 12px; color: #991b1b;">\n              ${d?.minorGuardianMessage||"You must be 18 or older to provide consent. Please ask a parent or guardian to complete verification on your behalf."}\n            </p>\n          </div>\n        `),i&&(i.style.display="none"),r&&(r.style.display="none")):"failed"===P&&(o&&(o.innerHTML=`\n          <div style="display: flex; align-items: center; gap: 8px; color: #dc2626;">\n            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n              <circle cx="12" cy="12" r="10"/>\n              <path d="M15 9l-6 6"/>\n              <path d="M9 9l6 6"/>\n            </svg>\n            <span style="font-weight: 600;">${t.verificationFailed}</span>\n          </div>\n          <p style="margin: 4px 0 0 28px; font-size: 12px; color: #6b7280;">${t.verificationFailedMessage}</p>\n        `),i&&(i.textContent=t.retryVerification,i.style.display="inline-flex"))}function z(e){if(!e)return null;const t=e.toLowerCase().trim();let n=5381,o=0,i=52711,r=0;for(let e=0;e<t.length;e++){const a=t.charCodeAt(e);n=(n<<5)+n+a,o=(o<<5)+o+31*a,i=(i<<5)+i^a,r=(r<<5)+r+17*a}return(Math.abs(n).toString(16).padStart(16,"0")+Math.abs(o).toString(16).padStart(16,"0")+Math.abs(i).toString(16).padStart(16,"0")+Math.abs(r).toString(16).padStart(16,"0")).substring(0,64)}function N(){let e=k.get("consently_consent_id");if(e)return console.log("[Consently DPDPA] Using stored Consent ID:",e),e;const t=function(){const e="ABCDEFGHJKLMNPQRSTUVWXYZ23456789",t=[];for(let n=0;n<3;n++){let n="";for(let t=0;t<4;t++){const t=Math.floor(32*Math.random());n+=e.charAt(t)}t.push(n)}return"CNST-"+t.join("-")}();return k.set("consently_consent_id",t,3650),console.log("[Consently DPDPA] Generated new Consent ID:",t),t}function M(e){if(e)try{k.set("consently_consent_id",e,3650),document.cookie=`consently_id=${e}; max-age=315360000; path=/; SameSite=Lax`,console.log("[Consently DPDPA] Consent ID stored:",e)}catch(e){console.error("[Consently DPDPA] Failed to store Consent ID:",e)}}function q(e,t=!1){if(!("localhost"===window.location.hostname||window.location.hostname.includes("127.0.0.1")||window.location.hostname.includes("consently.in"))&&!t)return void console.warn("[Consently DPDPA]",e);const n=document.createElement("div");n.id="consently-widget-error",n.style.cssText=`\n      position: fixed;\n      bottom: 20px;\n      right: 20px;\n      background: ${t?"#fee2e2":"#fef3c7"};\n      border: 1px solid ${t?"#fca5a5":"#fcd34d"};\n      border-radius: 8px;\n      padding: 12px 16px;\n      max-width: 400px;\n      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n      z-index: 999999;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      font-size: 13px;\n      line-height: 1.5;\n      color: ${t?"#991b1b":"#92400e"};\n    `,n.innerHTML=`\n      <div style="display: flex; align-items: flex-start; gap: 8px;">\n        <span style="font-size: 18px;">${t?"‚ö†Ô∏è":"‚ÑπÔ∏è"}</span>\n        <div style="flex: 1;">\n          <strong style="display: block; margin-bottom: 4px;">Consently Widget ${t?"Error":"Notice"}</strong>\n          <div>${e}</div>\n        </div>\n        <button onclick="this.parentElement.parentElement.remove()" \n                style="background: none; border: none; font-size: 18px; cursor: pointer; color: inherit; opacity: 0.6; padding: 0; line-height: 1;">\n          √ó\n        </button>\n      </div>\n    `,document.body.appendChild(n),t||setTimeout(()=>{n.parentElement&&n.remove()},1e4)}function O(e,t){if(!e||"string"!=typeof e)return console.warn("[Consently DPDPA] Invalid URL provided to matchesUrlPattern"),!1;if(!t||"object"!=typeof t)return console.warn("[Consently DPDPA] Invalid rule provided to matchesUrlPattern"),!1;if(!t.url_pattern)return!0;const n=t.url_pattern,o=t.url_match_type||"contains";if(n.length>500)return console.warn("[Consently DPDPA] URL pattern too long, skipping:",t.id||"unknown"),!1;try{switch(o){case"exact":return e===n;case"contains":return e.includes(n);case"startsWith":return e.startsWith(n);case"regex":try{return new RegExp(n).test(e)}catch(e){return console.error("[Consently DPDPA] Invalid regex pattern in rule:",t.id||"unknown",e),!1}default:return console.warn("[Consently DPDPA] Unknown match type:",o),e.includes(n)}}catch(e){return console.error("[Consently DPDPA] Error matching URL pattern:",e),!1}}function U(e){const t=document.querySelector(e.element_selector);t?t.addEventListener("click",t=>{t.preventDefault(),W(e),Y(e),ee()},{once:!0}):console.warn("[Consently DPDPA] Element not found for click trigger:",e.element_selector)}function B(e){let t=[];if(e.element_selector){const n=document.querySelector(e.element_selector);n?t=[n]:console.warn("[Consently DPDPA] Form not found for submit trigger:",e.element_selector)}else t=Array.from(document.querySelectorAll("form")),console.log("[Consently DPDPA] Auto-detected forms:",t.length);if(0===t.length)return void console.warn("[Consently DPDPA] No forms found on page for submit trigger");new WeakMap;t.forEach(t=>{const n=async o=>{const r=k.get(`consently_dpdpa_consent_${i}`);if(r&&r.timestamp)console.log("[Consently DPDPA] Consent already exists, allowing form submission");else{o.preventDefault(),o.stopPropagation(),console.log("[Consently DPDPA] Form submission intercepted - showing consent widget");let r=null,a="new";if(d.enableSmartPreFill){const e=d.emailFieldSelectors||'input[type="email"], input[name*="email" i]';let n=null;try{n=t.querySelector(e),n||console.log("[Consently DPDPA] No email field found with selectors:",e)}catch(o){console.error("[Consently DPDPA] Invalid email field selector:",e,o),console.log("[Consently DPDPA] Falling back to manual email input")}if(n&&n.value){r=n.value,console.log("[Consently DPDPA] ‚úì Smart Pre-fill: Found email in form:",r);const e=await async function(e){if(!e)return null;const t=e.toLowerCase().trim();if(window.crypto&&window.crypto.subtle)try{const e=(new TextEncoder).encode(t),n=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,"0")).join("")}catch(e){return console.warn("[Consently DPDPA] Web Crypto API failed, using fallback hash:",e),z(t)}return z(t)}(r),t=await async function(e){if(!e)return{status:"new"};try{const t=s(),n=await fetch(`${t}/api/dpdpa/check-user-status`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({emailHash:e,widgetId:i})});return n.ok?await n.json():{status:"new"}}catch(e){return console.error("[Consently DPDPA] Check user status error:",e),{status:"new"}}}(e);a=t.status||"new",console.log("[Consently DPDPA] User status:",a,"verified"===a?"(returning user)":"(new user)")}else console.log("[Consently DPDPA] No email found, user will need to enter email manually")}else console.log("[Consently DPDPA] Smart pre-fill is disabled by site owner - using manual input"),r=null,a="new";W(e),Y(e);new FormData(t);const l=o.submitter||t.querySelector('[type="submit"]');console.log("[Consently DPDPA] Showing widget with pre-filled email:",r||"none"),ee(r,a),window.addEventListener("consentlyDPDPAConsent",function e(o){console.log("[Consently DPDPA] Consent received, allowing form submission"),window.removeEventListener("consentlyDPDPAConsent",e),setTimeout(()=>{t.removeEventListener("submit",n),l?l.click():t.submit(),setTimeout(()=>{t.addEventListener("submit",n,{capture:!0})},100)},300)},{once:!0})}};t.addEventListener("submit",n,{capture:!0}),console.log("[Consently DPDPA] Form submit listener attached:",t.id||t.name||"unnamed form")})}function F(e){const t=void 0!==e.scroll_threshold?e.scroll_threshold:50;let n=!1;console.log("[Consently DPDPA] Setting up scroll trigger for rule:",e.rule_name,"Threshold:",t+"%");let o=0;const i=()=>{const r=Date.now();if(r-o<100)return;if(o=r,n)return window.removeEventListener("scroll",i),window.removeEventListener("wheel",i),void window.removeEventListener("touchmove",i);const a=function(){const e=window.innerHeight,t=document.documentElement.scrollHeight-e,n=window.pageYOffset||document.documentElement.scrollTop;return 0===t?0:Math.round(n/t*100)}();if(a>=t){console.log("[Consently DPDPA] Scroll threshold reached:",a+"%"),n=!0,W(e);const t=e.trigger_delay||0;setTimeout(()=>{ee()},t),Y(e),window.removeEventListener("scroll",i),window.removeEventListener("wheel",i),window.removeEventListener("touchmove",i)}};return window.addEventListener("scroll",i,{passive:!0}),window.addEventListener("wheel",i,{passive:!0}),window.addEventListener("touchmove",i,{passive:!0}),setTimeout(()=>{i()},500),()=>{window.removeEventListener("scroll",i),window.removeEventListener("wheel",i),window.removeEventListener("touchmove",i)}}function V(){try{if(!d||"object"!=typeof d)return console.warn("[Consently DPDPA] Invalid config in evaluateDisplayRules"),null;const e=d.display_rules||[],t="undefined"!=typeof window&&window.location&&(window.location.href||window.location.pathname)||"/";if("string"!=typeof t)return console.warn("[Consently DPDPA] Invalid URL in evaluateDisplayRules"),null;if(console.log("[Consently DPDPA] Evaluating display rules for URL:",t),console.log("[Consently DPDPA] Available rules:",e.length),!Array.isArray(e)||0===e.length)return console.log("[Consently DPDPA] No display rules configured"),null;const n=[...e.filter(e=>e&&"object"==typeof e?e.id&&e.rule_name&&e.url_pattern?!("string"!=typeof e.id||e.id.length>100)||(console.warn("[Consently DPDPA] Invalid rule ID, skipping:",e.id),!1):(console.warn("[Consently DPDPA] Rule missing required fields, skipping:",e.id||"unknown"),!1):(console.warn("[Consently DPDPA] Invalid rule structure, skipping"),!1))].sort((e,t)=>{const n="number"==typeof e.priority?e.priority:100;return("number"==typeof t.priority?t.priority:100)-n});for(const e of n)if(!1!==e.is_active)try{if(O(t,e)){if(console.log("[Consently DPDPA] Rule matched:",e.rule_name),e.element_selector)try{if(!document.querySelector(e.element_selector)){console.log("[Consently DPDPA] Element not found:",e.element_selector);continue}}catch(t){console.error("[Consently DPDPA] Invalid selector:",e.element_selector,t);continue}return e}}catch(t){console.error("[Consently DPDPA] Error matching rule:",e.id,t);continue}else console.log("[Consently DPDPA] Rule inactive:",e.rule_name);return console.log("[Consently DPDPA] No matching rules found"),null}catch(e){return console.error("[Consently DPDPA] Error in evaluateDisplayRules:",e),null}}function W(e){p.length>0&&(u=JSON.parse(JSON.stringify(p)),d&&(d.activities=u)),d._matchedRule=e;const t=window.location.pathname||"/",n=window.location.href||t;if(e.url_pattern&&"*"!==e.url_pattern&&"/*"!==e.url_pattern&&(!e.activities||!Array.isArray(e.activities)||0===e.activities.length))return console.error("[Consently DPDPA] ‚ùå Display rule matched for:",t),console.error("[Consently DPDPA] ‚ùå Full URL:",n),console.error("[Consently DPDPA] ‚ùå Rule:",e.rule_name),console.error("[Consently DPDPA] ‚ùå URL pattern:",e.url_pattern,"| Match type:",e.url_match_type||"contains"),console.error("[Consently DPDPA] ‚ùå BUT rule does not specify which activities to show!"),console.error("[Consently DPDPA] ‚ùå Widget will NOT be shown to prevent showing all activities"),void console.error('[Consently DPDPA] ‚ùå To fix: Add "activities" array to the display rule with only the activities you want to show');if(e.activities&&Array.isArray(e.activities)&&e.activities.length>0){console.log("[Consently DPDPA] Filtering activities for rule:",e.rule_name),console.log("[Consently DPDPA] Rule activities:",e.activities),console.log("[Consently DPDPA] Available activities before filter:",u.length),console.log("[Consently DPDPA] Available activity IDs:",u.map(e=>({id:e.id,name:e.activity_name||e.activityName})));const t=u.map(e=>e.id),n=e.activities.filter(e=>t.includes(e)),o=e.activities.filter(e=>!t.includes(e));o.length>0&&(console.warn("[Consently DPDPA] ‚ö†Ô∏è Some rule activity IDs do not match widget activities"),console.warn("[Consently DPDPA] Invalid activity IDs in rule:",o),console.warn("[Consently DPDPA] Valid activity IDs in widget:",t),console.warn("[Consently DPDPA] ‚Üí Filtering out invalid IDs and continuing with valid ones"));const i=u.filter(e=>n.includes(e.id));if(console.log("[Consently DPDPA] Filtered activities count:",i.length),console.log("[Consently DPDPA] Rule specifies:",e.activities.length,"activities"),console.log("[Consently DPDPA] Widget has:",t.length,"activities"),console.log("[Consently DPDPA] Matched:",i.length,"activities"),0===i.length&&(console.warn("[Consently DPDPA] ‚ö†Ô∏è No activities matched rule filter!"),console.warn("[Consently DPDPA] Rule activity IDs:",e.activities),console.warn("[Consently DPDPA] Widget activity IDs:",t),console.warn("[Consently DPDPA] ‚Üí Widget will show ZERO activities (correct behavior)"),console.warn("[Consently DPDPA] ‚Üí Fix: Ensure rule activities are in widget's selected_activities list")),u.length=0,u.push(...i),d.activities&&(d.activities=i),e.activities=n,0===i.length)return console.warn("[Consently DPDPA] ‚ö†Ô∏è Not showing widget because no activities remain after display rule filtering"),void console.warn("[Consently DPDPA] This is the correct behavior - fix by ensuring rule activities match widget activities")}if(e.activity_purposes&&"object"==typeof e.activity_purposes){console.log("[Consently DPDPA] Filtering purposes for rule:",e.rule_name),console.log("[Consently DPDPA] Rule activity_purposes:",e.activity_purposes);const t=u.map(e=>e.id),n={};Object.keys(e.activity_purposes).forEach(o=>{t.includes(o)?n[o]=e.activity_purposes[o]:console.warn("[Consently DPDPA] Removing activity_purposes entry for non-existent activity:",o)}),e.activity_purposes=n,u.forEach(t=>{const n=e.activity_purposes[t.id];if(n&&Array.isArray(n)&&n.length>0){if(console.log("[Consently DPDPA] Filtering purposes for activity:",t.id,"Allowed purposes:",n),t.purposes&&Array.isArray(t.purposes)){const e=t.purposes.length;console.log("[Consently DPDPA] DEBUG - Purposes before filter:"),t.purposes.forEach(e=>{console.log(`  - Purpose: ${e.purposeName}, purposeId: ${e.purposeId}, id: ${e.id}`),console.log(`    Allowed? ${n.includes(e.purposeId)} (purposeId) or ${n.includes(e.id)} (id)`)}),t.purposes=t.purposes.filter(e=>{const t=n.includes(e.purposeId);return t||console.log("[Consently DPDPA] DEBUG - Filtering out purpose:",e.purposeName,"purposeId:",e.purposeId),t}),console.log("[Consently DPDPA] Filtered purposes for activity:",t.id,"from",e,"to",t.purposes.length),0===t.purposes.length&&(console.warn("[Consently DPDPA] Warning: Activity",t.id,"has no purposes after filtering!"),console.warn("[Consently DPDPA] Allowed purpose IDs:",n),console.warn("[Consently DPDPA] Check that purpose IDs in activity_purposes match actual purpose UUIDs"))}}else console.log("[Consently DPDPA] Showing all purposes for activity:",t.id,"(no purpose filtering specified)")})}const o=e.notice_content;o?(o.title&&(d.title=o.title),o.message&&(d.message=o.message),o.html&&!o.html.includes("By submitting this form")?d.privacyNoticeHTML=o.html:d.privacyNoticeHTML=K(u,d.domain||window.location.hostname)):d.privacyNoticeHTML=K(u,d.domain||window.location.hostname)}async function G(e){try{const t=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;if(!e||"object"!=typeof e)throw new Error("Invalid consent data");if(!e.widgetId||!e.visitorId||!e.consentStatus)throw new Error("Missing required consent fields");if(!["accepted","rejected","partial","revoked"].includes(e.consentStatus))throw new Error("Invalid consent status");if(e.acceptedActivities&&!Array.isArray(e.acceptedActivities)&&(console.warn("[Consently DPDPA] Invalid acceptedActivities, converting to array"),e.acceptedActivities=[]),e.rejectedActivities&&!Array.isArray(e.rejectedActivities)&&(console.warn("[Consently DPDPA] Invalid rejectedActivities, converting to array"),e.rejectedActivities=[]),e.acceptedActivities){const n=e.acceptedActivities.length;e.acceptedActivities=e.acceptedActivities.filter(e=>"string"==typeof e&&t.test(e)),e.acceptedActivities.length!==n&&console.warn("[Consently DPDPA] Filtered out invalid UUIDs from acceptedActivities")}if(e.rejectedActivities){const n=e.rejectedActivities.length;e.rejectedActivities=e.rejectedActivities.filter(e=>"string"==typeof e&&t.test(e)),e.rejectedActivities.length!==n&&console.warn("[Consently DPDPA] Filtered out invalid UUIDs from rejectedActivities")}if(e.activityPurposeConsents&&"object"==typeof e.activityPurposeConsents){const n={};for(const[o,i]of Object.entries(e.activityPurposeConsents))if("string"==typeof o&&t.test(o)&&Array.isArray(i)){const e=i.filter(e=>"string"==typeof e&&t.test(e));e.length>0&&(n[o]=e)}e.activityPurposeConsents=Object.keys(n).length>0?n:void 0}if(e.acceptedActivities&&e.acceptedActivities.length>100&&(console.warn("[Consently DPDPA] Too many accepted activities, limiting to 100"),e.acceptedActivities=e.acceptedActivities.slice(0,100)),e.rejectedActivities&&e.rejectedActivities.length>100&&(console.warn("[Consently DPDPA] Too many rejected activities, limiting to 100"),e.rejectedActivities=e.rejectedActivities.slice(0,100)),e.metadata&&(""!==e.metadata.referrer&&null!==e.metadata.referrer||(e.metadata.referrer=void 0),""!==e.metadata.pageTitle&&null!==e.metadata.pageTitle||(e.metadata.pageTitle=void 0),e.metadata.currentUrl))try{new URL(e.metadata.currentUrl)}catch(t){console.warn("[Consently DPDPA] Invalid currentUrl, removing:",e.metadata.currentUrl),e.metadata.currentUrl=void 0}const n=o.src;let i;try{if(n&&n.includes("http")){i=new URL(n).origin}else i=window.location.origin}catch(e){console.error("[Consently DPDPA] Error parsing script URL:",e),i=window.location.origin}const r=`${i}/api/dpdpa/consent-record`;return await async function(e,t=3,n=1e3){let o;for(let i=1;i<=t;i++)try{return await e()}catch(e){if(o=e,!("AbortError"===e.name||e.message.includes("timeout")||e.message.includes("network")||e.message.includes("500")||e.message.includes("502")||e.message.includes("503")||e.message.includes("504"))||i===t)throw o;const r=n*Math.pow(2,i-1);console.log(`[Consently DPDPA] Retry attempt ${i}/${t} in ${r}ms...`),await new Promise(e=>setTimeout(e,r))}throw o}(async()=>{const t=new AbortController,n=setTimeout(()=>t.abort(),1e4);try{const o=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),signal:t.signal});if(clearTimeout(n),!o.ok){let e="Failed to record consent",t=null;try{const n=await o.json();e=n.error||e,n.details&&Array.isArray(n.details)?(t=n.details,console.error("[Consently DPDPA] Validation errors:",t),console.error("[Consently DPDPA] Full error response:",n)):console.error("[Consently DPDPA] API error response:",n)}catch(e){console.error("[Consently DPDPA] Failed to parse error response:",e)}if(t&&t.length>0){const n=t.map(e=>`${e.field}: ${e.message}`).join("; ");throw new Error(e+" (HTTP "+o.status+") - "+n)}throw new Error(e+" (HTTP "+o.status+")")}const i=await o.json();return console.log("[Consently DPDPA] Consent recorded successfully"),i}catch(e){if(clearTimeout(n),"AbortError"===e.name)throw new Error("Request timeout: Could not record consent");throw e}},3,1e3)}catch(e){console.error("[Consently DPDPA] Failed to record consent:",e);const t=e instanceof Error&&e.message.includes("timeout")?e.message:"Failed to save consent. Please try again.";throw new Error(t)}}async function Y(e){try{const t=`consently_dpdpa_rule_tracked_${i}_${e.id}`;if(sessionStorage.getItem(t))return;sessionStorage.setItem(t,"true");const n=o.src;let r;try{if(n&&n.includes("http")){r=new URL(n).origin}else r=window.location.origin}catch(e){console.error("[Consently DPDPA] Error parsing script URL:",e),r=window.location.origin}const a=`${r}/api/dpdpa/analytics/rule-match`,s=navigator.userAgent||"",l=/mobile|iphone|ipod|blackberry|windows phone|android.*mobile/i.test(s)?"Mobile":/tablet|ipad|playbook|silk|android(?!.*mobi)/i.test(s)?"Tablet":"Desktop",c={widgetId:i,visitorId:y||N(),ruleId:e.id,ruleName:e.rule_name,urlPattern:e.url_pattern,pageUrl:window.location.pathname,matchedAt:(new Date).toISOString(),triggerType:e.trigger_type,userAgent:s,deviceType:l,language:navigator.language||"en",country:void 0};fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c),keepalive:!0}).catch(e=>{console.error("[Consently DPDPA] Failed to track rule match:",e)}),console.log("[Consently DPDPA] Rule match tracked:",e.rule_name)}catch(e){console.error("[Consently DPDPA] Error tracking rule match:",e)}}function H(){let e='<option value="" disabled selected>Year...</option>';for(let t=(new Date).getFullYear();t>=1900;t--)e+=`<option value="${t}">${t}</option>`;return e}async function J(){console.log("[Consently DPDPA] Showing minor block screen");const e=document.getElementById("dpdpa-minor-block-modal");e&&e.remove();(d&&d.theme?d.theme:{}).primaryColor;const t=await c(d&&d.language?d.language:"en"),n=d&&d.ageGateMinorMessage?d.ageGateMinorMessage:t.ageGateDefaultMinorMessage,o=document.createElement("div");o.id="dpdpa-minor-block-modal",o.style.cssText="\n      position: fixed;\n      top: 0; left: 0; right: 0; bottom: 0;\n      background: rgba(0,0,0,0.5);\n      backdrop-filter: blur(4px);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      z-index: 999999;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      padding: 16px;\n    ",o.innerHTML=`\n      <div style="background:white;border-radius:16px;padding:32px;max-width:400px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.15);text-align:center;">\n        \x3c!-- Icon --\x3e\n        <div style="width:80px;height:80px;background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);border-radius:50%;display:inline-flex;align-items:center;justify-content:center;margin-bottom:20px;box-shadow:0 4px 12px rgba(245,158,11,0.3);">\n          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n            <path d="M12 8V12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n            <path d="M12 16H12.01" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n          </svg>\n        </div>\n        \n        \x3c!-- Message --\x3e\n        <h2 style="margin:0 0 12px 0;font-size:20px;font-weight:700;color:#1a1a1a;">Age Verification Required</h2>\n        <p style="color:#64748b;font-size:15px;margin:0 0 24px 0;line-height:1.6;">\n          ${re(n)}\n        </p>\n        \n        \x3c!-- Info Box --\x3e\n        <div style="background:#fef3c7;border:1px solid #fcd34d;border-radius:10px;padding:14px;margin-bottom:16px;">\n          <p style="color:#92400e;font-size:13px;margin:0;line-height:1.5;">\n            <strong>Why am I seeing this?</strong><br>\n            Based on the information provided, you appear to be under the required age. This setting is stored on this device for 1 year.\n          </p>\n        </div>\n        \n        \x3c!-- Powered by --\x3e\n        <p style="font-size:11px;color:#94a3b8;margin:0;">\n          Protected by <strong>Consently</strong> ¬∑ DPDPA 2023 Compliance\n        </p>\n      </div>\n    `,document.body.appendChild(o)}function K(e,t){const n=t||window.location.hostname,o=e.map((e,t)=>{let n="",o=[],i="N/A";n=e.purposes&&e.purposes.length>0?e.purposes.map(e=>{const t=e.dataCategories?.map(e=>e.categoryName)||[];o.push(...t);const n=e.dataCategories?.map(e=>`${e.categoryName}: ${e.retentionPeriod}`)||[];return n.length>0&&(i=n.join(", ")),`<li>${re(e.purposeName)} (${re(e.legalBasis?.replace("-"," ")||"consent")})</li>`}).join(""):"<li>No purposes defined</li>";const r=o.length>0?o.map(e=>re(e)).join(", "):"N/A";return`\n    <div style="margin-bottom: 24px; padding: 16px; background: #f9fafb; border-left: 4px solid #3b82f6; border-radius: 8px;">\n      <h3 style="margin: 0 0 12px 0; color: #1f2937; font-size: 18px; font-weight: 600;">\n        ${t+1}. ${re(e.activity_name||e.activityName||"Activity")}\n      </h3>\n      \n      <div style="margin-bottom: 12px;">\n        <strong style="color: #374151;">Purposes:</strong>\n        <ul style="margin: 4px 0 0 0; color: #6b7280; padding-left: 20px;">\n          ${n}\n        </ul>\n      </div>\n\n      <div style="margin-bottom: 12px;">\n        <strong style="color: #374151;">Data Categories:</strong>\n        <p style="margin: 4px 0 0 0; color: #6b7280;">${r}</p>\n      </div>\n\n      <div>\n        <strong style="color: #374151;">Retention Period:</strong>\n        <p style="margin: 4px 0 0 0; color: #6b7280;">${re(i)}</p>\n      </div>\n    </div>\n  `}).join("");return`\n<h1 style="color: #111827; font-size: 32px; margin-bottom: 16px;">Privacy Notice</h1>\n\n<div style="background: #dbeafe; padding: 16px; border-radius: 8px; margin-bottom: 32px;">\n  <p style="margin: 0; color: #1e40af; font-weight: 500;">\n    This notice explains how ${re(n)} processes your personal data in compliance with the Digital Personal Data Protection Act, 2023 (DPDPA).\n  </p>\n</div>\n\n<h2 style="color: #1f2937; font-size: 24px; margin-top: 32px; margin-bottom: 16px;">Data Processing Activities</h2>\n\n<p style="color: #6b7280; margin-bottom: 24px;">\n  We process your personal data for the following purposes. You have the right to provide or withdraw consent for each activity.\n</p>\n\n${o}\n\n<div style="margin-top: 48px; padding-top: 24px; border-top: 2px solid #e5e7eb;">\n  <h2 style="color: #1f2937; font-size: 20px; margin-bottom: 16px;">Your Rights Under DPDPA 2023</h2>\n  \n  <ul style="color: #6b7280; line-height: 1.8;">\n    <li><strong>Right to Access:</strong> You can request information about what personal data we hold about you.</li>\n    <li><strong>Right to Correction:</strong> You can request correction of inaccurate or incomplete data.</li>\n    <li><strong>Right to Erasure:</strong> You can request deletion of your personal data in certain circumstances.</li>\n    <li><strong>Right to Withdraw Consent:</strong> You can withdraw your consent at any time.</li>\n    <li><strong>Right to Grievance Redressal:</strong> You can raise concerns or complaints about data processing.</li>\n  </ul>\n</div>\n\n<div style="margin-top: 32px; padding: 16px; background: #f3f4f6; border-radius: 8px;">\n  <p style="margin: 0; color: #6b7280; font-size: 14px;">\n    <strong>Compliance:</strong> This notice is compliant with the Digital Personal Data Protection Act, 2023 (DPDPA)\n  </p>\n</div>\n`.trim()}function Z(e,t="info"){const n=document.createElement("div");n.style.cssText=`\n      position: fixed;\n      bottom: 30px;\n      right: 30px;\n      background: ${"success"===t?"#10b981":"#3b82f6"};\n      color: white;\n      padding: 16px 24px;\n      border-radius: 12px;\n      box-shadow: 0 10px 30px rgba(0,0,0,0.3);\n      font-weight: 600;\n      font-size: 15px;\n      z-index: 1000000;\n    `,n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.style.opacity="0",n.style.transition="opacity 0.3s ease",setTimeout(()=>n.remove(),300)},3e3)}async function X(){const e=await async function(){try{const e=o.src;let t;t=e&&e.includes("http")?new URL(e).origin:window.location.origin;const n=`${t}/api/dpdpa/widget-public/${i}`;console.log("[Consently DPDPA] Fetching configuration from:",n);const r=`${n}?_t=${Date.now()}`,a=await fetch(r,{method:"GET",headers:{"Content-Type":"application/json","Cache-Control":"no-cache"},cache:"no-store"});if(!a.ok){if(404===a.status){const e=(await a.json().catch(()=>({}))).error||"Widget configuration not found";return console.error("[Consently DPDPA] Widget not found:",{widgetId:i,status:a.status,error:e,hint:"This widget may have been deleted. Please check your Consently dashboard and create a new widget if needed."}),q(`Widget ID "${i}" not found. This widget may have been deleted. Please check your Consently dashboard or contact support if this persists.`,!0),{success:!1,error:"WIDGET_NOT_FOUND",status:404}}if(429===a.status)return console.warn("[Consently DPDPA] Rate limit exceeded. Retrying later..."),{success:!1,error:"RATE_LIMIT",status:429};{const e=await a.text().catch(()=>a.statusText);throw new Error(`HTTP ${a.status}: ${e}`)}}const s=await a.json();return d=s,p=JSON.parse(JSON.stringify(s.activities||[])),u=s.activities||[],console.log("[Consently DPDPA] Configuration loaded:",d.name),console.log("[Consently DPDPA] Activities loaded:",u.length),u.length>0?(console.log("[Consently DPDPA] First activity:",u[0]),console.log("[Consently DPDPA] Activity structure check:",{hasPurposes:!!u[0].purposes,hasDataAttributes:!!u[0].data_attributes,purposesCount:u[0].purposes?.length||0,dataAttributesCount:u[0].data_attributes?.length||0})):(console.warn("[Consently DPDPA] No activities found in configuration!"),console.log("[Consently DPDPA] Full config:",s)),{success:!0}}catch(e){return console.error("[Consently DPDPA] Failed to load configuration:",e),"TypeError"===e.name&&e.message.includes("fetch")?(q("Unable to connect to Consently service. Please check your internet connection.",!1),{success:!1,error:"NETWORK_ERROR"}):{success:!1,error:"UNKNOWN_ERROR",message:e.message}}}();if(!e||!e.success){if(e&&"WIDGET_NOT_FOUND"===e.error)console.error("[Consently DPDPA] Widget initialization failed: Widget not found");else{if(e&&"RATE_LIMIT"===e.error)return console.warn("[Consently DPDPA] Rate limited, retrying in 5 seconds..."),void setTimeout(X,5e3);if(console.error("[Consently DPDPA] Failed to initialize widget:",e?.error||"Unknown error"),e&&"NETWORK_ERROR"===e.error)return console.warn("[Consently DPDPA] Network error, retrying in 3 seconds..."),void setTimeout(X,3e3)}return}if(d.respectDNT&&"1"===navigator.doNotTrack)return void console.log("[Consently DPDPA] DNT enabled, respecting user preference");d.requireAgeVerification&&d.enableAgeGate&&console.warn("[Consently DPDPA] Both DigiLocker age verification and legacy age gate are enabled. Only DigiLocker will be used. Consider disabling the legacy age gate in your widget settings.");let t=!1;if(d.requireAgeVerification)if(E())console.log("[Consently DPDPA] Age verification already completed");else{const e=await async function(){const e=new URLSearchParams(window.location.search),t=e.get("age_verification_session"),n=e.get("age_verification_status");if(!t){const e=sessionStorage.getItem("consently_age_session");return e?(w=e,await j(e)):null}if(w=t,"verified"===n){const e=await j(t),n=new URL(window.location.href);return n.searchParams.delete("age_verification_session"),n.searchParams.delete("age_verification_status"),window.history.replaceState({},document.title,n.toString()),e}return null}();if(e){console.log("[Consently DPDPA] Age verification callback processed:",e.status),function(){try{const e=`consently_widget_state_${i}`,t=sessionStorage.getItem(e);if(!t)return null;sessionStorage.removeItem(e);const n=JSON.parse(t);return Date.now()-n.savedAt>18e5?(console.log("[Consently DPDPA] Saved widget state expired, discarding"),null):(n.activityConsents&&Object.keys(n.activityConsents).length>0&&(g=n.activityConsents),n.userEmail&&(h=n.userEmail),n.verifiedEmail&&(f=n.verifiedEmail),n.consentID&&(y=n.consentID),console.log("[Consently DPDPA] Widget state restored after redirect"),n)}catch(e){return console.error("[Consently DPDPA] Error restoring widget state:",e),null}}();const n=["verified_adult","guardian_approved","limited_access"];!e.verified||e.verificationOutcome&&!n.includes(e.verificationOutcome)||(t=!0,console.log("[Consently DPDPA] Age verification passed - will show widget for consent"))}}const n=k.get("consently_consent_id");if(!n){const e=V();if(e&&("onClick"===e.trigger_type||"onFormSubmit"===e.trigger_type||"onScroll"===e.trigger_type))return void("onClick"===e.trigger_type&&e.element_selector?U(e):"onFormSubmit"===e.trigger_type?B(e):"onScroll"===e.trigger_type&&F(e));if(Array.isArray(d.display_rules)&&d.display_rules.length>0){const e=d.display_rules.find(e=>"onFormSubmit"===e.trigger_type);if(e)return console.log("[Consently DPDPA] Setting up global form submit trigger for new user (no page-specific rule matched)"),void B(e)}return}{y=n;let e=null;console.log("[Consently DPDPA] Checking API for existing consent...");const t=await async function(e){try{const t=o.src;let n;n=t&&t.includes("http")?new URL(t).origin:window.location.origin;const r=`${n}/api/dpdpa/check-consent?widgetId=${encodeURIComponent(i)}&visitorId=${encodeURIComponent(e)}&currentUrl=${encodeURIComponent(window.location.href)}`;console.log("[Consently DPDPA] Checking API for existing consent:",r);const a=new AbortController,s=setTimeout(()=>a.abort(),5e3),l=await fetch(r,{method:"GET",headers:{"Content-Type":"application/json"},signal:a.signal});if(clearTimeout(s),!l.ok)return console.warn("[Consently DPDPA] API consent check failed:",l.status,l.statusText),null;const c=await l.json();if(c.hasConsent&&c.consent){c.consent.foundByPrincipalId?(console.log("[Consently DPDPA] ‚úÖ Valid consent found via cross-device sync (principal_id)!"),console.log("[Consently DPDPA] This means user already consented on another device with the same email.")):console.log("[Consently DPDPA] Valid consent found via API (same device):",c.consent);const t={status:c.consent.status,acceptedActivities:c.consent.acceptedActivities||[],rejectedActivities:c.consent.rejectedActivities||[],timestamp:c.consent.timestamp,expiresAt:c.consent.expiresAt,activityConsents:{},foundByPrincipalId:c.consent.foundByPrincipalId||!1,verifiedEmail:c.consent.visitorEmail||null,stableConsentId:c.stableConsentId||null};return c.stableConsentId&&c.stableConsentId!==e&&(console.log("[Consently DPDPA] üîÑ Adopting stable Consent ID from API:",{old:e,new:c.stableConsentId}),M(e=c.stableConsentId)),t}return console.log("[Consently DPDPA] No valid consent found via API"),null}catch(e){return"AbortError"===e.name?console.warn("[Consently DPDPA] API consent check timed out"):console.warn("[Consently DPDPA] API consent check error:",e),null}}(y);if(t)e=t,k.set(`consently_dpdpa_consent_${i}`,{status:t.status,acceptedActivities:t.acceptedActivities,rejectedActivities:t.rejectedActivities,activityConsents:t.activityConsents,timestamp:t.timestamp,expiresAt:t.expiresAt,verifiedEmail:t.verifiedEmail},d.consentDuration||365),console.log("[Consently DPDPA] Consent synced from API to localStorage");else{console.log("[Consently DPDPA] No API consent found, checking localStorage...");const t=k.get(`consently_dpdpa_consent_${i}`);if(t&&t.timestamp)if(t.expiresAt){new Date(t.expiresAt)<new Date?(console.log("[Consently DPDPA] localStorage consent expired, clearing..."),k.delete(`consently_dpdpa_consent_${i}`),e=null):(e=t,console.log("[Consently DPDPA] Found valid consent in localStorage"))}else{const n=(Date.now()-new Date(t.timestamp).getTime())/864e5;n<(d.consentDuration||365)?(e=t,console.log("[Consently DPDPA] Found valid consent in localStorage (age: "+Math.round(n)+" days)")):(console.log("[Consently DPDPA] localStorage consent expired by duration, clearing..."),k.delete(`consently_dpdpa_consent_${i}`),e=null)}else console.log("[Consently DPDPA] No consent found in localStorage")}e&&e.verifiedEmail&&(f=e.verifiedEmail,console.log("[Consently DPDPA] Restored verified email:",f));const a=V();if(a){if("onClick"===a.trigger_type&&a.element_selector){if(U(a),e&&e.timestamp){const t=u.map(e=>e.id),n=[...e.acceptedActivities||[],...e.rejectedActivities||[]];t.every(e=>n.includes(e))&&Q(e)}return}if("onFormSubmit"===a.trigger_type){if(B(a),e&&e.timestamp){const t=u.map(e=>e.id),n=[...e.acceptedActivities||[],...e.rejectedActivities||[]];t.every(e=>n.includes(e))&&Q(e)}return}if("onScroll"===a.trigger_type){if(F(a),e&&e.timestamp){const t=u.map(e=>e.id),n=[...e.acceptedActivities||[],...e.rejectedActivities||[]];t.every(e=>n.includes(e))&&Q(e)}return}"onPageLoad"===a.trigger_type&&(W(a),Y(a))}if(e&&e.timestamp){const t=function(e){if(!e||!e.timestamp)return!1;if(e.expiresAt&&new Date(e.expiresAt)<new Date)return console.log("[Consently DPDPA] Consent expired"),!1;const t=[...e.acceptedActivities||[],...e.rejectedActivities||[]];return t.length>0?(console.log("[Consently DPDPA] User has existing valid consent for",t.length,"activities"),!0):(console.log("[Consently DPDPA] No consent activities found"),!1)}(e);if(t)return console.log("[Consently DPDPA] Valid consent found for current page"),void Q(e);console.log("[Consently DPDPA] Consent exists but does not cover all activities for this page")}if(a&&"onPageLoad"===a.trigger_type)r=a,console.log("[Consently DPDPA] Showing notice for rule:",r.rule_name),console.log("[Consently DPDPA] Activities to show:",u.length),W(r),"onPageLoad"===r.trigger_type&&setTimeout(()=>{ee()},r.trigger_delay||0);else{if(a)return;if(Array.isArray(d.display_rules)&&d.display_rules.length>0){const e=d.display_rules.find(e=>"onFormSubmit"===e.trigger_type);if(e)return console.log("[Consently DPDPA] Setting up global form submit trigger (no page-specific rule matched)"),void B(e);const t="undefined"!=typeof window&&window.location&&window.location.pathname||"/";return console.warn("[Consently DPDPA] ‚ö†Ô∏è Display rules configured but none matched for:",t),void console.warn("[Consently DPDPA] ‚ö†Ô∏è Widget will not be shown to avoid mixing purposes. Configure a rule for this page or disable autoShow.")}d.autoShow&&setTimeout(()=>{ee()},d.showAfterDelay||1e3)}}var r;return t?(console.log("[Consently DPDPA] Showing widget after age verification completion"),void setTimeout(()=>{ee()},500)):void 0}function Q(e){const t=new CustomEvent("consentlyDPDPAConsent",{detail:{status:e.status,acceptedActivities:e.acceptedActivities||[],rejectedActivities:e.rejectedActivities||[],activityConsents:e.activityConsents||{},timestamp:e.timestamp}});window.dispatchEvent(t),window.consentlyDPDPAConsent=e}async function ee(e=null,t="new"){if(console.log("[Consently DPDPA] showConsentWidget called with:",{prefilledEmail:e||"none",userStatus:t,smartPreFillActive:!!e}),document.getElementById("consently-dpdpa-widget"))return;if(m=e||null,h=e||null,!u||0===u.length)return console.error("[Consently DPDPA] Cannot show widget: No activities available"),console.error("[Consently DPDPA] This may be due to display rules filtering out all activities"),void console.error("[Consently DPDPA] Check your widget configuration and display rules");const n=d.theme||{};b=n.primaryColor||"#4c8bf5";const o=n.backgroundColor||"#ffffff",i=n.textColor||"#1f2937",r=(n.borderRadius,n.fontFamily||"system-ui, sans-serif"),a=n.fontSize||14;let s=d.language||"en",p=await c(s),g=!1;const y=JSON.parse(JSON.stringify(u));let f={title:d.title||"Your Data Privacy Rights",message:d.message||"We process your personal data with your consent. Please review the activities below and choose your preferences.",acceptButtonText:d.acceptButtonText||"Accept All",rejectButtonText:d.rejectButtonText||"Reject All",customizeButtonText:d.customizeButtonText||"Manage Preferences"};if("en"!==s){const e=[...[f.title,f.message,f.acceptButtonText,f.rejectButtonText,f.customizeButtonText],...[...u.map(e=>e.activity_name),...u.flatMap(e=>e.purposes&&Array.isArray(e.purposes)&&e.purposes.length>0?e.purposes.flatMap(e=>[e.purposeName||"",...(e.dataCategories||[]).map(e=>e.categoryName||"")]).filter(Boolean):e.data_attributes||[])]],t=await l(e,s);let n=0;f={title:t[n++],message:t[n++],acceptButtonText:t[n++],rejectButtonText:t[n++],customizeButtonText:t[n++]};const o=u.map(e=>{const o=t[n++],i=e.data_attributes.map(()=>t[n++]);return{...e,activity_name:o,data_attributes:i}});u=o}!async function(){(d.supportedLanguages||["en"]).filter(e=>"en"!==e).slice(0,5).forEach(async e=>{try{await c(e);const t=[...u.map(e=>e.activity_name),...u.flatMap(e=>e.purposes&&Array.isArray(e.purposes)&&e.purposes.length>0?e.purposes.flatMap(e=>[e.purposeName||"",...(e.dataCategories||[]).map(e=>e.categoryName||"")]).filter(Boolean):e.data_attributes||[])];await l(t,e),console.log(`[Consently DPDPA] Prefetched translations for ${e}`)}catch(t){console.log(`[Consently DPDPA] Could not prefetch ${e} translations:`,t)}})}();const x=d.privacyNoticeHTML||'<p style="color:#6b7280;">Privacy notice content...</p>';let w=x;if(x.includes("<body")){const e=x.match(/<body[^>]*>([\s\S]*?)<\/body>/i);e&&(w=e[1])}const P=document.createElement("div");P.id="consently-dpdpa-overlay",P.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: rgba(0, 0, 0, 0.4);\n      backdrop-filter: blur(8px);\n      -webkit-backdrop-filter: blur(8px);\n      z-index: 999998;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      opacity: 0;\n      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);\n    ";const D=document.createElement("div");function C(){return`\n      \x3c!-- Header Section --\x3e\n      <div style="padding: 20px 24px; border-bottom: 1px solid #e5e7eb; background: #ffffff;">\n        <div style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 12px;">\n          <div style="display: flex; align-items: center; gap: 12px;">\n            ${d.theme.logoUrl?`\n              <img src="${re(d.theme.logoUrl)}" alt="Logo" style="height: 36px; width: auto; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));" />\n            `:`\n              <div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 10px; background: linear-gradient(135deg, ${b} 0%, ${b}dd 100%); color: white; font-weight: 700; font-size: 18px; box-shadow: 0 4px 8px rgba(59,130,246,0.3);">\n                C\n              </div>\n            `}\n            <div>\n              <h2 style="margin: 0 0 4px 0; font-size: 20px; font-weight: 700; color: ${i}; letter-spacing: -0.01em;">${re(f.title)}</h2>\n              <p style="margin: 0; font-size: 13px; color: #6b7280; line-height: 1.4;">${re(p.compliantWith)}</p>\n            </div>\n          </div>\n          <div style="display: flex; align-items: center; gap: 8px;">\n            \x3c!-- Language Selector with Radio Layout --\x3e\n            <div style="position: relative;">\n              <button id="dpdpa-lang-btn" style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 8px; background: white; color: ${i}; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">\n                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                  <circle cx="12" cy="12" r="10"/>\n                  <line x1="2" y1="12" x2="22" y2="12"/>\n                  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>\n                </svg>\n                <span style="font-size: 13px;">${A(s)}</span>\n                <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.5;">\n                  <path d="M7 10l5 5 5-5z"/>\n                </svg>\n              </button>\n              <div id="dpdpa-lang-menu" style="display: none; position: absolute; right: 0; margin-top: 8px; background: white; border: 1px solid #e5e7eb; border-radius: 10px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.15); padding: 8px; z-index: 10; min-width: 200px; max-height: 320px; overflow-y: auto;">\n                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;">\n                  ${(d.supportedLanguages||["en"]).map(e=>`\n                    <button data-lang="${e}" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px 6px; border: none; background: ${e===s?"#dbeafe":"#f9fafb"}; border-radius: 6px; cursor: pointer; transition: all 0.15s; position: relative;">\n                      ${e===s?'<span style="position: absolute; top: 4px; right: 4px; width: 6px; height: 6px; background: '+b+'; border-radius: 50%;"></span>':""}\n                      <span style="font-size: 11px; font-weight: ${e===s?"600":"500"}; color: ${e===s?b:"#6b7280"}; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;">${A(e)}</span>\n                    </button>\n                  `).join("")}\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n\n      </div>\n      \n      \x3c!-- Main Content Section --\x3e\n      <div style="padding: 20px 24px; overflow-y: auto; flex: 1;">\n        <p style="color: #6b7280; font-size: 14px; line-height: 1.6; margin: 0 0 20px 0;">\n          ${f.message}\n        </p>\n\n        \x3c!-- Verification Notice (Shown when not verified) --\x3e\n        <div id="dpdpa-verification-notice" style="display: ${"verified"===t?"none":"block"}; padding: 24px; text-align: center; background: #f8fafc; border-radius: 16px; border: 1px dashed #cbd5e1; margin-bottom: 20px;">\n            <div style="width: 48px; height: 48px; background: #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px auto;">\n                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>\n                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>\n                </svg>\n            </div>\n            <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600; color: ${i};">Verification Required</h3>\n            <p style="margin: 0; color: #64748b; font-size: 14px; line-height: 1.5;">\n                ${d.requireAgeVerification?"Please verify your age below to view and manage your consent preferences.":"Please verify your email below to view and manage your consent preferences."}\n            </p>\n        </div>\n\n        \x3c!-- Preferences Container (Hidden until verified) --\x3e\n        <div id="dpdpa-preferences-container" style="display: ${"verified"===t?"block":"none"}; animation: fadeIn 0.5s ease;">\n            \x3c!-- Processing Activities Table View - Enhanced Design --\x3e\n            <div style="margin-bottom: 20px;">\n          \x3c!-- Table Header --\x3e\n          \x3c!-- Consent Categories Header --\x3e\n          <div style="margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between;">\n            <h3 style="font-size: 11px; font-weight: 700; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; margin: 0;">CONSENT CATEGORIES</h3>\n          </div>\n\n          \n          \x3c!-- Table Body --\x3e\n          <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 12px;">\n            ${u.map(e=>{let t=[],n=[],o=!1;const r=d.mandatoryPurposes||[];return e.purposes&&Array.isArray(e.purposes)&&e.purposes.length>0&&e.purposes.forEach(e=>{n.push(e.purposeName||"Unknown Purpose"),(r.includes(e.purposeId)||r.includes(e.id))&&(o=!0),e.dataCategories&&Array.isArray(e.dataCategories)&&e.dataCategories.forEach(e=>{e.categoryName&&!t.includes(e.categoryName)&&t.push(e.categoryName)})}),0===t.length&&e.data_attributes&&Array.isArray(e.data_attributes)&&(t=e.data_attributes),0===t.length&&(t=["Personal Data"]),`\n              <div class="dpdpa-activity-item" data-activity-id="${e.id}" style="display: flex; gap: 16px; align-items: flex-start; padding: 16px; border: 1px solid ${o?b+"40":"#e5e7eb"}; border-radius: 12px; background: ${o?b+"08":"#ffffff"}; transition: all 0.2s ease; margin-bottom: 12px;">\n                \x3c!-- Checkbox --\x3e\n                <label style="display: flex; align-items: center; ${o?"cursor: not-allowed;":"cursor: pointer;"} padding-top: 2px;">\n                  <div class="custom-checkbox-wrapper" style="position: relative; width: 24px; height: 24px;">\n                    <input type="checkbox" class="activity-checkbox" data-activity-id="${e.id}" ${o?'checked disabled data-mandatory="true"':""} style="opacity: 0; position: absolute; width: 100%; height: 100%; cursor: ${o?"not-allowed":"pointer"}; z-index: 2;" />\n                    <div class="checkbox-visual" style="width: 24px; height: 24px; border: 2px solid ${o?b:"#d1d5db"}; border-radius: 6px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; background: ${o?b:"white"};">\n                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="opacity: ${o?"1":"0"}; transform: scale(${o?"1":"0.8"}); transition: all 0.2s;">\n                        <polyline points="20 6 9 17 4 12"></polyline>\n                      </svg>\n                    </div>\n                  </div>\n                </label>\n                \n                \x3c!-- Content --\x3e\n                <div style="flex: 1;">\n                  <div style="font-size: 15px; font-weight: 700; color: ${i}; margin-bottom: 6px; line-height: 1.3; display: flex; align-items: center; gap: 8px;">\n                    ${re(e.activity_name)}\n                    ${o?`<span style="font-size: 10px; font-weight: 600; color: ${b}; background: ${b}15; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Required</span>`:""}\n                  </div>\n                  \n                  <div style="font-size: 13px; color: #6b7280; line-height: 1.5;">\n                    <span style="color: #9ca3af;">Purpose:</span> ${n.length>0?re(n.join(", ")):re(e.activity_description||"Process data")}\n                  </div>\n                  <div style="font-size: 13px; color: #6b7280; line-height: 1.5; margin-top: 2px;">\n                    <span style="color: #9ca3af;">Data:</span> ${t.map(e=>re(e)).join(", ")}\n                  </div>\n                </div>\n                \n                <input type="hidden" class="activity-consent-status" data-activity-id="${e.id}" value="${o?"accepted":""}">\n              </div>\n            `}).join("")}\n          </div>\n        </div>\n\n        \x3c!-- Manage Preferences Button - Enhanced --\x3e\n        <div style="padding: 14px; background: linear-gradient(to right, #eff6ff, #e0f2fe); border-radius: 10px; margin-bottom: 16px; border: 1px solid #bfdbfe; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">\n          <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">\n            <div style="flex: 1;">\n              <p style="margin: 0 0 4px 0; font-size: 13px; color: #1e40af; font-weight: 600; line-height: 1.4;">\n                ${p.manageConsentPreferences}\n              </p>\n              <p style="margin: 0; font-size: 12px; color: #64748b; line-height: 1.4;">\n                ${p.changeSettingsAnytime}\n              </p>\n            </div>\n            <button id="dpdpa-manage-preferences" style="padding: 10px 18px; background: white; color: ${b}; border: 2px solid ${b}; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 700; transition: all 0.2s; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">\n              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">\n                <circle cx="12" cy="12" r="3"/>\n                <path d="M12 1v6m0 6v6M5.6 5.6l4.2 4.2m4.2 4.2l4.2 4.2M1 12h6m6 0h6M5.6 18.4l4.2-4.2m4.2-4.2l4.2-4.2"/>\n              </svg>\n              ${p.preferenceCentre}\n            </button>\n          </div>\n        </div>\n\n        \n      </div>\n\n      \x3c!--\n        AGE VERIFICATION IMPLEMENTATIONS:\n\n        There are TWO age verification implementations available:\n\n        1. DIGILOCKER AGE VERIFICATION (Recommended - DPDPA 2023 Compliant)\n           - Controlled by: config.requireAgeVerification\n           - Type: Government-backed OAuth flow via DigiLocker (API Setu)\n           - Process: Users verify age using government-issued ID documents (Aadhaar, PAN, etc.)\n           - Verification: Server-side cryptographic verification of government-issued documents\n           - Privacy: Only verified age is stored, date of birth is immediately discarded\n           - Guardian Consent: Supports guardian consent workflow for minors\n           - Compliance: Meets DPDPA 2023 "verifiable parental consent" requirements\n           - Status: Active and recommended for production use\n\n        2. LEGACY AGE GATE (Deprecated - Client-side only)\n           - Controlled by: config.enableAgeGate\n           - Type: Simple checkbox + year dropdown (client-side self-attestation)\n           - Process: User checks a box and selects birth year\n           - Verification: No verification - relies on user honesty\n           - Compliance: Not suitable for DPDPA 2023 compliance\n           - Status: Deprecated, maintained for backward compatibility only\n\n        PRIORITY ORDER:\n        - If config.requireAgeVerification is true, ONLY DigiLocker section is shown\n        - If config.requireAgeVerification is false AND config.enableAgeGate is true, legacy section is shown\n        - If both are false, no age verification is shown\n        - If both are true, only DigiLocker is used (legacy is ignored)\n\n        UI ORDER (when age verification is required):\n        - DigiLocker section is shown FIRST (above email) ‚Äî it is mandatory\n        - Email section is shown SECOND ‚Äî it is optional\n        - This matches the legal requirement: age must be established before consent is requested\n      --\x3e\n\n      \x3c!-- DigiLocker Age Verification Section (MUST appear before email when required) --\x3e\n      ${d.requireAgeVerification?`\n        <div id="dpdpa-digilocker-section" style="padding: 16px 24px; background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-top: 1px solid #a7f3d0; border-bottom: 1px solid #a7f3d0;">\n          <div style="display: flex; align-items: flex-start; gap: 12px;">\n            <div style="padding: 8px; background: #10b981; border-radius: 10px; flex-shrink: 0;">\n              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">\n                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>\n              </svg>\n            </div>\n            <div style="flex: 1;">\n              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">\n                <span style="font-size: 14px; color: #065f46; font-weight: 700;">${p.digilockerVerification}</span>\n                <span style="font-size: 10px; font-weight: 700; color: #dc2626; background: #fef2f2; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px; border: 1px solid #fecaca;">Required</span>\n              </div>\n              <span style="font-size: 13px; color: #047857; line-height: 1.5; display: block; margin-bottom: 4px;">\n                ${p.digilockerDescription} (${d.ageVerificationThreshold||18}+ years)\n              </span>\n              <span style="font-size: 11px; color: #6b7280; line-height: 1.4; display: block; margin-bottom: 12px;">\n                Age verification is required before consent can be recorded. No personal data is stored.\n              </span>\n              <div id="dpdpa-digilocker-status" style="margin-bottom: 12px;"></div>\n              <button id="dpdpa-digilocker-verify-btn" type="button" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: ${b}; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px ${b}40;">\n                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>\n                </svg>\n                ${p.verifyWithDigilocker}\n              </button>\n              \x3c!-- Guardian Consent Section (hidden by default) --\x3e\n              <div id="dpdpa-guardian-section" style="display: none; margin-top: 16px; padding: 16px; background: #fffbeb; border-radius: 8px; border: 1px solid #fef3c7;">\n                <label style="display: block; font-size: 13px; color: #92400e; font-weight: 600; margin-bottom: 8px;">${p.guardianEmail}</label>\n                <div style="display: flex; gap: 8px; flex-wrap: wrap;">\n                  <input type="email" id="dpdpa-guardian-email" placeholder="${p.guardianEmailPlaceholder}" style="flex: 1; min-width: 200px; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;" />\n                  <button id="dpdpa-guardian-send-btn" type="button" style="padding: 10px 16px; background: #f59e0b; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap;">\n                    ${p.sendConsentRequest}\n                  </button>\n                </div>\n                <div id="dpdpa-guardian-status" style="margin-top: 8px; font-size: 12px; color: #6b7280;"></div>\n              </div>\n            </div>\n          </div>\n          <div id="dpdpa-digilocker-error" style="color: #dc2626; margin-top: 8px; font-size: 12px; display: none; font-weight: 600;"></div>\n        </div>\n      `:""}\n\n      \x3c!-- Secure This Consent Section --\x3e\n      <div class="dpdpa-secure-section" style="padding: 24px; background: linear-gradient(to right, #f8fafc, #f1f5f9); border-top: 1px solid rgba(0,0,0,0.05); border-bottom: 1px solid rgba(0,0,0,0.05);">\n        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">\n          <div style="width: 24px; height: 24px; background: ${b}15; border-radius: 6px; display: flex; align-items: center; justify-content: center;">\n            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="${b}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">\n              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>\n              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>\n            </svg>\n          </div>\n          <h3 style="margin: 0; font-size: 15px; font-weight: 700; color: ${i};">\n            Secure This Consent\n          </h3>\n          ${d.requireAgeVerification?'\n            <span style="font-size: 10px; font-weight: 600; color: #6b7280; background: #f3f4f6; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Optional</span>\n          ':""}\n        </div>\n        <p style="margin: 0 0 16px 0; font-size: 12px; color: #6b7280; line-height: 1.5;">\n          ${"verified"===t?`We've sent a code to <strong style="color:${b}">${re(e)}</strong> to manage your consents.`:`We'll send a code to ${e?`<strong style="color:${b}">${re(e)}</strong>`:"your email"} to manage all your consents.`}\n        </p>\n\n        <div class="dpdpa-secure-flex" style="display: flex; gap: 10px; align-items: center;">\n          ${"verified"===t?`\n            \x3c!-- OTP Input for Verified User --\x3e\n            <div class="dpdpa-secure-input-group dpdpa-otp-section" style="display: flex; gap: 12px; flex: 1; align-items: flex-start; flex-wrap: wrap;">\n              <div class="dpdpa-otp-input-wrapper" style="flex: 1; min-width: 180px; position: relative;">\n                 <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="6" autocomplete="one-time-code" id="dpdpa-otp-input" placeholder="000000" style="width: 100%; padding: 14px 12px; border: 2px solid ${b}40; border-radius: 12px; font-size: 24px; outline: none; transition: all 0.2s; text-align: center; letter-spacing: 0.5em; font-family: 'SF Mono', 'Menlo', 'Monaco', 'Courier New', monospace; font-weight: 700; background: linear-gradient(to right, ${b}05, ${b}10); color: ${i}; box-sizing: border-box;" onfocus="this.style.borderColor='${b}'; this.style.boxShadow='0 0 0 3px ${b}20';" onblur="this.style.borderColor='${b}40'; this.style.boxShadow='none';" />\n              </div>\n              <div class="dpdpa-otp-actions" style="display: flex; flex-direction: column; gap: 6px; flex-shrink: 0;">\n                <button id="dpdpa-resend-btn" style="background: none; border: none; color: ${b}; font-weight: 600; font-size: 13px; cursor: pointer; padding: 4px 0; white-space: nowrap; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">‚Üª Resend Code</button>\n                <button id="dpdpa-change-email-btn" style="background: none; border: none; color: #64748b; font-weight: 500; font-size: 12px; cursor: pointer; padding: 4px 0; white-space: nowrap; text-decoration: underline; transition: color 0.2s;" onmouseover="this.style.color='${b}'" onmouseout="this.style.color='#64748b'">Change Email</button>\n              </div>\n              <button id="dpdpa-verify-btn" style="display: none;">Sync</button>\n            </div>\n          `:`\n            \x3c!-- Email Input for New User --\x3e\n            <div class="dpdpa-secure-input-group" style="display: flex; gap: 8px; flex: 1;">\n              <input type="email" id="dpdpa-email-input" value="${re(e||"")}" placeholder="name@example.com" style="flex: 1; padding: 12px 16px; border: ${e?`2px solid ${b}`:"1px solid #cbd5e1"}; border-radius: 12px; font-size: 14px; outline: none; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); ${e?`background: linear-gradient(to right, ${b}08, transparent);`:"background: white;"}" />\n              <button id="dpdpa-send-code-btn" style="padding: 10px 20px; background: ${e?`linear-gradient(135deg, ${b}, ${b}dd)`:"white"}; color: ${e?"white":i}; border: ${e?"none":"1px solid #cbd5e1"}; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 13px; white-space: nowrap; box-shadow: ${e?`0 4px 12px ${b}40`:"0 1px 2px rgba(0,0,0,0.05)"}; transition: all 0.2s;">\n                ${e?"‚úì Send Code":"Send Code"}\n              </button>\n            </div>\n          `}\n        </div>\n      </div>\n      \n      \x3c!-- Footer Links --\x3e\n      <div style="padding: 12px 24px; background: #ffffff; margin-bottom: 0;">\n          <p style="margin: 0 0 8px 0; font-size: 13px; color: #6b7280; line-height: 1.5;">\n            ${p.grievanceText.replace("{here}",`<a href="#" id="dpdpa-grievance-link" style="color: ${b}; text-decoration: underline; font-weight: 500;">${p.here}</a>`).replace("{here2}",`<a href="#" id="dpdpa-dpb-link" style="color: ${b}; text-decoration: underline; font-weight: 500;">${p.here}</a>`)}\n          </p>\n        </div>\n      </div>\n\n      \x3c!-- Legacy Age Gate Section (Integrated Checkbox) - Only if DigiLocker not enabled --\x3e\n      ${!d.requireAgeVerification&&d.enableAgeGate?`\n        <div style="padding: 16px 24px; background: #fffbeb; border-top: 1px solid #fef3c7; border-bottom: 1px solid #fef3c7;">\n          <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer;">\n            <input type="checkbox" id="dpdpa-age-checkbox" style="width: 20px; height: 20px; margin-top: 2px; accent-color: ${b};" />\n            <div style="flex: 1;">\n              <span style="font-size: 14px; color: #92400e; font-weight: 700; display: block; margin-bottom: 4px;">Age Verification</span>\n              <span style="font-size: 13px; color: #b45309; line-height: 1.5; display: block;">\n                I confirm I am above ${d.ageGateThreshold||18} years old.\n                <span style="display:block;margin-top:6px;">Year of birth:\n                <select id="dpdpa-age-birthyear-integrated" style="margin-left: 4px; padding: 4px 8px; border-radius: 6px; border: 1px solid #d1d5db; font-size: 12px; vertical-align: middle;">\n                   ${H()}\n                </select>\n                </span>\n              </span>\n            </div>\n          </label>\n          <div id="age-gate-err-msg-main" style="color: #dc2626; margin-top: 8px; font-size: 12px; display: none; font-weight: 600;">Please verify your age to continue.</div>\n        </div>\n      `:""}\n\n      \x3c!-- Footer Actions --\x3e\n      <div class="dpdpa-footer-actions" style="padding: 20px 24px; border-top: 1px solid rgba(0,0,0,0.05); background: #ffffff; display: flex; justify-content: center; border-radius: 0 0 24px 24px;">\n        <button id="dpdpa-confirm-btn" style="width: 100%; max-width: 100%; padding: 16px 24px; background: linear-gradient(135deg, ${b}, ${b}dd); color: white; border: none; border-radius: 14px; cursor: pointer; font-size: 16px; font-weight: 700; transition: all 0.2s; box-shadow: 0 8px 20px -4px ${b}50; display: flex; align-items: center; justify-content: center; letter-spacing: 0.5px;">\n          Confirm & Submit\n        </button>\n      </div>\n      \n      \x3c!-- Powered by Consently --\x3e\n      ${!1!==d.showBranding?`\n        <div style="padding: 8px 24px; text-align: center; border-top: 1px solid #e5e7eb; background: #fafbfc;">\n          <p style="margin: 0; font-size: 11px; color: #9ca3af;">\n            ${p.poweredBy} <a href="https://consently.in" target="_blank" style="color: ${b}; font-weight: 600; text-decoration: none;">Consently</a>\n          </p>\n        </div>\n      `:""}\n      <style>\n        @media (max-width: 640px) {\n          #consently-dpdpa-widget {\n            width: 100% !important;\n            max-width: 100% !important;\n            height: auto !important;\n            max-height: 85vh !important;\n            border-radius: 20px 20px 0 0 !important;\n            margin: 0 !important;\n            transform: none !important;\n          }\n          \n          #consently-dpdpa-overlay {\n             align-items: flex-end !important;\n             padding: 0 !important;\n          }\n\n          .dpdpa-secure-flex {\n            flex-direction: column !important;\n            align-items: stretch !important;\n            gap: 12px !important;\n          }\n          \n          .dpdpa-secure-input-group {\n            width: 100% !important;\n          }\n          \n          /* OTP Input Mobile Optimization */\n          .dpdpa-otp-section {\n            flex-direction: column !important;\n            align-items: stretch !important;\n            gap: 12px !important;\n          }\n          \n          .dpdpa-otp-input-wrapper {\n            width: 100% !important;\n            min-width: unset !important;\n          }\n          \n          #dpdpa-otp-input {\n            font-size: 28px !important;\n            padding: 16px 8px !important;\n            letter-spacing: 0.4em !important;\n          }\n          \n          .dpdpa-otp-actions {\n            flex-direction: row !important;\n            justify-content: center !important;\n            gap: 16px !important;\n          }\n          \n          /* Make email input and button stack on very small screens if needed */\n          @media (max-width: 380px) {\n             .dpdpa-secure-input-group {\n                flex-direction: column !important;\n             }\n             #dpdpa-send-code-btn {\n                width: 100% !important;\n             }\n             #dpdpa-otp-input {\n               font-size: 24px !important;\n               letter-spacing: 0.35em !important;\n             }\n          }\n\n          .dpdpa-footer-actions {\n             padding: 16px !important;\n          }\n        }\n      </style>\n    `}function A(e){return{en:"English",hi:"‡§π‡§ø‡§Ç‡§¶‡•Ä",pa:"‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä",te:"‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å",ta:"‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç",bn:"‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ",mr:"‡§Æ‡§∞‡§æ‡§†‡•Ä",gu:"‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä",kn:"‡≤ï‡≤®‡≥ç‡≤®‡≤°",ml:"‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç",or:"‡¨ì‡¨°‡¨º‡¨ø‡¨Ü",ur:"ÿßÿ±ÿØŸà",as:"‡¶Ö‡¶∏‡¶Æ‡ßÄ‡¶Ø‡¶º‡¶æ"}[e]||e}function k(){const e=D.querySelector("#dpdpa-lang-btn"),t=D.querySelector("#dpdpa-lang-menu");e&&t&&(e.addEventListener("mouseenter",()=>{e.style.boxShadow="0 4px 8px rgba(59,130,246,0.4)",e.style.transform="translateY(-1px)"}),e.addEventListener("mouseleave",()=>{e.style.boxShadow="0 2px 4px rgba(59,130,246,0.3)",e.style.transform="translateY(0)"}),e.addEventListener("click",e=>{e.stopPropagation(),t.style.display="none"!==t.style.display&&t.style.display?"none":"block"}),v=n=>{e.contains(n.target)||t.contains(n.target)||(t.style.display="none")},document.addEventListener("click",v),t.querySelectorAll("button[data-lang]").forEach(e=>{e.addEventListener("mouseenter",()=>{e.getAttribute("data-lang")!==s&&(e.style.background="#f0f9ff")}),e.addEventListener("mouseleave",()=>{e.getAttribute("data-lang")!==s&&(e.style.background="#fff")}),e.addEventListener("click",async()=>{s=e.getAttribute("data-lang"),t.style.display="none",await async function(){if(g)return void console.log("[Consently DPDPA] Translation already in progress, ignoring request");g=!0;const e=document.createElement("div");e.id="consently-dpdpa-loading-overlay",e.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(255, 255, 255, 0.98);\n        backdrop-filter: blur(8px);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        z-index: 999999;\n        pointer-events: all;\n      ",e.innerHTML=`\n        <div style="display: flex; flex-direction: column; align-items: center; gap: 12px;">\n          <div style="width: 32px; height: 32px; border: 3px solid ${b}30; border-top-color: ${b}; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>\n          <span style="font-size: 13px; color: ${i}; font-weight: 500; opacity: 0.8;">Translating...</span>\n        </div>\n        <style>\n          @keyframes spin {\n            to { transform: rotate(360deg); }\n          }\n        </style>\n      `,document.body.appendChild(e);try{if(v&&(document.removeEventListener("click",v),v=null),p=await c(s),"en"===s)f={title:d.title||"Your Data Privacy Rights",message:d.message||"We process your personal data with your consent. Please review the activities below and choose your preferences.",acceptButtonText:d.acceptButtonText||"Accept All",rejectButtonText:d.rejectButtonText||"Reject All",customizeButtonText:d.customizeButtonText||"Manage Preferences"},u=JSON.parse(JSON.stringify(y));else{const e=JSON.parse(JSON.stringify(y)),t=[d.title||"Your Data Privacy Rights",d.message||"We process your personal data with your consent. Please review the activities below and choose your preferences.",d.acceptButtonText||"Accept All",d.rejectButtonText||"Reject All",d.customizeButtonText||"Manage Preferences",...e.map(e=>e.activity_name),...e.flatMap(e=>e.purposes&&Array.isArray(e.purposes)&&e.purposes.length>0?e.purposes.flatMap(e=>[e.purposeName||"",...(e.dataCategories||[]).map(e=>e.categoryName||"")]).filter(Boolean):e.data_attributes||[])],n=await l(t,s);let o=0;f={title:n[o++],message:n[o++],acceptButtonText:n[o++],rejectButtonText:n[o++],customizeButtonText:n[o++]};const i=e.map(e=>{const t=n[o++];if(e.purposes&&Array.isArray(e.purposes)&&e.purposes.length>0){const i=e.purposes.map(e=>{const t=n[o++],i=(e.dataCategories||[]).map(()=>n[o++]);return{...e,purposeName:t,dataCategories:e.dataCategories.map((e,t)=>({...e,categoryName:i[t]||e.categoryName}))}});return{...e,activity_name:t,purposes:i}}{const i=(e.data_attributes||[]).map(()=>n[o++]);return{...e,activity_name:t,data_attributes:i}}});u=i}D.innerHTML=C(),te(P,D),k()}catch(e){console.error("[Consently DPDPA] Translation error:",e),D.innerHTML=C(),te(P,D),k()}finally{const e=document.getElementById("consently-dpdpa-loading-overlay");e&&e.remove(),g=!1}}()})}))}D.id="consently-dpdpa-widget",D.style.cssText=`\n      position: relative;\n      background: ${"#ffffff"===o?"rgba(255, 255, 255, 0.95)":o};\n      color: ${i};\n      font-family: ${r};\n      font-size: ${a}px;\n      border-radius: 24px;\n      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 255, 255, 0.1);\n      backdrop-filter: blur(12px);\n      -webkit-backdrop-filter: blur(12px);\n      max-width: 760px;\n      max-height: 90vh;\n      width: 92%;\n      overflow: hidden;\n      display: flex;\n      flex-direction: column;\n      transform: scale(0.9);\n      opacity: 0;\n      transition: all 0.3s ease;\n    `,D.innerHTML=C(),P.appendChild(D),document.body.appendChild(P),requestAnimationFrame(()=>{P.style.opacity="1",D.style.transform="scale(1)",D.style.opacity="1"}),te(P,D),k()}function te(e,n){const o=d.theme||{},r=o.textColor||"#1f2937",a=o.primaryColor||b,l=n.querySelector("#dpdpa-send-code-btn");l&&l.addEventListener("click",async()=>{const t=n.querySelector("#dpdpa-email-input"),o=t?t.value:null;if(!o||!o.includes("@"))return void alert("Please enter a valid email address");const c=l.textContent;l.textContent="Sending...",l.disabled=!0;try{const t=s();if((await fetch(`${t}/api/privacy-centre/send-otp`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:o,visitorId:y||N(),widgetId:i})})).ok){n.querySelector("#dpdpa-email-input").closest("div").parentElement.innerHTML=`\n                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">\n                      <div style="width: 36px; height: 36px; background: linear-gradient(135deg, ${a}20, ${a}10); border-radius: 10px; display: flex; align-items: center; justify-content: center;">\n                        <span style="font-size: 18px;">üìß</span>\n                      </div>\n                      <div>\n                        <h3 style="margin: 0; font-size: 15px; font-weight: 700; color: ${r};">Enter Verification Code</h3>\n                        <p style="margin: 2px 0 0 0; font-size: 11px; color: #6b7280;">Sent to <strong style="color:${a}">${re(o)}</strong></p>\n                      </div>\n                    </div>\n                    <div class="dpdpa-otp-section" style="display: flex; gap: 12px; flex: 1; align-items: center; flex-wrap: wrap;">\n                        <div class="dpdpa-otp-input-wrapper" style="flex: 1; min-width: 160px; position: relative;">\n                            <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="6" autocomplete="one-time-code" id="dpdpa-otp-input" placeholder="000000" style="width: 100%; padding: 14px 12px; border: 2px solid ${a}40; border-radius: 12px; font-size: 24px; outline: none; transition: all 0.2s; text-align: center; letter-spacing: 0.5em; font-family: 'SF Mono', 'Menlo', 'Monaco', 'Courier New', monospace; font-weight: 700; background: linear-gradient(to right, ${a}05, ${a}10); color: ${r}; box-sizing: border-box;" />\n                        </div>\n                        <button id="dpdpa-resend-btn" style="background: ${a}10; border: 1px solid ${a}30; color: ${a}; font-weight: 600; font-size: 12px; cursor: pointer; padding: 10px 14px; white-space: nowrap; border-radius: 8px; transition: all 0.2s;">‚Üª Resend</button>\n                    </div>\n                    <p style="margin: 12px 0 0 0; font-size: 11px; color: #9ca3af; text-align: center;">Code expires in 10 minutes</p>\n                `,te(e,n),h=o}else alert("Failed to send code. Please try again."),l.textContent=c,l.disabled=!1}catch(e){console.error("Send OTP error",e),alert("Error sending code"),l.textContent=c,l.disabled=!1}});const p=n.querySelector("#dpdpa-change-email-btn");p&&p.addEventListener("click",()=>{const e=document.getElementById("consently-dpdpa-overlay");e&&e.remove(),ee(null,"new")});const v=n.querySelector("#dpdpa-resend-btn");v&&v.addEventListener("click",async()=>{if(h){v.textContent="Sending...",v.disabled=!0;try{const e=s();await fetch(`${e}/api/privacy-centre/send-otp`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:h,visitorId:y||N(),widgetId:i})}),v.textContent="Sent!",setTimeout(()=>{v.textContent="[ Resend Code ]",v.disabled=!1},3e3)}catch(e){v.textContent="Error",setTimeout(()=>{v.textContent="[ Resend Code ]",v.disabled=!1},3e3)}}});const C=n.querySelector("#dpdpa-verify-btn");C&&C.addEventListener("click",async()=>{const e=n.querySelector("#dpdpa-otp-input"),t=e?e.value:null;if(!t||t.length<4)alert("Please enter a valid code");else if(!x){x=!0,C.textContent="Verifying...",C.disabled=!0;try{const e=s(),o=await fetch(`${e}/api/privacy-centre/verify-otp`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:h||m,otpCode:t,visitorId:y||N(),widgetId:i})});if(o.ok){const e=await o.json();f=h||m,e.stableConsentId&&e.stableConsentId!==y&&(console.log("[Consently DPDPA] Switching to stable Consent ID:",e.stableConsentId),y=e.stableConsentId,M(y));const t=n.querySelector("#dpdpa-preferences-container"),i=n.querySelector("#dpdpa-verification-notice");t&&(t.style.display="block"),i&&(i.style.display="none");const r=n.querySelector("#dpdpa-confirm-btn");r&&(r.textContent="Save Preferences",r.disabled=!1),C.textContent="Verified"}else alert("Invalid Verification Code"),C.textContent="Verify",C.disabled=!1}catch(e){console.error("Verification error",e),alert("Verification failed"),C.textContent="Verify",C.disabled=!1}finally{x=!1}}});const k=n.querySelector("#dpdpa-digilocker-verify-btn");if(k){k.textContent;k.addEventListener("click",async()=>{const e=n.querySelector("#dpdpa-digilocker-error");try{k.textContent="Verifying...",k.disabled=!0,await T(window.location.href)}catch(t){console.error("[Consently DPDPA] DigiLocker verification error:",t),e&&(e.textContent=t.message||"Verification failed. Please try again.",e.style.display="block"),k.textContent="Retry Verification",k.disabled=!1}}),(E()||P)&&c(d&&d.language?d.language:"en").then(e=>{L(n,e)})}const S=n.querySelector("#dpdpa-guardian-send-btn");S&&S.addEventListener("click",async()=>{const e=n.querySelector("#dpdpa-guardian-email"),t=n.querySelector("#dpdpa-guardian-status"),o=e?e.value.trim():"";if(o&&o.includes("@"))try{S.textContent="Sending...",S.disabled=!0,await async function(e,t,n="parent"){try{const o=s(),i=await fetch(`${o}/api/dpdpa/age-verification/guardian-consent`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:e,guardianEmail:t,relationship:n})});if(!i.ok){const e=await i.json();throw new Error(e.error||"Failed to request guardian consent")}const r=await i.json();return D="sent",r}catch(e){throw console.error("[Consently DPDPA] Error requesting guardian consent:",e),e}}(w,o),t&&(t.textContent="Consent request sent to guardian",t.style.color="#059669"),S.textContent="Waiting for approval...",R(w,e=>{c(d&&d.language?d.language:"en").then(o=>{"approved"===e.status?(t&&(t.textContent="Guardian consent approved!",t.style.color="#059669"),L(n,o)):"rejected"===e.status&&(t&&(t.textContent="Guardian consent was denied",t.style.color="#dc2626"),L(n,o))})})}catch(e){console.error("[Consently DPDPA] Guardian consent error:",e),t&&(t.textContent=e.message||"Failed to send consent request",t.style.color="#dc2626"),S.textContent="Send Consent Request",S.disabled=!1}else t&&(t.textContent="Please enter a valid email address",t.style.color="#dc2626")});n.querySelectorAll(".activity-checkbox").forEach(e=>{e.addEventListener("change",function(e){const t=this.getAttribute("data-activity-id"),n=this.closest(".dpdpa-activity-item"),o=this.parentElement.querySelector(".checkbox-visual"),i=o?.querySelector("svg"),r=u.find(e=>e.id===t),a=r?.activity_name||"this activity";if(this.checked){ne(t,"accepted"),n.style.borderColor=b,n.style.borderWidth="2px",n.style.background="#f0f9ff",n.style.boxShadow="0 4px 12px rgba(59,130,246,0.25)",n.style.borderLeftWidth="4px",o&&(o.style.background=b,o.style.borderColor=b),i&&(i.style.opacity="1",i.style.transform="scale(1)");const e=n.querySelector(".revocation-warning");e&&e.remove()}else{if(!confirm(`‚ö†Ô∏è Withdraw Consent?\n\nYou are about to withdraw your consent for "${a}".\n\nThis may affect:\n‚Ä¢ Your personalized experience on this website\n‚Ä¢ Features that rely on this data processing\n‚Ä¢ Services that require your consent to function\n\nUnder DPDPA 2023, you have the right to withdraw consent at any time.\n\nClick OK to withdraw consent, or Cancel to keep it.`))return e.preventDefault(),void(this.checked=!0);ne(t,"rejected"),n.style.borderColor="#e5e7eb",n.style.borderWidth="1px",n.style.background="white",n.style.boxShadow="0 1px 3px rgba(0,0,0,0.05)",n.style.borderLeftWidth="2px",o&&(o.style.background="white",o.style.borderColor="#d1d5db"),i&&(i.style.opacity="0",i.style.transform="scale(0.8)")}})}),function(e){try{Object.keys(g).length>0&&(e.querySelectorAll(".activity-checkbox").forEach(function(e){const t=e.getAttribute("data-activity-id");if(g[t]){const n="accepted"===g[t].status;if(e.checked!==n){e.checked=n;const t=e.closest(".dpdpa-activity-item"),o=e.parentElement?e.parentElement.querySelector(".checkbox-visual"):null,i=o?o.querySelector("svg"):null;n&&t&&(t.style.borderColor=b,t.style.borderWidth="2px",t.style.background="#f0f9ff",t.style.boxShadow="0 4px 12px rgba(59,130,246,0.25)",t.style.borderLeftWidth="4px",o&&(o.style.background=b,o.style.borderColor=b),i&&(i.style.opacity="1",i.style.transform="scale(1)"))}}}),console.log("[Consently DPDPA] Restored checkbox states from saved state")),h&&e.querySelectorAll('input[type="email"]').forEach(function(e){e.value||(e.value=h)})}catch(e){console.error("[Consently DPDPA] Error applying restored state to DOM:",e)}}(n);const I=n.querySelector("#dpdpa-confirm-btn");if(I&&(I.addEventListener("click",async()=>{if(d.requireAgeVerification){const o=n.querySelector("#dpdpa-digilocker-error");if("blocked_minor"===A)return e&&e.remove(),void J();if("guardian_required"===A){o&&(o.textContent=t.guardianConsentMessage||"Guardian consent is required to proceed.",o.style.display="block");const e=n.querySelector("#dpdpa-digilocker-section");return void(e&&e.scrollIntoView({behavior:"smooth",block:"center"}))}if(!(A&&["verified_adult","guardian_approved","limited_access"].includes(A))&&"verified"!==P){o&&(o.textContent="requires_guardian"===P?t.guardianConsentMessage||"Guardian consent is required to proceed.":t.ageVerificationRequired||"Please verify your age to continue.",o.style.display="block");const e=n.querySelector("#dpdpa-digilocker-section");return void(e&&e.scrollIntoView({behavior:"smooth",block:"center"}))}if("rejected"===P)return e&&e.remove(),void J();o&&(o.style.display="none")}if(!d.requireAgeVerification&&d.enableAgeGate){const t=n.querySelector("#dpdpa-age-checkbox"),o=n.querySelector("#dpdpa-age-birthyear-integrated"),i=n.querySelector("#age-gate-err-msg-main");if(t&&!t.checked)return void(i&&(i.style.display="block"));if(o){const t=o.value;if(!t)return void(i&&(i.textContent="Please select your year of birth",i.style.display="block"));if(_(t)<(d.ageGateThreshold||18))return $(),e&&e.remove(),void J()}i&&(i.style.display="none")}if(f)return console.log("[Consently DPDPA] Email verified, saving preferences..."),void async function(e){if(!u||0===u.length)return console.error("[Consently DPDPA] No activities available to consent to"),void alert("No activities available. Please contact the website administrator.");const t=document.querySelectorAll(".activity-checkbox:checked");if(0===t.length)return void alert("Please select at least one activity");u.forEach(e=>{const t=document.querySelector(`.activity-checkbox[data-activity-id="${e.id}"]`);t&&t.checked?ne(e.id,"accepted"):ne(e.id,"rejected")}),await oe("partial",e)}(e);const o=n.querySelector("#dpdpa-otp-input"),r=o?o.value.replace(/\s/g,""):null,a=h||m;if(r&&r.length>=4){if(x)return;x=!0;const e=I.textContent;I.textContent="Verifying...",I.disabled=!0;try{const t=s(),o=await fetch(`${t}/api/privacy-centre/verify-otp`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a,otpCode:r,visitorId:y||N(),widgetId:i})});if(o.ok){const e=await o.json();f=a,e.stableConsentId&&e.stableConsentId!==y&&(console.log("[Consently DPDPA] Switching to stable Consent ID:",e.stableConsentId),y=e.stableConsentId,M(y));const t=n.querySelector("#dpdpa-preferences-container"),i=n.querySelector("#dpdpa-verification-notice");t&&(t.style.display="block"),i&&(i.style.display="none"),I.textContent="Save Preferences",I.disabled=!1,t&&t.scrollIntoView({behavior:"smooth"})}else alert("Invalid Verification Code"),I.textContent=e,I.disabled=!1}catch(t){console.error("Verification error",t),alert("Verification failed. Please try again."),I.textContent=e,I.disabled=!1}finally{x=!1}}else{alert("Please verify your email to manage your consent preferences.");const e=n.querySelector("#dpdpa-email-input");e&&(e.focus(),e.style.borderColor="#ef4444",setTimeout(()=>{e.style.borderColor="#cbd5e1"},2e3))}}),I.addEventListener("mouseenter",()=>{I.style.transform="translateY(-2px)",I.style.boxShadow="0 6px 16px rgba(59,130,246,0.5)"}),I.addEventListener("mouseleave",()=>{I.style.transform="translateY(0)",I.style.boxShadow="0 4px 12px rgba(59,130,246,0.3)"}),d.enableAgeGate)){const t=n.querySelector("#dpdpa-age-birthyear-integrated");t&&t.addEventListener("change",()=>{_(t.value)<(d.ageGateThreshold||18)&&($(),e&&e.remove(),J())})}const j=n.querySelector("#dpdpa-grievance-link");j&&j.addEventListener("click",e=>{e.preventDefault(),function(){const e=y||N(),t=window.location.origin+"/privacy-centre/"+i+"/grievance?visitorId="+e;window.open(t,"_blank")}()});const z=n.querySelector("#dpdpa-dpb-link");z&&z.addEventListener("click",e=>{e.preventDefault(),window.open("https://dataprotection.gov.in","_blank")});const q=n.querySelector("#dpdpa-manage-preferences");q&&(q.addEventListener("mouseenter",()=>{q.style.background=b,q.style.color="white",q.style.transform="translateY(-2px)",q.style.boxShadow="0 6px 12px rgba(59,130,246,0.4)"}),q.addEventListener("mouseleave",()=>{q.style.background="white",q.style.color=b,q.style.transform="translateY(0)",q.style.boxShadow="0 2px 4px rgba(0,0,0,0.08)"}),q.addEventListener("click",()=>{se()}));n.querySelectorAll(".dpdpa-activity-item").forEach(e=>{e.addEventListener("mouseenter",()=>{e.style.borderColor=b,e.style.boxShadow="0 4px 12px rgba(59,130,246,0.15)",e.style.transform="translateX(2px)",e.style.background="linear-gradient(to bottom, #f0f9ff, #e0f2fe)"}),e.addEventListener("mouseleave",()=>{e.querySelector(".activity-checkbox").checked||(e.style.borderColor="#e5e7eb",e.style.boxShadow="0 1px 3px rgba(0,0,0,0.05)",e.style.transform="translateX(0)",e.style.background="linear-gradient(to bottom, #ffffff, #fafbfc)")})})}function ne(e,t){g[e]={status:t,timestamp:(new Date).toISOString()}}async function oe(e,t){if(!u||0===u.length)return console.error("[Consently DPDPA] Cannot save consent: No activities available"),void alert("Cannot save consent. No activities available. Please contact the website administrator.");const n=[],r=[],a={},s={};let l;if(Object.keys(g).forEach(e=>{const t=u.find(t=>t.id===e);"accepted"===g[e].status?(n.push(e),t&&t.purposes&&Array.isArray(t.purposes)&&(a[e]=t.purposes.map(e=>e.purposeId||e.id).filter(e=>e))):"rejected"===g[e].status&&(r.push(e),t&&t.purposes&&Array.isArray(t.purposes)&&(s[e]=t.purposes.map(e=>e.purposeId||e.id).filter(e=>e)))}),n.length>0&&r.length>0)l="partial";else if(n.length>0)l="accepted";else{if(!(r.length>0))return console.error("[Consently DPDPA] No activities consented or rejected"),void alert("Please select at least one activity to save your preferences.");l="rejected"}const c=d._matchedRule?{ruleId:d._matchedRule.id,ruleName:d._matchedRule.rule_name,urlPattern:d._matchedRule.url_pattern,pageUrl:window.location.pathname}:void 0;y||(y=N());const p={widgetId:i,visitorId:y,consentStatus:l,acceptedActivities:n,ruleContext:c,rejectedActivities:r,activityConsents:g,visitorEmail:f||void 0,acceptedPurposeConsents:Object.keys(a).length>0?a:void 0,rejectedPurposeConsents:Object.keys(s).length>0?s:void 0,activityPurposeConsents:Object.keys(a).length>0?a:void 0,metadata:{language:navigator.language||"en",referrer:document.referrer||null,currentUrl:window.location.href,pageTitle:document.title},consentDuration:d.consentDuration||365};try{const e=await G(p);M(y);const a={status:l,acceptedActivities:n,rejectedActivities:r,activityConsents:g,timestamp:(new Date).toISOString(),expiresAt:e.expiresAt,verifiedEmail:f};k.set(`consently_dpdpa_consent_${i}`,a,d.consentDuration||365),Q(a),async function(e,t){try{const n=o.src;let r;try{r=n&&n.includes("http")?new URL(n).origin:window.location.origin}catch(e){console.error("[Consently DPDPA] Error parsing script URL:",e),r=window.location.origin}const a=`${r}/api/dpdpa/analytics/consent`,s=navigator.userAgent||"",l=/mobile|iphone|ipod|blackberry|windows phone|android.*mobile/i.test(s)?"Mobile":/tablet|ipad|playbook|silk|android(?!.*mobi)/i.test(s)?"Tablet":"Desktop",c={widgetId:i,visitorId:y||N(),ruleId:t?t.id:void 0,ruleName:t?t.rule_name:void 0,consentStatus:e.consentStatus,acceptedActivities:e.acceptedActivities||[],rejectedActivities:e.rejectedActivities||[],consentedAt:(new Date).toISOString(),userAgent:s,deviceType:l,language:navigator.language||"en",country:void 0};fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c),keepalive:!0}).catch(e=>{console.error("[Consently DPDPA] Failed to track consent event:",e)}),console.log("[Consently DPDPA] Consent event tracked:",e.consentStatus)}catch(e){console.error("[Consently DPDPA] Error tracking consent event:",e)}}(p,d._matchedRule||null),function(){if(document.getElementById("dpdpa-floating-btn"))return;const e=document.createElement("button");e.id="dpdpa-floating-btn",e.title="Manage Privacy Preferences",e.style.cssText="position: fixed; bottom: 20px; left: 20px; width: 50px; height: 50px; border-radius: 50%; background: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer; z-index: 999997; display: flex; align-items: center; justify-content: center; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);",e.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="'+b+'" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>',e.addEventListener("click",()=>{ee()}),e.addEventListener("mouseenter",()=>{e.style.transform="scale(1.1)",e.style.boxShadow="0 6px 16px rgba(0,0,0,0.2)"}),e.addEventListener("mouseleave",()=>{e.style.transform="scale(1)",e.style.boxShadow="0 4px 12px rgba(0,0,0,0.15)"}),document.body.appendChild(e)}(),ie(t),function(e){const t=document.createElement("div");t.id="dpdpa-success-modal",t.style.cssText="\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      z-index: 999999;\n      padding: 16px;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      pointer-events: none;\n    ";const n=f,o=n||e,i=n?"Your Verified Email":"Your Consent ID",r=n?'<svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n           <path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n         </svg>':'<svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n           <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n         </svg>';t.innerHTML=`\n      <div style="background:white;border-radius:16px;padding:28px;max-width:480px;width:100%;box-shadow:0 20px 50px rgba(0,0,0,0.3);text-align:center;animation:slideUp 0.3s ease-out;pointer-events: auto;">\n        \x3c!-- Success Icon --\x3e\n        <div style="width:56px;height:56px;background:linear-gradient(135deg, #10b981 0%, #059669 100%);border-radius:50%;display:inline-flex;align-items:center;justify-content:center;margin-bottom:16px;box-shadow:0 8px 24px rgba(16,185,129,0.3);">\n          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <path d="M5 13l4 4L19 7" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>\n          </svg>\n        </div>\n        \n        <h2 style="margin:0 0 8px 0;font-size:24px;font-weight:700;color:#059669;">Consent Saved!</h2>\n        <p style="color:#64748b;font-size:14px;margin:0 0 24px 0;line-height:1.5;">Your privacy preferences have been securely recorded.</p>\n        \n        \x3c!-- Email/ID Display Card --\x3e\n        <div style="background:linear-gradient(135deg, #4F76F6 0%, #3B5BDB 100%);border-radius:12px;padding:20px;margin-bottom:16px;box-shadow:0 8px 20px rgba(79,118,246,0.25);">\n          <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:10px;">\n            <div style="width:24px;height:24px;display:flex;align-items:center;justify-content:center;">\n              ${r.replace('width="32" height="32"','width="18" height="18"')}\n            </div>\n            <label style="color:rgba(255,255,255,0.9);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;">${i}</label>\n          </div>\n          \n          <div style="background:white;border-radius:10px;padding:14px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">\n            <div style="font-size:${n?"16px":"18px"};font-weight:700;color:#1e293b;font-family:${n?"-apple-system, BlinkMacSystemFont, sans-serif":"ui-monospace, monospace"};letter-spacing:${n?"0":"2px"};word-break:break-all;">\n              ${re(o)}\n            </div>\n          </div>\n        </div>\n        \n        \x3c!-- Download Privacy Notice Button --\x3e\n        <button \n          onclick="window.downloadPrivacyNotice()"\n          style="width:100%;padding:12px 16px;background:rgba(79,118,246,0.1);border:2px solid rgba(79,118,246,0.3);color:#4F76F6;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:16px;"\n          onmouseover="this.style.background='rgba(79,118,246,0.2)';this.style.borderColor='rgba(79,118,246,0.5)'"\n          onmouseout="this.style.background='rgba(79,118,246,0.1)';this.style.borderColor='rgba(79,118,246,0.3)'"\n          title="Download the full Privacy Notice"\n        >\n          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" stroke="#4F76F6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n          </svg>\n          Download Privacy Notice\n        </button>\n        \n        ${n?'\n        \x3c!-- Email Confirmation Notice --\x3e\n        <div style="background:#ecfdf5;border-left:3px solid #10b981;padding:12px;border-radius:8px;margin-bottom:16px;text-align:left;">\n          <p style="color:#065f46;font-size:12px;margin:0;line-height:1.5;">\n            <strong style="color:#047857;">Email linked!</strong> You can manage your preferences anytime using this email.\n          </p>\n        </div>\n        ':'\n        \x3c!-- Consent ID Notice --\x3e\n        <div style="background:#fef3c7;border-left:3px solid #f59e0b;padding:12px;border-radius:8px;margin-bottom:16px;text-align:left;">\n          <p style="color:#78350f;font-size:12px;margin:0;line-height:1.5;">\n            <strong style="color:#92400e;">Keep this ID safe!</strong> Use it to manage your preferences across devices.\n          </p>\n        </div>\n        '}\n        \n        \x3c!-- Action Button --\x3e\n        <button \n          onclick="document.getElementById('dpdpa-success-modal').remove()"\n          style="width:100%;padding:12px;background:linear-gradient(135deg, #10b981 0%, #059669 100%);border:none;color:white;border-radius:10px;font-weight:600;font-size:15px;cursor:pointer;box-shadow:0 4px 12px rgba(16,185,129,0.3);transition:all 0.2s;"\n          onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 6px 16px rgba(16,185,129,0.4)'"\n          onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(16,185,129,0.3)'"\n        >\n          Got it, thanks! ‚úì\n        </button>\n      </div>\n      <style>\n        @keyframes slideUp {\n          from { opacity: 0; transform: translateY(20px) scale(0.95); }\n          to { opacity: 1; transform: translateY(0) scale(1); }\n        }\n      </style>\n    `,document.body.appendChild(t)}(y),console.log("[Consently DPDPA] Consent saved successfully")}catch(e){console.error("[Consently DPDPA] Failed to save consent:",e),alert("Failed to save your consent preferences. Please try again.")}}function ie(e){const t=e.querySelector("#consently-dpdpa-widget");e.style.opacity="0",t&&(t.style.transform="scale(0.9)",t.style.opacity="0"),v&&(document.removeEventListener("click",v),v=null),setTimeout(()=>{document.body.contains(e)&&document.body.removeChild(e)},300)}function re(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function ae(e){const t=y||N(),n={widgetId:i,visitorId:t,privacyCentreUrl:window.location.origin+"/privacy-centre/"+i+"?visitorId="+t,...e},o=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),r=URL.createObjectURL(o),a=document.createElement("a");a.href=r,a.download="consent-receipt-"+t+".json",document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(r)}function se(){const e=y||N();window.open(window.location.origin+"/privacy-centre/"+i+"?visitorId="+e,"_blank")}window.copyConsentID=function(e){navigator.clipboard.writeText(e).then(()=>{Z("üìã Consent ID copied to clipboard!","success")}).catch(()=>{const t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),Z("üìã Consent ID copied!","success")})},window.downloadPrivacyNotice=async function(){if(console.log("[Consently DPDPA] Download Privacy Notice clicked"),u&&0!==u.length)try{Z("‚è≥ Generating PDF...","info");const e=s(),t=d.domain||window.location.hostname,n=await fetch(`${e}/api/dpdpa/privacy-notice`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({activities:u,domain:t,companyName:d.name||t})});if(!n.ok)throw new Error("Failed to generate PDF");const o=await n.blob(),i=window.URL.createObjectURL(o),r=document.createElement("a"),a=(new Date).toISOString().split("T")[0];r.href=i,r.download=`privacy-notice-${t.replace(/[^a-zA-Z0-9]/g,"-")}-${a}.pdf`,document.body.appendChild(r),r.click(),window.URL.revokeObjectURL(i),document.body.removeChild(r),Z("üìÑ Privacy Notice downloaded!","success")}catch(e){console.error("[Consently DPDPA] PDF download error:",e),Z("‚ùå Failed to download Privacy Notice.","error")}else Z("‚ö†Ô∏è Privacy Notice not available. No activities configured.","error")},window.downloadConsentReceipt=function(e){const t=(d.theme||{}).primaryColor||"#3b82f6",n=(new Date).toLocaleDateString("en-IN",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});let o,i=[],r=[],a=null;"string"==typeof e?o=e:e&&"object"==typeof e?(o=e.consentId||e.consent_id||N(),i=e.acceptedActivities||e.consented_activities||[],r=e.rejectedActivities||e.rejected_activities||[],a=e.email||e.visitor_email||null):o=N();const s={};u&&u.length>0?u.forEach(e=>{s[e.id]=e.activity_name||e.name||"Unknown Activity"}):p&&p.length>0&&p.forEach(e=>{s[e.id]=e.activity_name||e.name||"Unknown Activity"});const l=i.length>0?i.map(e=>`<li style="padding: 8px 12px; background: #dcfce7; border-radius: 6px; margin-bottom: 6px; color: #166534; font-weight: 500;">‚úì ${re(s[e]||e)}</li>`).join(""):'<li style="padding: 8px 12px; color: #6b7280; font-style: italic;">No activities accepted</li>',c=r.length>0?r.map(e=>`<li style="padding: 8px 12px; background: #fee2e2; border-radius: 6px; margin-bottom: 6px; color: #991b1b; font-weight: 500;">‚úó ${re(s[e]||e)}</li>`).join(""):"",g=d.domain||window.location.hostname,y=(d.name,`\n<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>Consent Receipt - ${o}</title>\n  <style>\n    @media print {\n      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }\n      .no-print { display: none !important; }\n    }\n    @media (max-width: 600px) {\n      body { padding: 16px !important; }\n      .container { padding: 20px !important; }\n      h1 { font-size: 24px !important; }\n    }\n  </style>\n</head>\n<body style="margin: 0; padding: 32px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #f0fdf4 100%); min-height: 100vh;">\n  <div class="container" style="max-width: 640px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); overflow: hidden;">\n    \n    \x3c!-- Header --\x3e\n    <div style="background: linear-gradient(135deg, ${t} 0%, ${t}dd 100%); padding: 32px; text-align: center;">\n      <div style="width: 64px; height: 64px; background: rgba(255,255,255,0.2); border-radius: 16px; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;">\n        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">\n          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>\n          <path d="M9 12l2 2 4-4"></path>\n        </svg>\n      </div>\n      <h1 style="margin: 0 0 8px 0; color: white; font-size: 28px; font-weight: 700;">Consent Receipt</h1>\n      <p style="margin: 0; color: rgba(255,255,255,0.9); font-size: 14px;">Digital Personal Data Protection Act, 2023</p>\n    </div>\n\n    \x3c!-- Consent ID Card --\x3e\n    <div style="padding: 24px; background: linear-gradient(to right, #f8fafc, #f1f5f9);">\n      <div style="background: white; border: 2px solid ${t}30; border-radius: 12px; padding: 20px; text-align: center;">\n        <p style="margin: 0 0 8px 0; font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;">Your Consent ID</p>\n        <p style="margin: 0; font-size: 22px; font-weight: 700; color: ${t}; font-family: ui-monospace, 'SF Mono', monospace; letter-spacing: 2px; word-break: break-all;">${re(o)}</p>\n      </div>\n    </div>\n\n    \x3c!-- Details --\x3e\n    <div style="padding: 24px;">\n      \x3c!-- Meta Info --\x3e\n      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;">\n        <div style="background: #f8fafc; padding: 16px; border-radius: 10px;">\n          <p style="margin: 0 0 4px 0; font-size: 11px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px;">Date & Time</p>\n          <p style="margin: 0; font-size: 14px; color: #1e293b; font-weight: 600;">${n}</p>\n        </div>\n        <div style="background: #f8fafc; padding: 16px; border-radius: 10px;">\n          <p style="margin: 0 0 4px 0; font-size: 11px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px;">Website</p>\n          <p style="margin: 0; font-size: 14px; color: #1e293b; font-weight: 600;">${re(g)}</p>\n        </div>\n        ${a?`\n        <div style="background: #f8fafc; padding: 16px; border-radius: 10px; grid-column: span 2;">\n          <p style="margin: 0 0 4px 0; font-size: 11px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px;">Verified Email</p>\n          <p style="margin: 0; font-size: 14px; color: #1e293b; font-weight: 600;">${re(a)}</p>\n        </div>\n        `:""}\n      </div>\n\n      \x3c!-- Accepted Activities --\x3e\n      <div style="margin-bottom: 20px;">\n        <h3 style="margin: 0 0 12px 0; font-size: 14px; color: #166534; font-weight: 700; display: flex; align-items: center; gap: 8px;">\n          <span style="width: 24px; height: 24px; background: #dcfce7; border-radius: 6px; display: inline-flex; align-items: center; justify-content: center;">‚úì</span>\n          Accepted Activities (${i.length})\n        </h3>\n        <ul style="margin: 0; padding: 0; list-style: none;">\n          ${l}\n        </ul>\n      </div>\n\n      ${r.length>0?`\n      \x3c!-- Rejected Activities --\x3e\n      <div style="margin-bottom: 20px;">\n        <h3 style="margin: 0 0 12px 0; font-size: 14px; color: #991b1b; font-weight: 700; display: flex; align-items: center; gap: 8px;">\n          <span style="width: 24px; height: 24px; background: #fee2e2; border-radius: 6px; display: inline-flex; align-items: center; justify-content: center;">‚úó</span>\n          Rejected Activities (${r.length})\n        </h3>\n        <ul style="margin: 0; padding: 0; list-style: none;">\n          ${c}\n        </ul>\n      </div>\n      `:""}\n\n      \x3c!-- Your Rights --\x3e\n      <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 12px; padding: 20px; margin-top: 24px;">\n        <h3 style="margin: 0 0 12px 0; font-size: 14px; color: #1e40af; font-weight: 700;">Your Rights Under DPDPA 2023</h3>\n        <ul style="margin: 0; padding-left: 20px; color: #1e40af; font-size: 13px; line-height: 1.8;">\n          <li><strong>Access:</strong> Request information about your data</li>\n          <li><strong>Correction:</strong> Update inaccurate information</li>\n          <li><strong>Erasure:</strong> Request deletion of your data</li>\n          <li><strong>Withdraw:</strong> Change consent preferences anytime</li>\n        </ul>\n      </div>\n\n      \x3c!-- Notice --\x3e\n      <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 16px; border-radius: 0 8px 8px 0; margin-top: 20px;">\n        <p style="margin: 0; font-size: 13px; color: #92400e; line-height: 1.5;">\n          <strong>Keep this receipt safe!</strong> Use your Consent ID to manage preferences across devices or raise a grievance.\n        </p>\n      </div>\n    </div>\n\n    \x3c!-- Footer --\x3e\n    <div style="background: #f8fafc; padding: 20px 24px; text-align: center; border-top: 1px solid #e2e8f0;">\n      <p style="margin: 0 0 4px 0; font-size: 12px; color: #64748b;">\n        Powered by <strong style="color: ${t};">Consently</strong>\n      </p>\n      <p style="margin: 0; font-size: 11px; color: #94a3b8;">\n        Compliant with Digital Personal Data Protection Act, 2023\n      </p>\n    </div>\n  </div>\n</body>\n</html>`.trim()),f=new Blob([y],{type:"text/html"}),h=URL.createObjectURL(f),m=document.createElement("a");m.href=h,m.download=`consent-receipt-${o}.html`,document.body.appendChild(m),m.click(),document.body.removeChild(m),URL.revokeObjectURL(h),Z("üìÑ Receipt downloaded!","success")},window.ConsentlyDPDPA={init:X,show:ee,hide:()=>{const e=document.getElementById("consently-dpdpa-overlay");e&&ie(e)},getConsent:()=>k.get("consently_dpdpa_consent_"+i),openPrivacyCentre:se,downloadReceipt:()=>{const e=k.get("consently_dpdpa_consent_"+i);e&&ae(e)},downloadPrivacyNotice:()=>{window.downloadPrivacyNotice&&window.downloadPrivacyNotice()}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",X):X()}();