(function(){'use strict';const isProduction = window.location.hostname !== 'localhost' && !window.location.hostname.includes('127.0.0.1');const originalLog = console.log;const originalInfo = console.info;const originalDebug = console.debug;if(isProduction){console.log = function(){};console.info = function(){};console.debug = function(){};}const currentScript = document.currentScript || document.querySelector('script[data-dpdpa-widget-id]');const widgetId = currentScript ? currentScript.getAttribute('data-dpdpa-widget-id'):null;if(!widgetId){console.error('[Consently DPDPA] Error:data-dpdpa-widget-id attribute is required');console.error('[Consently DPDPA] Usage:<script src="https://www.consently.in/dpdpa-widget.js" data-dpdpa-widget-id="YOUR_WIDGET_ID"></script>');return;}if(!isProduction){originalLog('[Consently DPDPA] Initializing widget with ID:',widgetId);}const BASE_TRANSLATIONS ={consentManager:'Consent Manager',compliantWith:'Fully compliant with Digital Personal Data Protection Act,2023',requirementsTitle:'DPDPA 2023 requires you to read the privacy notice',scrollInstruction:'Scroll down to read the privacy notice',downloadButton:'Download Privacy Notice',proceedButton:'Proceed to Consent',warningMessage:'Please complete both requirements to proceed',processingActivities:'Processing Activities',processingDescription:'We process your personal datafor the following purposes. You can accept or reject each activity individually.',acceptButton:'Accept',rejectButton:'Reject',acceptAll:'Accept All',rejectAll:'Reject All',acceptSelected:'Accept selected',cancel:'Cancel',close:'Close',dataAttributes:'Data Attributes',dataCategories:'Data Categories',purpose:'Purpose',retentionPeriod:'Retention Period',yourDataRights:'Your Data Rights',dataRightsText:'Under DPDPA 2023,you have the right to access,correct,and delete your personal data. You can also withdraw your consent at any time.',withdrawConsent:'Withdraw/Modify Consent',raiseGrievance:'Raise Grievance',privacyNotice:'Notice',dpdpaCompliance:'DPDPA 2023 Compliance',manageConsentPreferences:'Manage Your Consent Preferences',changeSettingsAnytime:'You can change these settings at any time',preferenceCentre:'Preference Centre',revocationWarning:'‚ö†Ô∏è Warning:Revoking consent may affect service delivery.',grievanceText:'If you have any grievances with how we process your personal data click{here}. If we are unable to resolve your grievance,you can also make a complaint to the Data Protection Board by clicking{here2}.',here:'here',poweredBy:'Powered by',ageVerificationRequired:'Age Verification Required',selectBirthYear:'Select your year of birth',continueButton:'Continue',ageGateDescription:'To provide you with an appropriate experience,we need to verify your age.',ageGateDefaultMinorMessage:'This content requires adult supervision. Please ask a parent or guardian to assist you.',digilockerVerification:'DigiLocker Age Verification',digilockerDescription:'Verify your age securely using your government-issued ID via DigiLocker.',verifyWithDigilocker:'Verify with DigiLocker',verifying:'Verifying...',ageVerified:'Age Verified',ageVerifiedMessage:'Your age has been verified successfully.',verificationFailed:'Verification Failed',verificationFailedMessage:'Age verification failed. Pleasetry again.',verificationPending:'Verification Pending',verificationPendingMessage:'Please complete verification in the DigiLocker window.',guardianConsentRequired:'Guardian Consent Required',guardianConsentMessage:'You are under the required age. A parent or guardian must verify their identity and approve your consent.',requestGuardianConsent:'Request Guardian Consent',guardianEmail:'Guardian Email',guardianEmailPlaceholder:'Enter guardian email address',sendConsentRequest:'Send Consent Request',consentRequestSent:'Consent request sent to guardian',waitingForGuardian:'Waitingfor guardian approval...',guardianApproved:'Guardian consent approved',guardianRejected:'Guardian consent was denied',retryVerification:'Retry Verification'};const translationCache ={};function getApiUrl(){const scriptSrc = currentScript ? currentScript.src:'';if(scriptSrc.includes('localhost')){return 'http://localhost:3000';}if(scriptSrc.includes('consently.in')){return 'https://www.consently.in';}const match = scriptSrc.match(/^(https?:\/\/[^\/]+)/);return match ? match[1]:window.location.origin;}asyncfunction translateText(text,targetLang){if(targetLang === 'en')return text;const cacheKey = `${targetLang}:${text}`;if(translationCache[cacheKey]){return translationCache[cacheKey];}try{const apiUrl = getApiUrl();const response = await fetch(`${apiUrl}/api/translate`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:text,target:targetLang,source:'en'})});if(response.ok){const data = await response.json();const translated = data.translatedText || text;translationCache[cacheKey] = translated;return translated;}}catch(error){console.error('[Consently] Translation error:',error);}return text;}asyncfunction batchTranslate(texts,targetLang){if(targetLang === 'en' || !texts || texts.length === 0)return texts || [];const uncachedTexts = [];const uncachedIndices = [];const result = [...texts];texts.forEach((text,idx)=>{if(!text){result[idx] = text;return;}const cacheKey = `${targetLang}:${text}`;if(translationCache[cacheKey]){result[idx] = translationCache[cacheKey];}else{uncachedTexts.push(text);uncachedIndices.push(idx);}});if(uncachedTexts.length === 0){return result;}try{const apiUrl = getApiUrl();const response = await fetch(`${apiUrl}/api/translate`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({texts:uncachedTexts,target:targetLang,source:'en'})});if(response.ok){const data = await response.json();if(data.success && data.translations && Array.isArray(data.translations)){uncachedIndices.forEach((idx,i)=>{const translated = data.translations[i] || uncachedTexts[i] || texts[idx];result[idx] = translated;const cacheKey = `${targetLang}:${texts[idx]}`;translationCache[cacheKey] = translated;});}else{console.warn('[Consently DPDPA] Unexpected API response format,using fallback');uncachedIndices.forEach((idx,i)=>{result[idx] = uncachedTexts[i] || texts[idx];});}}else{console.warn('[Consently DPDPA] Translation API error:',response.status);uncachedIndices.forEach((idx,i)=>{result[idx] = uncachedTexts[i] || texts[idx];});}}catch(error){console.error('[Consently DPDPA] Batch translation error:',error);uncachedIndices.forEach((idx,i)=>{result[idx] = uncachedTexts[i] || texts[idx];});}return result;}asyncfunction getTranslation(lang){if(lang === 'en'){return BASE_TRANSLATIONS;}const langCacheKey = `_lang_${lang}`;if(translationCache[langCacheKey]){return translationCache[langCacheKey];}const keys = Object.keys(BASE_TRANSLATIONS);const values = Object.values(BASE_TRANSLATIONS);const translatedValues = await batchTranslate(values,lang);const translations ={};keys.forEach((key,idx)=>{translations[key] = translatedValues[idx];});translationCache[langCacheKey] = translations;return translations;}let config = null;let allActivities = [];let activities = [];let activityConsents ={};let consentID = null;let verifiedEmail = null;let userEmail = null;let currentPrefilledEmail = null;let isVerifying = false;let globalClickHandler = null;let primaryColor = '#4c8bf5';let visitorEmail = null;let ageVerificationSessionId = null;let ageVerificationStatus = null;let ageVerificationAge = null;let guardianConsentStatus = null;let ageVerificationPollingInterval = null;const ConsentStorage ={set:function(key,value,expirationDays){const expiresAt = new Date();expiresAt.setDate(expiresAt.getDate()+ expirationDays);const data ={value:value,expiresAt:expiresAt.toISOString()};localStorage.setItem(key,JSON.stringify(data));},get:function(key){const data = localStorage.getItem(key);if(!data)return null;try{const parsed = JSON.parse(data);const expiresAt = new Date(parsed.expiresAt);if(expiresAt < new Date()){this.delete(key);return null;}return parsed.value;}catch(e){return null;}},delete:function(key){localStorage.removeItem(key);}};function getMinorCookieName(){return `consently_minor_flag_${widgetId}`;}function checkMinorCookie(){try{const cookieName = getMinorCookieName();const localStorageFlag = ConsentStorage.get(cookieName);if(localStorageFlag){console.log('[Consently DPDPA] Minor flag found in localStorage');return true;}const cookies = document.cookie.split(';');for(let cookie of cookies){const [name,value] = cookie.trim().split('=');if(name === cookieName && value === 'true'){console.log('[Consently DPDPA] Minor flag found in cookie');return true;}}return false;}catch(e){console.error('[Consently DPDPA] Error checking minor cookie:',e);return false;}}function setMinorCookie(){try{const cookieName = getMinorCookieName();const expirationDays = 365;ConsentStorage.set(cookieName,true,expirationDays);const expiresDate = new Date();expiresDate.setDate(expiresDate.getDate()+ expirationDays);document.cookie = `${cookieName}=true;expires=${expiresDate.toUTCString()};path=/;SameSite=Lax`;console.log('[Consently DPDPA] Minor flag cookie set for',expirationDays,'days');}catch(e){console.error('[Consently DPDPA] Error setting minor cookie:',e);}}function calculateAgeFromBirthYear(birthYear){const currentYear = new Date().getFullYear();return currentYear - parseInt(birthYear,10);}function checkExistingAgeVerification(){try{const storageKey = `consently_age_verified_${widgetId}`;const stored = ConsentStorage.get(storageKey);if(stored && stored.verified && stored.age !== undefined){ageVerificationStatus = 'verified';ageVerificationAge = stored.age;ageVerificationSessionId = stored.sessionId;return true;}return false;}catch(e){console.error('[Consently DPDPA] Error checking age verification:',e);return false;}}function storeAgeVerification(sessionId,age,validityDays = 365){try{const storageKey = `consently_age_verified_${widgetId}`;ConsentStorage.set(storageKey,{verified:true,age:age,sessionId:sessionId,verifiedAt:new Date().toISOString()},validityDays);}catch(e){console.error('[Consently DPDPA] Error storing age verification:',e);}}asyncfunction initiateAgeVerification(returnUrl){try{const apiBase = getApiUrl();const visitorId = consentID || getConsentID();const response = await fetch(`${apiBase}/api/dpdpa/age-verification`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({widgetId:widgetId,visitorId:visitorId,returnUrl:returnUrl || window.location.href})});if(!response.ok){const error = await response.json();throw new Error(error.error || 'Failed to initiate verification');}const data = await response.json();ageVerificationSessionId = data.sessionId;ageVerificationStatus = 'pending';sessionStorage.setItem('consently_age_session',data.sessionId);if(data.mockMode){console.log('[Consently DPDPA] Mock mode - redirecting to:',data.redirectUrl);}window.location.href = data.redirectUrl;return data;}catch(e){console.error('[Consently DPDPA] Error initiating age verification:',e);ageVerificationStatus = 'failed';throw e;}}asyncfunction checkAgeVerificationStatus(sessionId){try{const apiBase = getApiUrl();const response = await fetch(`${apiBase}/api/dpdpa/age-verification?sessionId=${sessionId}`);if(!response.ok){throw new Error('Failed to check verification status');}const data = await response.json();if(data.verified){ageVerificationStatus = 'verified';ageVerificationAge = data.age;if(data.isMinor && data.requiresGuardianConsent){if(data.guardianConsentStatus === 'approved'){ageVerificationStatus = 'verified';}else if(data.guardianConsentStatus === 'rejected'){ageVerificationStatus = 'rejected';}else{ageVerificationStatus = 'requires_guardian';guardianConsentStatus = data.guardianConsentStatus || 'pending';}}if(ageVerificationStatus === 'verified'){const validityDays = config?.verificationValidityDays || 365;storeAgeVerification(sessionId,data.age,validityDays);}}else if(data.status === 'failed'){ageVerificationStatus = 'failed';}return data;}catch(e){console.error('[Consently DPDPA] Error checking verification status:',e);return null;}}asyncfunction requestGuardianConsent(sessionId,guardianEmail,relationship = 'parent'){try{const apiBase = getApiUrl();const response = await fetch(`${apiBase}/api/dpdpa/age-verification/guardian-consent`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId:sessionId,guardianEmail:guardianEmail,relationship:relationship})});if(!response.ok){const error = await response.json();throw new Error(error.error || 'Failed to request guardian consent');}const data = await response.json();guardianConsentStatus = 'sent';return data;}catch(e){console.error('[Consently DPDPA] Error requesting guardian consent:',e);throw e;}}asyncfunction checkGuardianConsentStatus(sessionId){try{const apiBase = getApiUrl();const response = await fetch(`${apiBase}/api/dpdpa/age-verification/guardian-consent?sessionId=${sessionId}`);if(!response.ok){return null;}const data = await response.json();guardianConsentStatus = data.status;return data;}catch(e){console.error('[Consently DPDPA] Error checking guardian consent:',e);return null;}}asyncfunction handleAgeVerificationCallback(){const urlParams = new URLSearchParams(window.location.search);const sessionId = urlParams.get('age_verification_session');const status = urlParams.get('age_verification_status');if(!sessionId){const storedSession = sessionStorage.getItem('consently_age_session');if(storedSession){ageVerificationSessionId = storedSession;const statusData = await checkAgeVerificationStatus(storedSession);return statusData;}return null;}ageVerificationSessionId = sessionId;if(status === 'verified'){const statusData = await checkAgeVerificationStatus(sessionId);const cleanUrl = new URL(window.location.href);cleanUrl.searchParams.delete('age_verification_session');cleanUrl.searchParams.delete('age_verification_status');window.history.replaceState({},document.title,cleanUrl.toString());return statusData;}return null;}function startGuardianConsentPolling(sessionId,onStatusChange){if(ageVerificationPollingInterval){clearInterval(ageVerificationPollingInterval);}ageVerificationPollingInterval = setInterval(async()=>{const status = await checkGuardianConsentStatus(sessionId);if(status &&(status.status === 'approved' || status.status === 'rejected')){clearInterval(ageVerificationPollingInterval);ageVerificationPollingInterval = null;if(status.status === 'approved'){ageVerificationStatus = 'verified';storeAgeVerification(sessionId,ageVerificationAge,config?.verificationValidityDays || 365);}else{ageVerificationStatus = 'rejected';}if(onStatusChange){onStatusChange(status);}}},5000);}function stopGuardianConsentPolling(){if(ageVerificationPollingInterval){clearInterval(ageVerificationPollingInterval);ageVerificationPollingInterval = null;}}function updateDigiLockerUI(widget,t){const verificationSection = widget.querySelector('#dpdpa-digilocker-section');if(!verificationSection)return;const statusContainer = verificationSection.querySelector('#dpdpa-digilocker-status');const verifyBtn = verificationSection.querySelector('#dpdpa-digilocker-verify-btn');const guardianSection = verificationSection.querySelector('#dpdpa-guardian-section');if(ageVerificationStatus === 'verified'){if(statusContainer){statusContainer.innerHTML = ` <div style="display:flex;align-items:center;gap:8px;color:#059669;"> <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"> <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/> <polyline points="22 4 12 14.01 9 11.01"/> </svg> <span style="font-weight:600;">${t.ageVerified}</span> </div> <p style="margin:4px 0 0 28px;font-size:12px;color:#6b7280;">${t.ageVerifiedMessage}</p> `;}if(verifyBtn)verifyBtn.style.display = 'none';if(guardianSection)guardianSection.style.display = 'none';}else if(ageVerificationStatus === 'requires_guardian'){if(statusContainer){statusContainer.innerHTML = ` <div style="display:flex;align-items:center;gap:8px;color:#d97706;"> <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"> <circle cx="12" cy="12" r="10"/> <path d="M12 16v-4"/> <path d="M12 8h.01"/> </svg> <span style="font-weight:600;">${t.guardianConsentRequired}</span> </div> <p style="margin:4px 0 0 28px;font-size:12px;color:#6b7280;">${t.guardianConsentMessage}</p> `;}if(verifyBtn)verifyBtn.style.display = 'none';if(guardianSection)guardianSection.style.display = 'block';}else if(ageVerificationStatus === 'failed'){if(statusContainer){statusContainer.innerHTML = ` <div style="display:flex;align-items:center;gap:8px;color:#dc2626;"> <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"> <circle cx="12" cy="12" r="10"/> <path d="M15 9l-6 6"/> <path d="M9 9l6 6"/> </svg> <span style="font-weight:600;">${t.verificationFailed}</span> </div> <p style="margin:4px 0 0 28px;font-size:12px;color:#6b7280;">${t.verificationFailedMessage}</p> `;}if(verifyBtn){verifyBtn.textContent = t.retryVerification;verifyBtn.style.display = 'inline-flex';}}}function hashStringSync(str){if(!str)return null;const normalized = str.toLowerCase().trim();let hash1 = 5381;let hash2 = 0;let hash3 = 52711;let hash4 = 0;for(let i = 0;i < normalized.length;i++){const char = normalized.charCodeAt(i);hash1 =((hash1 << 5)+ hash1)+ char;hash2 =((hash2 << 5)+ hash2)+(char * 31);hash3 =((hash3 << 5)+ hash3)^ char;hash4 =((hash4 << 5)+ hash4)+(char * 17);}const hex1 = Math.abs(hash1).toString(16).padStart(16,'0');const hex2 = Math.abs(hash2).toString(16).padStart(16,'0');const hex3 = Math.abs(hash3).toString(16).padStart(16,'0');const hex4 = Math.abs(hash4).toString(16).padStart(16,'0');return(hex1 + hex2 + hex3 + hex4).substring(0,64);}asyncfunction hashString(str){if(!str)return null;const normalized = str.toLowerCase().trim();if(window.crypto && window.crypto.subtle){try{const encoder = new TextEncoder();const data = encoder.encode(normalized);const hashBuffer = await crypto.subtle.digest('SHA-256',data);const hashArray = Array.from(new Uint8Array(hashBuffer));return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');}catch(e){console.warn('[Consently DPDPA] Web Crypto API failed,using fallback hash:',e);return hashStringSync(normalized);}}return hashStringSync(normalized);}function generateDeviceFingerprint(){const components = [];if(navigator.userAgent){components.push(navigator.userAgent);}if(screen.width && screen.height){const maxWidth = Math.max(screen.width,screen.availWidth || screen.width);const maxHeight = Math.max(screen.height,screen.availHeight || screen.height);components.push(`max${maxWidth}x${maxHeight}`);}if(screen.colorDepth){components.push(`cd${screen.colorDepth}`);}if(screen.pixelDepth){components.push(`pd${screen.pixelDepth}`);}try{components.push(Intl.DateTimeFormat().resolvedOptions().timeZone || '');}catch(e){}if(navigator.language){components.push(navigator.language);}if(navigator.platform){components.push(navigator.platform);}if(navigator.hardwareConcurrency){components.push(`hc${navigator.hardwareConcurrency}`);}if(navigator.deviceMemory){components.push(`dm${navigator.deviceMemory}`);}if(navigator.maxTouchPoints){components.push(`mtp${navigator.maxTouchPoints}`);}if(navigator.vendor){components.push(navigator.vendor);}try{const canvas = document.createElement('canvas');const ctx = canvas.getContext('2d');if(ctx){ctx.textBaseline = 'top';ctx.font = '14px Arial';ctx.fillText('ConsentlyDeviceFingerprint',2,2);const canvasData = canvas.toDataURL();components.push(canvasData.substring(0,50));}}catch(e){}return components.join('|');}function generateConsentID(){const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';const segments = [];for(let i = 0;i < 3;i++){let segment = '';for(let j = 0;j < 4;j++){const randomIndex = Math.floor(Math.random()* chars.length);segment += chars.charAt(randomIndex);}segments.push(segment);}return 'CNST-' + segments.join('-');}function getConsentID(){let storedID = ConsentStorage.get('consently_consent_id');if(storedID){console.log('[Consently DPDPA] Using stored Consent ID:',storedID);return storedID;}const newID = generateConsentID();ConsentStorage.set('consently_consent_id',newID,365 * 10);console.log('[Consently DPDPA] Generated new Consent ID:',newID);return newID;}function storeConsentID(id){if(!id)return;try{ConsentStorage.set('consently_consent_id',id,365 * 10);document.cookie = `consently_id=${id};max-age=${365 * 24 * 60 * 60 * 10};path=/;SameSite=Lax`;console.log('[Consently DPDPA] Consent ID stored:',id);}catch(error){console.error('[Consently DPDPA] Failed to store Consent ID:',error);}}function formatConsentID(id){return id;}function isValidConsentID(id){if(!id)return false;const newFormat = /^CNST-[A-Z2-9]{4}-[A-Z2-9]{4}-[A-Z2-9]{4}$/.test(id);const legacyFormat = /^vis_[a-zA-Z0-9]+$/.test(id);return newFormat || legacyFormat;}asyncfunction verifyConsentID(id){if(!isValidConsentID(id)){return{valid:false,error:'Invalid Consent ID format'};}try{const apiUrl = getApiUrl();const response = await fetch(`${apiUrl}/api/dpdpa/verify-consent-id`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({consentID:id,widgetId:widgetId})});return await response.json();}catch(error){console.error('[Consently DPDPA] Verification error:',error);return{valid:false,error:'Unable to verify Consent ID'};}}asyncfunction checkUserStatus(emailHash){if(!emailHash)return{status:'new'};try{const apiUrl = getApiUrl();const response = await fetch(`${apiUrl}/api/dpdpa/check-user-status`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({emailHash:emailHash,widgetId:widgetId})});if(response.ok){return await response.json();}return{status:'new'};}catch(error){console.error('[Consently DPDPA] Check user status error:',error);return{status:'new'};}}function showWidgetError(message,isCritical = false){const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname.includes('127.0.0.1')|| window.location.hostname.includes('consently.in');if(!isDevelopment && !isCritical){console.warn('[Consently DPDPA]',message);return;}const errorBanner = document.createElement('div');errorBanner.id = 'consently-widget-error';errorBanner.style.cssText = ` position:fixed;bottom:20px;right:20px;background:${isCritical ? '#fee2e2':'#fef3c7'};border:1px solid ${isCritical ? '#fca5a5':'#fcd34d'};border-radius:8px;padding:12px 16px;max-width:400px;box-shadow:0 4px 6px rgba(0,0,0,0.1);z-index:999999;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;font-size:13px;line-height:1.5;color:${isCritical ? '#991b1b':'#92400e'};`;errorBanner.innerHTML = ` <div style="display:flex;align-items:flex-start;gap:8px;"> <span style="font-size:18px;">${isCritical ? '‚ö†Ô∏è':'‚ÑπÔ∏è'}</span> <div style="flex:1;"> <strong style="display:block;margin-bottom:4px;">Consently Widget ${isCritical ? 'Error':'Notice'}</strong> <div>${message}</div> </div> <button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;font-size:18px;cursor:pointer;color:inherit;opacity:0.6;padding:0;line-height:1;"> √ó </button> </div> `;document.body.appendChild(errorBanner);if(!isCritical){setTimeout(()=>{if(errorBanner.parentElement){errorBanner.remove();}},10000);}}asyncfunction fetchWidgetConfig(){try{const scriptSrc = currentScript.src;let apiBase;if(scriptSrc && scriptSrc.includes('http')){const url = new URL(scriptSrc);apiBase = url.origin;}else{apiBase = window.location.origin;}const apiUrl = `${apiBase}/api/dpdpa/widget-public/${widgetId}`;console.log('[Consently DPDPA] Fetching configuration from:',apiUrl);const cacheBuster = Date.now();const apiUrlWithCache = `${apiUrl}?_t=${cacheBuster}`;const response = await fetch(apiUrlWithCache,{method:'GET',headers:{'Content-Type':'application/json','Cache-Control':'no-cache'},cache:'no-store'});if(!response.ok){if(response.status === 404){const errorData = await response.json().catch(()=>({}));const errorMessage = errorData.error || 'Widget configuration not found';console.error('[Consently DPDPA] Widget not found:',{widgetId:widgetId,status:response.status,error:errorMessage,hint:'This widget may have been deleted. Please check your Consently dashboard and create a new widgetif needed.'});showWidgetError(`Widget ID "${widgetId}" not found. This widget may have been deleted. ` + `Please check your Consently dashboard or contact supportif this persists.`,true);return{success:false,error:'WIDGET_NOT_FOUND',status:404};}else if(response.status === 429){console.warn('[Consently DPDPA] Rate limit exceeded. Retrying later...');return{success:false,error:'RATE_LIMIT',status:429};}else{const errorText = await response.text().catch(()=> response.statusText);throw new Error(`HTTP ${response.status}:${errorText}`);}}const data = await response.json();config = data;allActivities = JSON.parse(JSON.stringify(data.activities || []));activities = data.activities || [];console.log('[Consently DPDPA] Configuration loaded:',config.name);console.log('[Consently DPDPA] Activities loaded:',activities.length);if(activities.length > 0){console.log('[Consently DPDPA] First activity:',activities[0]);console.log('[Consently DPDPA] Activity structure check:',{hasPurposes:!!activities[0].purposes,hasDataAttributes:!!activities[0].data_attributes,purposesCount:activities[0].purposes?.length || 0,dataAttributesCount:activities[0].data_attributes?.length || 0});}else{console.warn('[Consently DPDPA] No activities found in configuration!');console.log('[Consently DPDPA] Full config:',data);}return{success:true};}catch(error){console.error('[Consently DPDPA] Failed to load configuration:',error);if(error.name === 'TypeError' && error.message.includes('fetch')){showWidgetError('Unable to connect to Consently service. Please check your internet connection.',false);return{success:false,error:'NETWORK_ERROR'};}return{success:false,error:'UNKNOWN_ERROR',message:error.message};}}function matchesUrlPattern(url,rule){if(!url || typeof url !== 'string'){console.warn('[Consently DPDPA] Invalid URL provided to matchesUrlPattern');return false;}if(!rule || typeof rule !== 'object'){console.warn('[Consently DPDPA] Invalid rule provided to matchesUrlPattern');return false;}if(!rule.url_pattern)return true;const pattern = rule.url_pattern;const matchType = rule.url_match_type || 'contains';if(pattern.length > 500){console.warn('[Consently DPDPA] URL pattern too long,skipping:',rule.id || 'unknown');return false;}try{switch(matchType){case 'exact':return url === pattern;case 'contains':return url.includes(pattern);case 'startsWith':return url.startsWith(pattern);case 'regex':try{const regex = new RegExp(pattern);return regex.test(url);}catch(e){console.error('[Consently DPDPA] Invalid regex pattern in rule:',rule.id || 'unknown',e);return false;}default:console.warn('[Consently DPDPA] Unknown match type:',matchType);return url.includes(pattern);}}catch(error){console.error('[Consently DPDPA] Error matching URL pattern:',error);return false;}}function showNoticeForRule(rule){console.log('[Consently DPDPA] Showing noticefor rule:',rule.rule_name);console.log('[Consently DPDPA] Activities to show:',activities.length);applyRule(rule);if(rule.trigger_type === 'onPageLoad'){setTimeout(()=>{showConsentWidget();},rule.trigger_delay || 0);}}function setupClickTrigger(rule){const element = document.querySelector(rule.element_selector);if(!element){console.warn('[Consently DPDPA] Element not foundfor click trigger:',rule.element_selector);return;}element.addEventListener('click',(e)=>{e.preventDefault();applyRule(rule);trackRuleMatch(rule);showConsentWidget();},{once:true});}function setupFormSubmitTrigger(rule){let targetForms = [];if(rule.element_selector){const form = document.querySelector(rule.element_selector);if(form){targetForms = [form];}else{console.warn('[Consently DPDPA] Form not foundfor submit trigger:',rule.element_selector);}}else{targetForms = Array.from(document.querySelectorAll('form'));console.log('[Consently DPDPA] Auto-detected forms:',targetForms.length);}if(targetForms.length === 0){console.warn('[Consently DPDPA] No forms found on pagefor submit trigger');return;}const formHandlers = new WeakMap();targetForms.forEach(form =>{const submitHandler = async(e)=>{const existingConsent = ConsentStorage.get(`consently_dpdpa_consent_${widgetId}`);const hasConsent = existingConsent && existingConsent.timestamp;if(!hasConsent){e.preventDefault();e.stopPropagation();console.log('[Consently DPDPA] Form submission intercepted - showing consent widget');let prefilledEmail = null;let userStatus = 'new';if(!config.enableSmartPreFill){console.log('[Consently DPDPA] Smart pre-fill is disabled by site owner - using manual input');prefilledEmail = null;userStatus = 'new';}else{const selectors = config.emailFieldSelectors || 'input[type="email"],input[name*="email" i]';let emailInput = null;try{emailInput = form.querySelector(selectors);if(!emailInput){console.log('[Consently DPDPA] No email field found with selectors:',selectors);}}catch(e){console.error('[Consently DPDPA] Invalid email field selector:',selectors,e);console.log('[Consently DPDPA] Falling back to manual email input');}if(emailInput && emailInput.value){prefilledEmail = emailInput.value;console.log('[Consently DPDPA] ‚úì Smart Pre-fill:Found email in form:',prefilledEmail);const emailHash = await hashString(prefilledEmail);const statusResult = await checkUserStatus(emailHash);userStatus = statusResult.status || 'new';console.log('[Consently DPDPA] User status:',userStatus,userStatus === 'verified' ? '(returning user)':'(new user)');}else{console.log('[Consently DPDPA] No email found,user will need to enter email manually');}}applyRule(rule);trackRuleMatch(rule);const formData = new FormData(form);const submitButton = e.submitter || form.querySelector('[type="submit"]');console.log('[Consently DPDPA] Showing widget with pre-filled email:',prefilledEmail || 'none');showConsentWidget(prefilledEmail,userStatus);window.addEventListener('consentlyDPDPAConsent',function handleConsent(consentEvent){console.log('[Consently DPDPA] Consent received,allowing form submission');window.removeEventListener('consentlyDPDPAConsent',handleConsent);setTimeout(()=>{form.removeEventListener('submit',submitHandler);if(submitButton){submitButton.click();}else{form.submit();}setTimeout(()=>{form.addEventListener('submit',submitHandler,{capture:true});},100);},300);},{once:true});}else{console.log('[Consently DPDPA] Consent already exists,allowing form submission');}};form.addEventListener('submit',submitHandler,{capture:true});console.log('[Consently DPDPA] Form submit listener attached:',form.id || form.name || 'unnamed form');});}function setupScrollTrigger(rule){const scrollThreshold = rule.scroll_threshold !== undefined ? rule.scroll_threshold:50;let hasTriggered = false;console.log('[Consently DPDPA] Setting up scroll triggerfor rule:',rule.rule_name,'Threshold:',scrollThreshold + '%');function getScrollPercentage(){const windowHeight = window.innerHeight;const documentHeight = document.documentElement.scrollHeight;const scrollTop = window.pageYOffset || document.documentElement.scrollTop;const scrollableHeight = documentHeight - windowHeight;const scrolled = scrollTop;if(scrollableHeight === 0)return 0;return Math.round((scrolled / scrollableHeight)* 100);}let lastCheck = 0;const scrollHandler =()=>{const now = Date.now();if(now - lastCheck < 100)return;lastCheck = now;if(hasTriggered){window.removeEventListener('scroll',scrollHandler);window.removeEventListener('wheel',scrollHandler);window.removeEventListener('touchmove',scrollHandler);return;}const scrollPercent = getScrollPercentage();if(scrollPercent >= scrollThreshold){console.log('[Consently DPDPA] Scroll threshold reached:',scrollPercent + '%');hasTriggered = true;applyRule(rule);const delay = rule.trigger_delay || 0;setTimeout(()=>{showConsentWidget();},delay);trackRuleMatch(rule);window.removeEventListener('scroll',scrollHandler);window.removeEventListener('wheel',scrollHandler);window.removeEventListener('touchmove',scrollHandler);}};window.addEventListener('scroll',scrollHandler,{passive:true});window.addEventListener('wheel',scrollHandler,{passive:true});window.addEventListener('touchmove',scrollHandler,{passive:true});setTimeout(()=>{scrollHandler();},500);return()=>{window.removeEventListener('scroll',scrollHandler);window.removeEventListener('wheel',scrollHandler);window.removeEventListener('touchmove',scrollHandler);};}function evaluateDisplayRules(){try{if(!config || typeof config !== 'object'){console.warn('[Consently DPDPA] Invalid config in evaluateDisplayRules');return null;}const rules = config.display_rules || [];const currentUrlForMatching =(typeof window !== 'undefined' && window.location &&(window.location.href || window.location.pathname))|| '/';if(typeof currentUrlForMatching !== 'string'){console.warn('[Consently DPDPA] Invalid URL in evaluateDisplayRules');return null;}console.log('[Consently DPDPA] Evaluating display rulesfor URL:',currentUrlForMatching);console.log('[Consently DPDPA] Available rules:',rules.length);if(!Array.isArray(rules)|| rules.length === 0){console.log('[Consently DPDPA] No display rules configured');return null;}const validRules = rules.filter(rule =>{if(!rule || typeof rule !== 'object'){console.warn('[Consently DPDPA] Invalid rule structure,skipping');return false;}if(!rule.id || !rule.rule_name || !rule.url_pattern){console.warn('[Consently DPDPA] Rule missing required fields,skipping:',rule.id || 'unknown');return false;}if(typeof rule.id !== 'string' || rule.id.length > 100){console.warn('[Consently DPDPA] Invalid rule ID,skipping:',rule.id);return false;}return true;});const sortedRules = [...validRules].sort((a,b)=>{const priorityA = typeof a.priority === 'number' ? a.priority:100;const priorityB = typeof b.priority === 'number' ? b.priority:100;return priorityB - priorityA;});for(const rule of sortedRules){if(rule.is_active === false){console.log('[Consently DPDPA] Rule inactive:',rule.rule_name);continue;}try{if(matchesUrlPattern(currentUrlForMatching,rule)){console.log('[Consently DPDPA] Rule matched:',rule.rule_name);if(rule.element_selector){try{const element = document.querySelector(rule.element_selector);if(!element){console.log('[Consently DPDPA] Element not found:',rule.element_selector);continue;}}catch(selectorError){console.error('[Consently DPDPA] Invalid selector:',rule.element_selector,selectorError);continue;}}return rule;}}catch(matchError){console.error('[Consently DPDPA] Error matching rule:',rule.id,matchError);continue;}}console.log('[Consently DPDPA] No matching rules found');return null;}catch(error){console.error('[Consently DPDPA] Error in evaluateDisplayRules:',error);return null;}}function applyRule(rule){if(allActivities.length > 0){activities = JSON.parse(JSON.stringify(allActivities));if(config)config.activities = activities;}config._matchedRule = rule;const currentPath = window.location.pathname || '/';const currentHref = window.location.href || currentPath;if(rule.url_pattern && rule.url_pattern !== '*' && rule.url_pattern !== ' .dpdpa-otp-section{flex-direction:column !important;align-items:stretch !important;gap:12px !important;}.dpdpa-otp-input-wrapper{width:100% !important;min-width:unset !important;}#dpdpa-otp-input{font-size:28px !important;padding:16px 8px !important;letter-spacing:0.4em !important;}.dpdpa-otp-actions{flex-direction:row !important;justify-content:center !important;gap:16px !important;}@media(max-width:380px){.dpdpa-secure-input-group{flex-direction:column !important;}#dpdpa-send-code-btn{width:100% !important;}#dpdpa-otp-input{font-size:24px !important;letter-spacing:0.35em !important;}}.dpdpa-footer-actions{padding:16px !important;}}</style> `;}widget.innerHTML = buildWidgetHTML();function languageLabel(code){const map ={en:'English',hi:'‡§π‡§ø‡§Ç‡§¶‡•Ä',pa:'‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä',te:'‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å',ta:'‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç',bn:'‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ',mr:'‡§Æ‡§∞‡§æ‡§†‡•Ä',gu:'‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä',kn:'‡≤ï‡≤®‡≥ç‡≤®‡≤°',ml:'‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç',or:'‡¨ì‡¨°‡¨º‡¨ø‡¨Ü',ur:'ÿßÿ±ÿØŸà',as:'‡¶Ö‡¶∏‡¶Æ‡ßÄ‡¶Ø‡¶º‡¶æ'};return map[code] || code;}function languageFlag(code){const map ={en:'üáÆüá≥',hi:'üáÆüá≥',pa:'üáÆüá≥',te:'üáÆüá≥',ta:'üáÆüá≥',bn:'üáÆüá≥',mr:'üáÆüá≥',gu:'üáÆüá≥',kn:'üáÆüá≥',ml:'üáÆüá≥',or:'üáÆüá≥',ur:'üáÆüá≥'};return map[code] || 'üåê';}overlay.appendChild(widget);document.body.appendChild(overlay);requestAnimationFrame(()=>{overlay.style.opacity = '1';widget.style.transform = 'scale(1)';widget.style.opacity = '1';});attachEventListeners(overlay,widget);asyncfunction rebuildWidget(){if(isTranslating){console.log('[Consently DPDPA] Translation already in progress,ignoring request');return;}isTranslating = true;const loadingOverlay = document.createElement('div');loadingOverlay.id = 'consently-dpdpa-loading-overlay';loadingOverlay.style.cssText = ` position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.98);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;z-index:999999;pointer-events:all;`;loadingOverlay.innerHTML = ` <div style="display:flex;flex-direction:column;align-items:center;gap:12px;"> <div style="width:32px;height:32px;border:3px solid ${primaryColor}30;border-top-color:${primaryColor};border-radius:50%;animation:spin 0.8s linear infinite;"></div> <span style="font-size:13px;color:${textColor};font-weight:500;opacity:0.8;">Translating...</span> </div> <style> @keyframes spin{to{transform:rotate(360deg);}}</style> `;document.body.appendChild(loadingOverlay);try{if(globalClickHandler){document.removeEventListener('click',globalClickHandler);globalClickHandler = null;}t = await getTranslation(selectedLanguage);if(selectedLanguage === 'en'){translatedConfig ={title:config.title || 'Your Data Privacy Rights',message:config.message || 'We process your personal data with your consent. Please review the activities below and choose your preferences.',acceptButtonText:config.acceptButtonText || 'Accept All',rejectButtonText:config.rejectButtonText || 'Reject All',customizeButtonText:config.customizeButtonText || 'Manage Preferences'};activities = JSON.parse(JSON.stringify(originalActivities));}else{const originalActivitiesForTranslation = JSON.parse(JSON.stringify(originalActivities));const textsToTranslate = [ config.title || 'Your Data Privacy Rights',config.message || 'We process your personal data with your consent. Please review the activities below and choose your preferences.',config.acceptButtonText || 'Accept All',config.rejectButtonText || 'Reject All',config.customizeButtonText || 'Manage Preferences',...originalActivitiesForTranslation.map(a => a.activity_name),...originalActivitiesForTranslation.flatMap(a =>{if(a.purposes && Array.isArray(a.purposes)&& a.purposes.length > 0){return a.purposes.flatMap(p => [ p.purposeName || '',...(p.dataCategories || []).map(cat => cat.categoryName || '')]).filter(Boolean);}return a.data_attributes || [];})];const translatedTexts = await batchTranslate(textsToTranslate,selectedLanguage);let textIndex = 0;translatedConfig ={title:translatedTexts[textIndex++],message:translatedTexts[textIndex++],acceptButtonText:translatedTexts[textIndex++],rejectButtonText:translatedTexts[textIndex++],customizeButtonText:translatedTexts[textIndex++]};const translatedActivities = originalActivitiesForTranslation.map(activity =>{const translatedName = translatedTexts[textIndex++];if(activity.purposes && Array.isArray(activity.purposes)&& activity.purposes.length > 0){const translatedPurposes = activity.purposes.map(purpose =>{const translatedPurposeName = translatedTexts[textIndex++];const translatedDataCategories =(purpose.dataCategories || []).map(()=> translatedTexts[textIndex++]);return{...purpose,purposeName:translatedPurposeName,dataCategories:purpose.dataCategories.map((cat,idx)=>({...cat,categoryName:translatedDataCategories[idx] || cat.categoryName}))};});return{...activity,activity_name:translatedName,purposes:translatedPurposes};}else{const translatedAttrs =(activity.data_attributes || []).map(()=> translatedTexts[textIndex++]);return{...activity,activity_name:translatedName,data_attributes:translatedAttrs};}});activities = translatedActivities;}widget.innerHTML = buildWidgetHTML();attachEventListeners(overlay,widget);setupGatedInteractions();}catch(error){console.error('[Consently DPDPA] Translation error:',error);widget.innerHTML = buildWidgetHTML();attachEventListeners(overlay,widget);setupGatedInteractions();}finally{const overlayElement = document.getElementById('consently-dpdpa-loading-overlay');if(overlayElement)overlayElement.remove();isTranslating = false;}}function setupGatedInteractions(){const langBtn = widget.querySelector('#dpdpa-lang-btn');const langMenu = widget.querySelector('#dpdpa-lang-menu');if(!langBtn || !langMenu)return;langBtn.addEventListener('mouseenter',()=>{langBtn.style.boxShadow = '0 4px 8px rgba(59,130,246,0.4)';langBtn.style.transform = 'translateY(-1px)';});langBtn.addEventListener('mouseleave',()=>{langBtn.style.boxShadow = '0 2px 4px rgba(59,130,246,0.3)';langBtn.style.transform = 'translateY(0)';});langBtn.addEventListener('click',(e)=>{e.stopPropagation();langMenu.style.display = langMenu.style.display === 'none' || !langMenu.style.display ? 'block':'none';});globalClickHandler =(e)=>{if(!langBtn.contains(e.target)&& !langMenu.contains(e.target)){langMenu.style.display = 'none';}};document.addEventListener('click',globalClickHandler);langMenu.querySelectorAll('button[data-lang]').forEach(b =>{b.addEventListener('mouseenter',()=>{if(b.getAttribute('data-lang')!== selectedLanguage){b.style.background = '#f0f9ff';}});b.addEventListener('mouseleave',()=>{if(b.getAttribute('data-lang')!== selectedLanguage){b.style.background = '#fff';}});b.addEventListener('click',async()=>{selectedLanguage = b.getAttribute('data-lang');langMenu.style.display = 'none';await rebuildWidget();});});}setupGatedInteractions();}function attachEventListeners(overlay,widget){const theme = config.theme ||{};const textColor = theme.textColor || '#1f2937';const buttonPrimaryColor = theme.primaryColor || primaryColor;const sendCodeBtn = widget.querySelector('#dpdpa-send-code-btn');if(sendCodeBtn){sendCodeBtn.addEventListener('click',async()=>{const emailInput = widget.querySelector('#dpdpa-email-input');const email = emailInput ? emailInput.value:null;if(!email || !email.includes('@')){alert('Please enter a valid email address');return;}const originalText = sendCodeBtn.textContent;sendCodeBtn.textContent = 'Sending...';sendCodeBtn.disabled = true;try{const apiBase = getApiUrl();const response = await fetch(`${apiBase}/api/privacy-centre/send-otp`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:email,visitorId:consentID || getConsentID(),widgetId:widgetId,}),});if(response.ok){const secureSection = widget.querySelector('#dpdpa-email-input').closest('div').parentElement;secureSection.innerHTML = ` <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;"> <div style="width:36px;height:36px;background:linear-gradient(135deg,${buttonPrimaryColor}20,${buttonPrimaryColor}10);border-radius:10px;display:flex;align-items:center;justify-content:center;"> <span style="font-size:18px;">üìß</span> </div> <div> <h3 style="margin:0;font-size:15px;font-weight:700;color:${textColor};">Enter Verification Code</h3> <p style="margin:2px 0 0 0;font-size:11px;color:#6b7280;">Sent to <strong style="color:${buttonPrimaryColor}">${escapeHtml(email)}</strong></p> </div> </div> <div class="dpdpa-otp-section" style="display:flex;gap:12px;flex:1;align-items:center;flex-wrap:wrap;"> <div class="dpdpa-otp-input-wrapper" style="flex:1;min-width:160px;position:relative;"> <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="6" autocomplete="one-time-code" id="dpdpa-otp-input" placeholder="000000" style="width:100%;padding:14px 12px;border:2px solid ${buttonPrimaryColor}40;border-radius:12px;font-size:24px;outline:none;transition:all 0.2s;text-align:center;letter-spacing:0.5em;font-family:'SF Mono','Menlo','Monaco','Courier New',monospace;font-weight:700;background:linear-gradient(to right,${buttonPrimaryColor}05,${buttonPrimaryColor}10);color:${textColor};box-sizing:border-box;" /> </div> <button id="dpdpa-resend-btn" style="background:${buttonPrimaryColor}10;border:1px solid ${buttonPrimaryColor}30;color:${buttonPrimaryColor};font-weight:600;font-size:12px;cursor:pointer;padding:10px 14px;white-space:nowrap;border-radius:8px;transition:all 0.2s;">‚Üª Resend</button> </div> <p style="margin:12px 0 0 0;font-size:11px;color:#9ca3af;text-align:center;">Code expires in 10 minutes</p> `;attachEventListeners(overlay,widget);userEmail = email;}else{alert('Failed to send code. Pleasetry again.');sendCodeBtn.textContent = originalText;sendCodeBtn.disabled = false;}}catch(e){console.error('Send OTP error',e);alert('Error sending code');sendCodeBtn.textContent = originalText;sendCodeBtn.disabled = false;}});}const changeEmailBtn = widget.querySelector('#dpdpa-change-email-btn');if(changeEmailBtn){changeEmailBtn.addEventListener('click',()=>{const overlay = document.getElementById('consently-dpdpa-overlay');if(overlay)overlay.remove();showConsentWidget(null,'new');});}const resendBtn = widget.querySelector('#dpdpa-resend-btn');if(resendBtn){resendBtn.addEventListener('click',async()=>{if(!userEmail)return;resendBtn.textContent = 'Sending...';resendBtn.disabled = true;try{const apiBase = getApiUrl();await fetch(`${apiBase}/api/privacy-centre/send-otp`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:userEmail,visitorId:consentID || getConsentID(),widgetId:widgetId,}),});resendBtn.textContent = 'Sent!';setTimeout(()=>{resendBtn.textContent = '[ Resend Code ]';resendBtn.disabled = false;},3000);}catch(e){resendBtn.textContent = 'Error';setTimeout(()=>{resendBtn.textContent = '[ Resend Code ]';resendBtn.disabled = false;},3000);}});}const verifyBtn = widget.querySelector('#dpdpa-verify-btn');if(verifyBtn){verifyBtn.addEventListener('click',async()=>{const otpInput = widget.querySelector('#dpdpa-otp-input');const code = otpInput ? otpInput.value:null;if(!code || code.length < 4){alert('Please enter a valid code');return;}if(isVerifying)return;isVerifying = true;verifyBtn.textContent = 'Verifying...';verifyBtn.disabled = true;try{const apiBase = getApiUrl();const response = await fetch(`${apiBase}/api/privacy-centre/verify-otp`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:userEmail || currentPrefilledEmail,otpCode:code,visitorId:consentID || getConsentID(),widgetId:widgetId,}),});if(response.ok){const data = await response.json();verifiedEmail = userEmail || currentPrefilledEmail;if(data.stableConsentId && data.stableConsentId !== consentID){console.log('[Consently DPDPA] Switching to stable Consent ID:',data.stableConsentId);consentID = data.stableConsentId;storeConsentID(consentID);}const prefsContainer = widget.querySelector('#dpdpa-preferences-container');const notice = widget.querySelector('#dpdpa-verification-notice');if(prefsContainer)prefsContainer.style.display = 'block';if(notice)notice.style.display = 'none';const confirmBtn = widget.querySelector('#dpdpa-confirm-btn');if(confirmBtn){confirmBtn.textContent = 'Save Preferences';confirmBtn.disabled = false;}verifyBtn.textContent = 'Verified';}else{alert('Invalid Verification Code');verifyBtn.textContent = 'Verify';verifyBtn.disabled = false;}}catch(e){console.error('Verification error',e);alert('Verification failed');verifyBtn.textContent = 'Verify';verifyBtn.disabled = false;}finally{isVerifying = false;}});}const digilockerVerifyBtn = widget.querySelector('#dpdpa-digilocker-verify-btn');if(digilockerVerifyBtn){const originalBtnText = digilockerVerifyBtn.textContent || 'Verify with DigiLocker';digilockerVerifyBtn.addEventListener('click',async()=>{const errorDiv = widget.querySelector('#dpdpa-digilocker-error');try{digilockerVerifyBtn.textContent = 'Verifying...';digilockerVerifyBtn.disabled = true;await initiateAgeVerification(window.location.href);}catch(e){console.error('[Consently DPDPA] DigiLocker verification error:',e);if(errorDiv){errorDiv.textContent = e.message || 'Verification failed. Pleasetry again.';errorDiv.style.display = 'block';}digilockerVerifyBtn.textContent = 'Retry Verification';digilockerVerifyBtn.disabled = false;}});if(checkExistingAgeVerification()){getTranslation(config && config.language ? config.language:'en').then(translations =>{updateDigiLockerUI(widget,translations);});}}const guardianSendBtn = widget.querySelector('#dpdpa-guardian-send-btn');if(guardianSendBtn){guardianSendBtn.addEventListener('click',async()=>{const emailInput = widget.querySelector('#dpdpa-guardian-email');const statusDiv = widget.querySelector('#dpdpa-guardian-status');const guardianEmail = emailInput ? emailInput.value.trim():'';if(!guardianEmail || !guardianEmail.includes('@')){if(statusDiv){statusDiv.textContent = 'Please enter a valid email address';statusDiv.style.color = '#dc2626';}return;}try{guardianSendBtn.textContent = 'Sending...';guardianSendBtn.disabled = true;await requestGuardianConsent(ageVerificationSessionId,guardianEmail);if(statusDiv){statusDiv.textContent = 'Consent request sent to guardian';statusDiv.style.color = '#059669';}guardianSendBtn.textContent = 'Waitingfor approval...';startGuardianConsentPolling(ageVerificationSessionId,(status)=>{getTranslation(config && config.language ? config.language:'en').then(translations =>{if(status.status === 'approved'){if(statusDiv){statusDiv.textContent = 'Guardian consent approved!';statusDiv.style.color = '#059669';}updateDigiLockerUI(widget,translations);}else if(status.status === 'rejected'){if(statusDiv){statusDiv.textContent = 'Guardian consent was denied';statusDiv.style.color = '#dc2626';}updateDigiLockerUI(widget,translations);}});});}catch(e){console.error('[Consently DPDPA] Guardian consent error:',e);if(statusDiv){statusDiv.textContent = e.message || 'Failed to send consent request';statusDiv.style.color = '#dc2626';}guardianSendBtn.textContent = 'Send Consent Request';guardianSendBtn.disabled = false;}});}const checkboxes = widget.querySelectorAll('.activity-checkbox');checkboxes.forEach(checkbox =>{checkbox.addEventListener('change',function(e){const activityId = this.getAttribute('data-activity-id');const item = this.closest('.dpdpa-activity-item');const checkboxVisual = this.parentElement.querySelector('.checkbox-visual');const checkmark = checkboxVisual?.querySelector('svg');const activity = activities.find(a => a.id === activityId);const activityName = activity?.activity_name || 'this activity';if(this.checked){setActivityConsent(activityId,'accepted');item.style.borderColor = primaryColor;item.style.borderWidth = '2px';item.style.background = '#f0f9ff';item.style.boxShadow = '0 4px 12px rgba(59,130,246,0.25)';item.style.borderLeftWidth = '4px';if(checkboxVisual){checkboxVisual.style.background = primaryColor;checkboxVisual.style.borderColor = primaryColor;}if(checkmark){checkmark.style.opacity = '1';checkmark.style.transform = 'scale(1)';}const warning = item.querySelector('.revocation-warning');if(warning)warning.remove();}else{const confirmed = confirm(`‚ö†Ô∏è Withdraw Consent?\n\n` + `You are about to withdraw your consentfor "${activityName}".\n\n` + `This may affect:\n` + `‚Ä¢ Your personalized experience on this website\n` + `‚Ä¢ Features that rely on this data processing\n` + `‚Ä¢ Services that require your consent to function\n\n` + `Under DPDPA 2023,you have the right to withdraw consent at any time.\n\n` + `Click OK to withdraw consent,or Cancel to keep it.`);if(!confirmed){e.preventDefault();this.checked = true;return;}setActivityConsent(activityId,'rejected');item.style.borderColor = '#e5e7eb';item.style.borderWidth = '1px';item.style.background = 'white';item.style.boxShadow = '0 1px 3px rgba(0,0,0,0.05)';item.style.borderLeftWidth = '2px';if(checkboxVisual){checkboxVisual.style.background = 'white';checkboxVisual.style.borderColor = '#d1d5db';}if(checkmark){checkmark.style.opacity = '0';checkmark.style.transform = 'scale(0.8)';}}});});const confirmBtn = widget.querySelector('#dpdpa-confirm-btn');if(confirmBtn){confirmBtn.addEventListener('click',async()=>{if(config.requireAgeVerification){const errorDiv = widget.querySelector('#dpdpa-digilocker-error');if(ageVerificationStatus !== 'verified'){if(errorDiv){if(ageVerificationStatus === 'requires_guardian'){errorDiv.textContent = t.guardianConsentMessage || 'Guardian consent is required to proceed.';}else{errorDiv.textContent = t.ageVerificationRequired || 'Please verify your age to continue.';}errorDiv.style.display = 'block';}const digiSection = widget.querySelector('#dpdpa-digilocker-section');if(digiSection){digiSection.scrollIntoView({behavior:'smooth',block:'center'});}return;}if(ageVerificationStatus === 'rejected'){if(overlay)overlay.remove();showMinorBlockScreen();return;}if(errorDiv)errorDiv.style.display = 'none';}if(!config.requireAgeVerification && config.enableAgeGate){const ageCheckbox = widget.querySelector('#dpdpa-age-checkbox');const ageYearSelect = widget.querySelector('#dpdpa-age-birthyear-integrated');const ageError = widget.querySelector('#age-gate-err-msg-main');if(ageCheckbox && !ageCheckbox.checked){if(ageError)ageError.style.display = 'block';return;}if(ageYearSelect){const ageYearValue = ageYearSelect.value;if(!ageYearValue){if(ageError){ageError.textContent = 'Please select your year of birth';ageError.style.display = 'block';}return;}const age = calculateAgeFromBirthYear(ageYearValue);if(age <(config.ageGateThreshold || 18)){setMinorCookie();if(overlay)overlay.remove();showMinorBlockScreen();return;}}if(ageError)ageError.style.display = 'none';}if(verifiedEmail){console.log('[Consently DPDPA] Email verified,saving preferences...');handleAcceptSelected(overlay);return;}const otpInput = widget.querySelector('#dpdpa-otp-input');const otp = otpInput ? otpInput.value.replace(/\s/g,''):null;const emailToVerify = userEmail || currentPrefilledEmail;if(otp && otp.length >= 4){if(isVerifying)return;isVerifying = true;const originalText = confirmBtn.textContent;confirmBtn.textContent = 'Verifying...';confirmBtn.disabled = true;try{const apiBase = getApiUrl();const response = await fetch(`${apiBase}/api/privacy-centre/verify-otp`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:emailToVerify,otpCode:otp,visitorId:consentID || getConsentID(),widgetId:widgetId,}),});if(response.ok){const data = await response.json();verifiedEmail = emailToVerify;if(data.stableConsentId && data.stableConsentId !== consentID){console.log('[Consently DPDPA] Switching to stable Consent ID:',data.stableConsentId);consentID = data.stableConsentId;storeConsentID(consentID);}const prefsContainer = widget.querySelector('#dpdpa-preferences-container');const notice = widget.querySelector('#dpdpa-verification-notice');if(prefsContainer)prefsContainer.style.display = 'block';if(notice)notice.style.display = 'none';confirmBtn.textContent = 'Save Preferences';confirmBtn.disabled = false;if(prefsContainer)prefsContainer.scrollIntoView({behavior:'smooth'});}else{alert('Invalid Verification Code');confirmBtn.textContent = originalText;confirmBtn.disabled = false;}}catch(e){console.error('Verification error',e);alert('Verification failed. Pleasetry again.');confirmBtn.textContent = originalText;confirmBtn.disabled = false;}finally{isVerifying = false;}}else{alert('Please verify your email to manage your consent preferences.');const emailInput = widget.querySelector('#dpdpa-email-input');if(emailInput){emailInput.focus();emailInput.style.borderColor = '#ef4444';setTimeout(()=>{emailInput.style.borderColor = '#cbd5e1';},2000);}}});confirmBtn.addEventListener('mouseenter',()=>{confirmBtn.style.transform = 'translateY(-2px)';confirmBtn.style.boxShadow = '0 6px 16px rgba(59,130,246,0.5)';});confirmBtn.addEventListener('mouseleave',()=>{confirmBtn.style.transform = 'translateY(0)';confirmBtn.style.boxShadow = '0 4px 12px rgba(59,130,246,0.3)';});if(config.enableAgeGate){const yearSelect = widget.querySelector('#dpdpa-age-birthyear-integrated');if(yearSelect){yearSelect.addEventListener('change',()=>{const age = calculateAgeFromBirthYear(yearSelect.value);if(age <(config.ageGateThreshold || 18)){setMinorCookie();if(overlay)overlay.remove();showMinorBlockScreen();}});}}}const grievanceLink = widget.querySelector('#dpdpa-grievance-link');if(grievanceLink){grievanceLink.addEventListener('click',(e)=>{e.preventDefault();openGrievanceForm();});}const dpbLink = widget.querySelector('#dpdpa-dpb-link');if(dpbLink){dpbLink.addEventListener('click',(e)=>{e.preventDefault();window.open('https://dataprotection.gov.in','_blank');});}const managePrefsBtn = widget.querySelector('#dpdpa-manage-preferences');if(managePrefsBtn){managePrefsBtn.addEventListener('mouseenter',()=>{managePrefsBtn.style.background = primaryColor;managePrefsBtn.style.color = 'white';managePrefsBtn.style.transform = 'translateY(-2px)';managePrefsBtn.style.boxShadow = '0 6px 12px rgba(59,130,246,0.4)';});managePrefsBtn.addEventListener('mouseleave',()=>{managePrefsBtn.style.background = 'white';managePrefsBtn.style.color = primaryColor;managePrefsBtn.style.transform = 'translateY(0)';managePrefsBtn.style.boxShadow = '0 2px 4px rgba(0,0,0,0.08)';});managePrefsBtn.addEventListener('click',()=>{openPrivacyCentre();});}const activityItems = widget.querySelectorAll('.dpdpa-activity-item');activityItems.forEach(item =>{item.addEventListener('mouseenter',()=>{item.style.borderColor = primaryColor;item.style.boxShadow = '0 4px 12px rgba(59,130,246,0.15)';item.style.transform = 'translateX(2px)';item.style.background = 'linear-gradient(to bottom,#f0f9ff,#e0f2fe)';});item.addEventListener('mouseleave',()=>{const checkbox = item.querySelector('.activity-checkbox');if(!checkbox.checked){item.style.borderColor = '#e5e7eb';item.style.boxShadow = '0 1px 3px rgba(0,0,0,0.05)';item.style.transform = 'translateX(0)';item.style.background = 'linear-gradient(to bottom,#ffffff,#fafbfc)';}});});}function setActivityConsent(activityId,status){activityConsents[activityId] ={status:status,timestamp:new Date().toISOString()};}function updateActivityUI(activityId,status){const activityItems = document.querySelectorAll('.dpdpa-activity-item');activityItems.forEach(item =>{const acceptBtn = item.querySelector(`[data-activity-id="${activityId}"].dpdpa-activity-accept`);const rejectBtn = item.querySelector(`[data-activity-id="${activityId}"].dpdpa-activity-reject`);if(acceptBtn && rejectBtn){if(status === 'accepted'){item.style.borderColor = '#10b981';acceptBtn.style.opacity = '1';rejectBtn.style.opacity = '0.5';}else if(status === 'rejected'){item.style.borderColor = '#ef4444';acceptBtn.style.opacity = '0.5';rejectBtn.style.opacity = '1';}}});}asyncfunction handleAcceptSelected(overlay){if(!activities || activities.length === 0){console.error('[Consently DPDPA] No activities available to consent to');alert('No activities available. Please contact the website administrator.');return;}const checkboxes = document.querySelectorAll('.activity-checkbox:checked');if(checkboxes.length === 0){alert('Please select at least one activity');return;}activities.forEach(activity =>{const checkbox = document.querySelector(`.activity-checkbox[data-activity-id="${activity.id}"]`);if(checkbox && checkbox.checked){setActivityConsent(activity.id,'accepted');}else{setActivityConsent(activity.id,'rejected');}});await saveConsent('partial',overlay);}asyncfunction handleAcceptAll(overlay){if(!activities || activities.length === 0){console.error('[Consently DPDPA] No activities available to consent to');alert('No activities available. Please contact the website administrator.');return;}const checkboxes = document.querySelectorAll('.activity-checkbox');checkboxes.forEach(cb =>{cb.checked = true;const item = cb.closest('.dpdpa-activity-item');if(item){item.style.borderColor = config.theme.primaryColor || '#3b82f6';item.style.background = `${config.theme.primaryColor || '#3b82f6'}08`;}});activities.forEach(activity =>{setActivityConsent(activity.id,'accepted');});await saveConsent('accepted',overlay);}asyncfunction saveConsent(overallStatus,overlay){if(!activities || activities.length === 0){console.error('[Consently DPDPA] Cannot save consent:No activities available');alert('Cannot save consent. No activities available. Please contact the website administrator.');return;}const acceptedActivities = [];const rejectedActivities = [];const acceptedPurposeConsents ={};const rejectedPurposeConsents ={};Object.keys(activityConsents).forEach(activityId =>{const activity = activities.find(a => a.id === activityId);if(activityConsents[activityId].status === 'accepted'){acceptedActivities.push(activityId);if(activity && activity.purposes && Array.isArray(activity.purposes)){acceptedPurposeConsents[activityId] = activity.purposes .map(p => p.purposeId || p.id).filter(id => id);}}else if(activityConsents[activityId].status === 'rejected'){rejectedActivities.push(activityId);if(activity && activity.purposes && Array.isArray(activity.purposes)){rejectedPurposeConsents[activityId] = activity.purposes .map(p => p.purposeId || p.id).filter(id => id);}}});let finalStatus;if(acceptedActivities.length > 0 && rejectedActivities.length > 0){finalStatus = 'partial';}else if(acceptedActivities.length > 0){finalStatus = 'accepted';}else if(rejectedActivities.length > 0){finalStatus = 'rejected';}else{console.error('[Consently DPDPA] No activities consented or rejected');alert('Please select at least one activity to save your preferences.');return;}const ruleContext = config._matchedRule ?{ruleId:config._matchedRule.id,ruleName:config._matchedRule.rule_name,urlPattern:config._matchedRule.url_pattern,pageUrl:window.location.pathname}:undefined;if(!consentID){consentID = getConsentID();}const consentData ={widgetId:widgetId,visitorId:consentID,consentStatus:finalStatus,acceptedActivities:acceptedActivities,ruleContext:ruleContext,rejectedActivities:rejectedActivities,activityConsents:activityConsents,visitorEmail:verifiedEmail || undefined,acceptedPurposeConsents:Object.keys(acceptedPurposeConsents).length > 0 ? acceptedPurposeConsents:undefined,rejectedPurposeConsents:Object.keys(rejectedPurposeConsents).length > 0 ? rejectedPurposeConsents:undefined,activityPurposeConsents:Object.keys(acceptedPurposeConsents).length > 0 ? acceptedPurposeConsents:undefined,metadata:{language:navigator.language || 'en',referrer:document.referrer || null,currentUrl:window.location.href,pageTitle:document.title},consentDuration:config.consentDuration || 365};try{const result = await recordConsent(consentData);storeConsentID(consentID);const storageData ={status:finalStatus,acceptedActivities:acceptedActivities,rejectedActivities:rejectedActivities,activityConsents:activityConsents,timestamp:new Date().toISOString(),expiresAt:result.expiresAt,verifiedEmail:verifiedEmail};ConsentStorage.set(`consently_dpdpa_consent_${widgetId}`,storageData,config.consentDuration || 365);applyConsent(storageData);trackConsentEvent(consentData,config._matchedRule || null);showFloatingPreferenceButton();hideWidget(overlay);showConsentSuccessModal(consentID);console.log('[Consently DPDPA] Consent saved successfully');}catch(error){console.error('[Consently DPDPA] Failed to save consent:',error);alert('Failed to save your consent preferences. Pleasetry again.');}}function showPremiumNotification(status,consentData){const existingToast = document.getElementById('dpdpa-premium-toast');if(existingToast){existingToast.remove();}const theme = config.theme ||{};const primaryColor = theme.primaryColor || '#3b82f6';const textColor = theme.textColor || '#1f2937';const toast = document.createElement('div');toast.id = 'dpdpa-premium-toast';toast.style.cssText = ` position:fixed;bottom:24px;right:24px;background:rgba(255,255,255,0.95);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);padding:16px 20px;border-radius:16px;box-shadow:0 4px 6px -1px rgba(0,0,0,0.05),0 10px 15px -3px rgba(0,0,0,0.05),0 0 0 1px rgba(0,0,0,0.05);z-index:2147483647;display:flex;align-items:center;gap:16px;transform:translateY(100px)scale(0.95);opacity:0;transition:all 0.5s cubic-bezier(0.16,1,0.3,1);font-family:${theme.fontFamily || 'system-ui,-apple-system,sans-serif'};max-width:380px;border:1px solid rgba(255,255,255,0.5);`;const iconHtml = ` <div style=" width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,${primaryColor},${primaryColor}dd);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px ${primaryColor}40;flex-shrink:0;"> <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"> <path d="M20 6L9 17l-5-5"></path> </svg> </div> `;const contentHtml = ` <div style="flex:1;"> <h4 style="margin:0 0 2px 0;font-size:14px;font-weight:700;color:${textColor};letter-spacing:-0.01em;">Preferences Saved</h4> <p style="margin:0;font-size:12px;color:#64748b;font-weight:500;">Your privacy choices are active.</p> </div> `;const buttonHtml = ` <button id="dpdpa-toast-download" style=" padding:8px 12px;background:#f1f5f9;color:#475569;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;white-space:nowrap;display:flex;align-items:center;gap:6px;"> <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"> <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path> <polyline points="7 10 12 15 17 10"></polyline> <line x1="12" y1="15" x2="12" y2="3"></line> </svg> Receipt </button> `;const closeHtml = ` <button id="dpdpa-toast-close" style=" padding:4px;background:transparent;border:none;color:#94a3b8;cursor:pointer;margin-left:4px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:background 0.2s;"> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <line x1="18" y1="6" x2="6" y2="18"></line> <line x1="6" y1="6" x2="18" y2="18"></line> </svg> </button> `;toast.innerHTML = iconHtml + contentHtml + buttonHtml + closeHtml;document.body.appendChild(toast);const downloadBtn = toast.querySelector('#dpdpa-toast-download');downloadBtn.addEventListener('mouseenter',()=>{downloadBtn.style.background = '#e2e8f0';downloadBtn.style.color = '#1e293b';});downloadBtn.addEventListener('mouseleave',()=>{downloadBtn.style.background = '#f1f5f9';downloadBtn.style.color = '#475569';});downloadBtn.addEventListener('click',()=>{downloadConsentReceipt(consentData);});const closeBtn = toast.querySelector('#dpdpa-toast-close');closeBtn.addEventListener('mouseenter',()=>{closeBtn.style.background = '#f1f5f9';closeBtn.style.color = '#64748b';});closeBtn.addEventListener('mouseleave',()=>{closeBtn.style.background = 'transparent';closeBtn.style.color = '#94a3b8';});closeBtn.addEventListener('click',()=>{hideToast();});requestAnimationFrame(()=>{toast.style.transform = 'translateY(0)scale(1)';toast.style.opacity = '1';});const timeoutId = setTimeout(()=>{hideToast();},5000);function hideToast(){clearTimeout(timeoutId);if(toast && document.body.contains(toast)){toast.style.transform = 'translateY(20px)scale(0.95)';toast.style.opacity = '0';setTimeout(()=>{if(document.body.contains(toast)){toast.remove();}},400);}}}function hideWidget(overlay){const widget = overlay.querySelector('#consently-dpdpa-widget');overlay.style.opacity = '0';if(widget){widget.style.transform = 'scale(0.9)';widget.style.opacity = '0';}if(globalClickHandler){document.removeEventListener('click',globalClickHandler);globalClickHandler = null;}setTimeout(()=>{if(document.body.contains(overlay)){document.body.removeChild(overlay);}},300);}function escapeHtml(text){const div = document.createElement('div');div.textContent = text;return div.innerHTML;}function downloadConsentReceipt(consent){const visitorId = consentID || getConsentID();const receiptData ={widgetId,visitorId,privacyCentreUrl:window.location.origin + '/privacy-centre/' + widgetId + '?visitorId=' + visitorId,...consent};const blob = new Blob([JSON.stringify(receiptData,null,2)],{type:'application/json'});const url = URL.createObjectURL(blob);const a = document.createElement('a');a.href = url;a.download = 'consent-receipt-' + visitorId + '.json';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);}function openPrivacyCentre(){const visitorId = consentID || getConsentID();window.open(window.location.origin + '/privacy-centre/' + widgetId + '?visitorId=' + visitorId,'_blank');}asyncfunction showCookieDetails(){try{const loadingOverlay = document.createElement('div');loadingOverlay.id = 'consently-cookie-details-loading';loadingOverlay.style.cssText = ` position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);z-index:999999;display:flex;align-items:center;justify-content:center;`;loadingOverlay.innerHTML = ` <div style="background:white;padding:40px;border-radius:16px;text-align:center;"> <div style="width:40px;height:40px;border:4px solid #f3f4f6;border-top-color:${primaryColor};border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px;"></div> <p style="margin:0;color:#6b7280;font-weight:500;">Loading cookie details...</p> </div> <style> @keyframes spin{to{transform:rotate(360deg);}}</style> `;document.body.appendChild(loadingOverlay);const apiUrl = getApiUrl();const response = await fetch(`${apiUrl}/api/cookies/domain-cookies?widgetId=${widgetId}`);const data = await response.json();loadingOverlay.remove();if(!data.success){throw new Error(data.error || 'Failed to load cookie data');}const cookieData = data.data;const modalOverlay = document.createElement('div');modalOverlay.id = 'consently-cookie-details-modal';modalOverlay.style.cssText = ` position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);z-index:999999;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.3s ease;`;modalOverlay.innerHTML = ` <div style="background:white;border-radius:12px;max-width:800px;width:95%;max-height:90vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.15);transform:scale(0.95);transition:all 0.3s cubic-bezier(0.4,0,0.2,1);"> <!-- Header --> <div style="padding:20px 24px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between;background:#fafbfc;"> <div> <h2 style="margin:0;font-size:18px;font-weight:600;color:#1a1a1a;">Cookie Preferences</h2> <p style="margin:4px 0 0 0;font-size:13px;color:#6b7280;"> ${cookieData.domain}‚Ä¢ ${cookieData.totalCookies}cookies ${cookieData.lastScanned ? `‚Ä¢ Scanned ${new Date(cookieData.lastScanned).toLocaleDateString()}`:''}</p> </div> <button id="close-cookie-modal" style="background:none;border:none;width:32px;height:32px;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s;color:#6b7280;"> <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"> <line x1="18" y1="6" x2="6" y2="18"></line> <line x1="6" y1="6" x2="18" y2="18"></line> </svg> </button> </div> <!-- Description --> <div style="padding:16px 24px;background:#f8f9fa;border-bottom:1px solid #e5e7eb;"> <p style="margin:0;font-size:13px;color:#4b5563;line-height:1.5;"> We use cookies to enhance your experience,analyze site traffic,and personalize content. You can choose which categories of cookies you allow. Learn more in our <a href="#" style="color:${primaryColor};text-decoration:none;">Privacy Policy</a>. </p> </div> <!-- Content --> <div style="padding:20px 24px;overflow-y:auto;max-height:calc(90vh - 200px);"> ${cookieData.totalCookies === 0 ? ` <div style="text-align:center;padding:60px 20px;color:#6b7280;"> <div style="font-size:48px;margin-bottom:16px;">üç™</div> <p style="margin:0;font-size:16px;font-weight:500;">No cookies scanned</p> <p style="margin:8px 0 0 0;font-size:14px;">Please run a cookie scan to see the details.</p> </div> `:` ${Object.entries(cookieData.categories).map(([category,cookies])=>{const categoryInfo ={necessary:{color:'#10b981',icon:'üîí',name:'Necessary Cookies',description:'Essentialfor the website tofunction properly',alwaysOn:true},functional:{color:'#3b82f6',icon:'‚öôÔ∏è',name:'Functional Cookies',description:'Enable enhanced functionality and personalization',alwaysOn:false},analytics:{color:'#f59e0b',icon:'üìä',name:'Analytics Cookies',description:'Help us understand how visitors interact with our site',alwaysOn:false},advertising:{color:'#ef4444',icon:'üì¢',name:'Advertising Cookies',description:'Used to deliver personalized advertisements',alwaysOn:false},social:{color:'#8b5cf6',icon:'üë•',name:'Functional Cookies',description:'Enable enhanced functionality and personalization',alwaysOn:false},preferences:{color:'#6b7280',icon:'‚ö°',name:'Preference Cookies',description:'Remember your settings and preferences',alwaysOn:false}};if(cookies.length === 0)return '';const info = categoryInfo[category] || categoryInfo.functional;const isExpanded = true;return ` <div style="margin-bottom:20px;border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;background:white;"> <!-- Category Header --> <div style="padding:16px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;background:${isExpanded ? info.color + '08':'white'};border-bottom:${isExpanded ? '1px solid #e5e7eb':'none'};"> <div style="display:flex;align-items:center;gap:12px;flex:1;"> <span style="font-size:24px;">${info.icon}</span> <div style="flex:1;"> <h3 style="margin:0;font-size:15px;font-weight:600;color:#1a1a1a;display:flex;align-items:center;gap:8px;"> ${info.name}${info.alwaysOn ? '<span style="font-size:11px;padding:2px 6px;background:#e5e7eb;color:#6b7280;border-radius:4px;font-weight:500;">Always Active</span>':''}</h3> <p style="margin:2px 0 0 0;font-size:12px;color:#6b7280;line-height:1.4;">${info.description}</p> </div> </div> <div style="display:flex;align-items:center;gap:12px;"> <span style="font-size:12px;color:#6b7280;font-weight:500;">${cookies.length}cookies</span> <label style="position:relative;display:inline-block;width:44px;height:24px;"> <input type="checkbox" ${info.alwaysOn || isExpanded ? 'checked':''}${info.alwaysOn ? 'disabled':''}style="opacity:0;width:0;height:0;"> <span style="position:absolute;cursor:${info.alwaysOn ? 'not-allowed':'pointer'};top:0;left:0;right:0;bottom:0;background-color:${info.alwaysOn || isExpanded ? info.color:'#ccc'};transition:.3s;border-radius:24px;"> <span style="position:absolute;content:'';height:18px;width:18px;left:3px;bottom:3px;background-color:white;transition:.3s;border-radius:50%;transform:translateX(${info.alwaysOn || isExpanded ? '20px':'0'});"></span> </span> </label> </div> </div> <!-- Cookie List --> ${isExpanded ? ` <div style="padding:16px;background:#fafbfc;"> ${cookies.map(cookie => ` <div style="padding:12px;background:white;border-radius:6px;margin-bottom:8px;border:1px solid #e5e7eb;font-size:12px;line-height:1.5;transition:all 0.2s;cursor:default;" onmouseover="this.style.borderColor='${info.color}30';this.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)'" onmouseout="this.style.borderColor='#e5e7eb';this.style.boxShadow='none'"> <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:6px;"> <div style="flex:1;"> <div style="font-weight:600;color:#1a1a1a;margin-bottom:2px;font-size:13px;">${cookie.name}</div> <div style="color:#6b7280;"> <span style="color:#9ca3af;">Host:</span> ${cookie.domain || cookie.host}${cookie.isThirdParty ? '<span style="margin-left:8px;padding:2px 6px;background:#fef3c7;color:#92400e;border-radius:4px;font-size:11px;font-weight:500;">Third-party</span>':''}</div> </div> <div style="color:#6b7280;text-align:right;font-size:11px;"> <span style="color:#9ca3af;">Expires:</span><br>${cookie.expiry || 'Session'}</div> </div> ${cookie.purpose ? ` <div style="color:#4b5563;margin-top:6px;"> <span style="color:#9ca3af;">Purpose:</span> ${cookie.purpose}</div> `:''}${cookie.provider ? ` <div style="color:#4b5563;margin-top:4px;"> <span style="color:#9ca3af;">Provider:</span> ${cookie.provider}</div> `:''}</div> `).join('')}</div> `:''}</div> `;}).join('')}`}<!-- Footer Actions --> <div style="margin-top:24px;padding:16px;background:#f8f9fa;border-radius:8px;display:flex;gap:12px;justify-content:flex-end;"> <button id="reject-all-cookies" style="padding:10px 20px;border:1px solid #d1d5db;background:white;color:#6b7280;border-radius:6px;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s;"> Reject All </button> <button id="accept-all-cookies" style="padding:10px 20px;border:none;background:${primaryColor};color:white;border-radius:6px;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s;box-shadow:0 1px 3px rgba(0,0,0,0.1);"> Accept All </button> <button id="save-cookie-preferences" style="padding:10px 20px;border:none;background:${primaryColor};color:white;border-radius:6px;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s;box-shadow:0 1px 3px rgba(0,0,0,0.1);"> Save Preferences </button> </div> </div> </div> `;document.body.appendChild(modalOverlay);requestAnimationFrame(()=>{modalOverlay.style.opacity = '1';modalOverlay.querySelector('div').style.transform = 'scale(1)';});const closeModal =()=>{modalOverlay.style.opacity = '0';modalOverlay.querySelector('div').style.transform = 'scale(0.95)';setTimeout(()=>{document.body.removeChild(modalOverlay);},300);};document.getElementById('close-cookie-modal').addEventListener('click',closeModal);modalOverlay.addEventListener('click',(e)=>{if(e.target === modalOverlay){closeModal();}});document.getElementById('accept-all-cookies')?.addEventListener('click',()=>{const toggles = modalOverlay.querySelectorAll('input[type="checkbox"]:not([disabled])');toggles.forEach(toggle =>{toggle.checked = true;updateToggleVisual(toggle,true);});});document.getElementById('reject-all-cookies')?.addEventListener('click',()=>{const toggles = modalOverlay.querySelectorAll('input[type="checkbox"]:not([disabled])');toggles.forEach(toggle =>{toggle.checked = false;updateToggleVisual(toggle,false);});});document.getElementById('save-cookie-preferences')?.addEventListener('click',async()=>{const preferences ={};const toggles = modalOverlay.querySelectorAll('input[type="checkbox"]');const categoryInfo ={necessary:'Necessary Cookies',functional:'Functional Cookies',analytics:'Analytics Cookies',advertising:'Advertising Cookies',social:'Functional Cookies',preferences:'Preference Cookies'};toggles.forEach(toggle =>{const categoryElement = toggle.closest('[style*="border"]');if(categoryElement){const categoryName = Object.keys(categoryInfo).find(key => categoryInfo[key] === categoryElement.querySelector('h3')?.textContent?.split('(')[0]);if(categoryName){preferences[categoryName] = toggle.checked;}}});ConsentStorage.set(`consently_cookie_preferences_${widgetId}`,preferences,365);const successMsg = document.createElement('div');successMsg.style.cssText = ` position:fixed;bottom:20px;right:20px;background:#10b981;color:white;padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:1000000;font-size:14px;font-weight:500;`;successMsg.textContent = 'Cookie preferences saved successfully';document.body.appendChild(successMsg);setTimeout(()=>{successMsg.remove();},3000);});function updateToggleVisual(toggle,isChecked){const span = toggle.nextElementSibling;if(span){span.style.backgroundColor = isChecked ? primaryColor:'#ccc';const innerSpan = span.querySelector('span');if(innerSpan){innerSpan.style.transform = `translateX(${isChecked ? '20px':'0'})`;}}}const toggles = modalOverlay.querySelectorAll('input[type="checkbox"]:not([disabled])');toggles.forEach(toggle =>{toggle.addEventListener('change',(e)=>{updateToggleVisual(e.target,e.target.checked);});});}catch(error){console.error('Error showing cookie details:',error);alert('Failed to load cookie details. Pleasetry again later.');}}function showFloatingPreferenceButton(){if(document.getElementById('dpdpa-floating-btn'))return;const btn = document.createElement('button');btn.id = 'dpdpa-floating-btn';btn.title = 'Manage Privacy Preferences';btn.style.cssText = 'position:fixed;' + 'bottom:20px;' + 'left:20px;' + 'width:50px;' + 'height:50px;' + 'border-radius:50%;' + 'background:white;' + 'border:none;' + 'box-shadow:0 4px 12px rgba(0,0,0,0.15);' + 'cursor:pointer;' + 'z-index:999997;' + 'display:flex;' + 'align-items:center;' + 'justify-content:center;' + 'transition:all 0.3s cubic-bezier(0.4,0,0.2,1);';btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="' + primaryColor + '" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">' + '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>' + '</svg>';btn.addEventListener('click',()=>{showConsentWidget();});btn.addEventListener('mouseenter',()=>{btn.style.transform = 'scale(1.1)';btn.style.boxShadow = '0 6px 16px rgba(0,0,0,0.2)';});btn.addEventListener('mouseleave',()=>{btn.style.transform = 'scale(1)';btn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';});document.body.appendChild(btn);}function addDPDPAToCookieMenu(){}function openGrievanceForm(){const visitorId = consentID || getConsentID();const grievanceUrl = window.location.origin + '/privacy-centre/' + widgetId + '/grievance?visitorId=' + visitorId;window.open(grievanceUrl,'_blank');}window.ConsentlyDPDPA ={init:init,show:showConsentWidget,hide:()=>{const overlay = document.getElementById('consently-dpdpa-overlay');if(overlay)hideWidget(overlay);},getConsent:()=> ConsentStorage.get('consently_dpdpa_consent_' + widgetId),openPrivacyCentre:openPrivacyCentre,downloadReceipt:()=>{const consent = ConsentStorage.get('consently_dpdpa_consent_' + widgetId);if(consent)downloadConsentReceipt(consent);},downloadPrivacyNotice:()=>{if(window.downloadPrivacyNotice){window.downloadPrivacyNotice();}}};if(document.readyState === 'loading'){document.addEventListener('DOMContentLoaded',init);}else{init();}})();