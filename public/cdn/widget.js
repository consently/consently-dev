(function(){'use strict';const currentScript = document.currentScript || document.querySelector('script[data-consently-id]');const bannerId = currentScript ? currentScript.getAttribute('data-consently-id'):null;if(!bannerId){console.error('[Consently] Error:data-consently-id attribute is required');console.error('[Consently] Usage:<script src="https://your-domain.com/widget.js" data-consently-id="YOUR_BANNER_ID"></script>');return;}console.log('[Consently] Initializing widget with banner ID:',bannerId);const defaultConfig ={position:'bottom',layout:'bar',theme:{primaryColor:'#3b82f6',secondaryColor:'#1e40af',backgroundColor:'#ffffff',textColor:'#1f2937',fontFamily:'system-ui,sans-serif',fontSize:14,borderRadius:8,boxShadow:true},title:'We value your privacy',message:'We use cookies to enhance your browsing experience.',acceptButton:{text:'Accept All',backgroundColor:'#3b82f6',textColor:'#ffffff'},rejectButton:{text:'Reject All',backgroundColor:'#ffffff',textColor:'#3b82f6',borderColor:'#3b82f6'},settingsButton:{text:'Cookie Settings',backgroundColor:'#f3f4f6',textColor:'#1f2937'},showRejectButton:true,showSettingsButton:true,autoShow:true,showAfterDelay:0,respectDNT:false,blockContent:false,zIndex:9999};let config = Object.assign({},defaultConfig);let configLoaded = false;const CookieManager ={set:function(name,value,days){const expires = new Date();expires.setTime(expires.getTime()+(days * 24 * 60 * 60 * 1000));document.cookie = name + '=' + encodeURIComponent(JSON.stringify(value))+ ';expires=' + expires.toUTCString()+ ';path=/;SameSite=Lax';},get:function(name){const nameEQ = name + '=';const ca = document.cookie.split(';');for(let i = 0;i < ca.length;i++){let c = ca[i];while(c.charAt(0)=== ' ')c = c.substring(1,c.length);if(c.indexOf(nameEQ)=== 0){try{return JSON.parse(decodeURIComponent(c.substring(nameEQ.length,c.length)));}catch(e){return null;}}}return null;},delete:function(name){document.cookie = name + '=;expires=Thu,01 Jan 1970 00:00:01 GMT;path=/';}};asyncfunction fetchBannerConfig(){try{const scriptSrc = currentScript.src;let apiBase;if(scriptSrc && scriptSrc.includes('http')){const url = new URL(scriptSrc);apiBase = url.origin;}else{apiBase = window.location.origin;}const apiUrl = `${apiBase}/api/cookies/widget-public/${bannerId}`;console.log('[Consently] Fetching configuration from:',apiUrl);const response = await fetch(apiUrl,{method:'GET',headers:{'Content-Type':'application/json'},cache:'default'});if(!response.ok){throw new Error(`HTTP ${response.status}:${response.statusText}`);}const data = await response.json();if(data &&(data.id || data.config)){config = Object.assign({},defaultConfig,data);config.widgetId = bannerId;config.apiEndpoint = '/api/consent/record';config.apiBase = apiBase;configLoaded = true;console.log('[Consently] Configuration loaded successfully:',config.name || 'Unnamed Banner');return true;}else{throw new Error('Invalid configuration response');}}catch(error){console.error('[Consently] Failed to load configuration:',error);console.log('[Consently] Using default configuration');config.widgetId = bannerId;config.apiEndpoint = '/api/consent/record';config.apiBase = window.location.origin;return false;}}asyncfunction init(){await fetchBannerConfig();const existingConsent = CookieManager.get('consently_consent');if(config.respectDNT && navigator.doNotTrack === '1'){console.log('[Consently] DNT enabled,respecting user preference');return;}if(existingConsent && existingConsent.timestamp){const consentAge =(Date.now()- existingConsent.timestamp)/(1000 * 60 * 60 * 24);const consentDuration = 365;if(consentAge < consentDuration){console.log('[Consently] Valid consent found');applyConsent(existingConsent);return;}}if(config.autoShow){if(config.showAfterDelay > 0){setTimeout(showConsentBanner,config.showAfterDelay);}else{showConsentBanner();}}}function showConsentBanner(){if(document.getElementById('consently-banner')){return;}const theme = config.theme ||{};const primaryColor = theme.primaryColor || '#3b82f6';const backgroundColor = theme.backgroundColor || '#ffffff';const textColor = theme.textColor || '#1f2937';const fontFamily = theme.fontFamily || 'system-ui,sans-serif';const fontSize = theme.fontSize || 14;const borderRadius = theme.borderRadius || 8;const zIndex = config.zIndex || 9999;const banner = document.createElement('div');banner.id = 'consently-banner';banner.style.cssText = ` position:fixed;${config.position === 'top' ? 'top:0;':'bottom:0;'}left:0;right:0;background-color:${backgroundColor};color:${textColor};padding:24px;box-shadow:0 -4px 12px rgba(0,0,0,0.15);z-index:${zIndex};font-family:${fontFamily};font-size:${fontSize}px;line-height:1.5;animation:slideUp 0.3s ease-out;`;banner.innerHTML = ` <style> @keyframes slideUp{from{transform:translateY(100%);opacity:0;}to{transform:translateY(0);opacity:1;}}#consently-banner *{box-sizing:border-box;}.consently-btn{padding:10px 20px;border-radius:6px;font-weight:500;cursor:pointer;border:none;font-size:14px;transition:all 0.2s;margin:0 8px 8px 0;}.consently-btn:hover{opacity:0.9;transform:translateY(-1px);}.consently-btn-primary{background-color:${primaryColor};color:white;}.consently-btn-secondary{background-color:transparent;color:${primaryColor};border:2px solid ${primaryColor};}.consently-btn-text{background-color:transparent;color:${textColor};text-decoration:underline;}.consently-container{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:24px;flex-wrap:wrap;}.consently-content{flex:1;min-width:300px;}.consently-actions{display:flex;flex-wrap:wrap;align-items:center;gap:8px;}.consently-title{font-size:18px;font-weight:600;margin:0 0 8px 0;}.consently-message{margin:0;opacity:0.9;}@media(max-width:768px){.consently-container{flex-direction:column;align-items:flex-start;}.consently-actions{width:100%;}.consently-btn{flex:1;}}</style> <div class="consently-container"> <div class="consently-content"> <h3 class="consently-title">${config.title}</h3> <p class="consently-message">${config.message}</p> </div> <div class="consently-actions"> <button id="consently-accept" class="consently-btn consently-btn-primary"> ${config.acceptButton?.text || 'Accept All'}</button> ${config.showRejectButton ? ` <button id="consently-reject" class="consently-btn consently-btn-secondary"> ${config.rejectButton?.text || 'Reject All'}</button> `:''}${config.showSettingsButton ? ` <button id="consently-settings" class="consently-btn consently-btn-text"> ${config.settingsButton?.text || 'Cookie Settings'}</button> `:''}</div> </div> `;document.body.appendChild(banner);const acceptBtn = document.getElementById('consently-accept');if(acceptBtn){acceptBtn.addEventListener('click',function(){handleConsent('accepted',['necessary','analytics','marketing','preferences']);});}const rejectBtn = document.getElementById('consently-reject');if(rejectBtn){rejectBtn.addEventListener('click',function(){handleConsent('rejected',['necessary']);});}const settingsBtn = document.getElementById('consently-settings');if(settingsBtn){settingsBtn.addEventListener('click',function(){showSettingsModal();});}}function showSettingsModal(){const existing = document.getElementById('consently-modal');if(existing){existing.remove();}const modal = document.createElement('div');modal.id = 'consently-modal';modal.style.cssText = ` position:fixed;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,0.5);z-index:9999999;display:flex;align-items:center;justify-content:center;padding:20px;animation:fadeIn 0.2s ease-out;`;const categories = [{id:'necessary',name:'Necessary',description:'Essentialfor website functionality',required:true},{id:'analytics',name:'Analytics',description:'Help us understand visitor behavior',required:false},{id:'marketing',name:'Marketing',description:'Usedfor targeted advertising',required:false},{id:'preferences',name:'Preferences',description:'Remember your settings',required:false}];let categoriesHTML = '';const availableCategories = config.categories || ['necessary','analytics','marketing','preferences'];categories.forEach(cat =>{if(availableCategories.includes(cat.id)|| cat.required){categoriesHTML += ` <div style="padding:16px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:12px;"> <label style="display:flex;align-items:start;gap:12px;cursor:${cat.required ? 'not-allowed':'pointer'};"> <input type="checkbox" id="cat-${cat.id}" ${cat.required ? 'checked disabled':''}style="margin-top:4px;width:18px;height:18px;"> <div style="flex:1;"> <div style="font-weight:600;margin-bottom:4px;"> ${cat.name}${cat.required ? '<span style="color:#3b82f6;font-size:12px;">(Required)</span>':''}</div> <div style="font-size:13px;color:#6b7280;">${cat.description}</div> </div> </label> </div> `;}});modal.innerHTML = ` <style> @keyframes fadeIn{from{opacity:0;}to{opacity:1;}}</style> <div style="background-color:white;border-radius:12px;max-width:500px;width:100%;max-height:80vh;overflow-y:auto;padding:24px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;"> <h2 style="margin:0 0 16px 0;font-size:24px;color:#1f2937;">Cookie Settings</h2> <p style="margin:0 0 24px 0;color:#6b7280;font-size:14px;"> Manage your cookie preferences. Some cookies are necessaryfor the website to function. </p> ${categoriesHTML}<div style="display:flex;gap:12px;margin-top:24px;flex-wrap:wrap;"> <button id="consently-save-settings" class="consently-btn consently-btn-primary" style="flex:1;"> Save Preferences </button> <button id="consently-close-modal" class="consently-btn consently-btn-secondary" style="flex:1;"> Cancel </button> </div> </div> `;document.body.appendChild(modal);document.getElementById('consently-save-settings').addEventListener('click',function(){const selectedCategories = ['necessary'];categories.forEach(cat =>{if(!cat.required){const checkbox = document.getElementById('cat-' + cat.id);if(checkbox && checkbox.checked){selectedCategories.push(cat.id);}}});modal.remove();handleConsent('partial',selectedCategories);});document.getElementById('consently-close-modal').addEventListener('click',function(){modal.remove();});modal.addEventListener('click',function(e){if(e.target === modal){modal.remove();}});}function handleConsent(status,categories){const consentData ={status:status,categories:categories,timestamp:Date.now(),widgetId:bannerId,domain:window.location.hostname};const consentDuration = config.consentDuration || 365;CookieManager.set('consently_consent',consentData,consentDuration);sendConsentToServer(consentData);applyConsent(consentData);const banner = document.getElementById('consently-banner');if(banner){banner.style.animation = 'slideUp 0.3s ease-out reverse';setTimeout(()=> banner.remove(),300);}window.dispatchEvent(new CustomEvent('consentlyConsent',{detail:consentData}));console.log('[Consently] Consent recorded:',status,categories);}function sendConsentToServer(consentData){const apiBase = config.apiBase || window.location.origin;const apiEndpoint = config.apiEndpoint || '/api/consent/record';const apiUrl = apiBase + apiEndpoint;const data ={consentId:'cns_' + Date.now()+ '_' + Math.random().toString(36).substr(2,9),widgetId:bannerId,status:consentData.status,categories:consentData.categories,deviceType:/Mobile|Android|iPhone|iPad|Tablet/i.test(navigator.userAgent)?(/Tablet|iPad/i.test(navigator.userAgent)? 'Tablet':'Mobile'):'Desktop',userAgent:navigator.userAgent,language:navigator.language || 'en'};console.log('[Consently] Sending consent to:',apiUrl);if(navigator.sendBeacon){const blob = new Blob([JSON.stringify(data)],{type:'application/json'});const sent = navigator.sendBeacon(apiUrl,blob);console.log('[Consently] Consent sent via beacon:',sent);}else{fetch(apiUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data),keepalive:true}).then(function(response){if(response.ok){console.log('[Consently] Consent recorded successfully');}else{console.error('[Consently] Server returned error:',response.status);}return response.json();}).then(function(result){console.log('[Consently] Server response:',result);}).catch(function(err){console.error('[Consently] Failed to record consent:',err);});}}function applyConsent(consentData){console.log('[Consently] Applying consent:',consentData);const blockScripts = config.blockScripts !== undefined ? config.blockScripts:false;if(blockScripts){if(consentData.categories.includes('analytics')&& window.gtag){window.gtag('consent','update',{'analytics_storage':'granted'});}if(consentData.categories.includes('marketing')&& window.gtag){window.gtag('consent','update',{'ad_storage':'granted','ad_user_data':'granted','ad_personalization':'granted'});}}try{localStorage.setItem('consently_consent',JSON.stringify(consentData));}catch(e){console.warn('[Consently] localStorage not available');}}window.Consently ={showBanner:showConsentBanner,getConsent:function(){return CookieManager.get('consently_consent');},revokeConsent:function(){CookieManager.delete('consently_consent');try{localStorage.removeItem('consently_consent');}catch(e){}showConsentBanner();},updateConsent:function(categories){handleConsent('partial',categories);}};if(document.readyState === 'loading'){document.addEventListener('DOMContentLoaded',init);}else{init();}})();